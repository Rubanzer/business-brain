<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Brain</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --border: #1e1e2e;
      --text: #e2e2e8;
      --muted: #8888a0;
      --accent: #6c5ce7;
      --accent-hover: #7c6cf7;
      --green: #00cec9;
      --red: #ff6b6b;
      --yellow: #feca57;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    header {
      text-align: center;
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 1.6rem;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    header h1 span { color: var(--accent); }

    header p {
      color: var(--muted);
      font-size: 0.8rem;
      margin-top: 0.4rem;
    }

    .tabs {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      flex-wrap: nowrap;
    }

    .tab {
      padding: 0.6rem 1rem;
      background: none;
      border: none;
      color: var(--muted);
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* "More" dropdown for overflow tabs */
    .tab-more-wrap {
      position: relative;
      margin-left: auto;
    }
    .tab-more-btn {
      padding: 0.6rem 1rem;
      background: none;
      border: none;
      color: var(--muted);
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .tab-more-btn:hover { color: var(--text); }
    .tab-more-btn.has-active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-more-menu {
      display: none;
      position: absolute;
      right: 0;
      top: calc(100% + 1px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 160px;
      padding: 0.4rem 0;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .tab-more-menu.open { display: block; }
    .tab-more-menu .tab-menu-item {
      display: block;
      width: 100%;
      padding: 0.5rem 1rem;
      background: none;
      border: none;
      color: var(--muted);
      font-family: inherit;
      font-size: 0.78rem;
      cursor: pointer;
      text-align: left;
      transition: background 0.15s, color 0.15s;
    }
    .tab-more-menu .tab-menu-item:hover { background: var(--border); color: var(--text); }
    .tab-more-menu .tab-menu-item.active { color: var(--accent); }

    .panel { display: none; }
    .panel.active { display: block; }

    /* Sub-navigation pills within panels */
    .sub-nav {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .sub-nav-pill {
      padding: 0.3rem 0.8rem;
      font-size: 0.75rem;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .sub-nav-pill:hover {
      color: var(--text);
      border-color: var(--accent);
    }
    .sub-nav-pill.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .sub-panel { display: none; }
    .sub-panel.active { display: block; }

    /* Context entries list */
    .ctx-entry {
      padding: 0.6rem 0.8rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
      line-height: 1.4;
      position: relative;
    }
    .ctx-entry .ctx-source {
      font-size: 0.65rem;
      color: var(--accent);
      margin-bottom: 0.2rem;
      font-weight: 500;
    }
    .ctx-entry .ctx-actions {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      display: flex;
      gap: 0.3rem;
    }
    .ctx-entry .ctx-actions button {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--muted);
      cursor: pointer;
    }
    .ctx-entry .ctx-actions button:hover {
      color: var(--accent);
      border-color: var(--accent);
    }

    /* Process map table */
    .process-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.72rem;
      margin-bottom: 0.5rem;
    }
    .process-table th {
      background: var(--border);
      padding: 0.4rem 0.6rem;
      text-align: left;
      font-weight: 500;
      font-size: 0.68rem;
    }
    .process-table td {
      padding: 0.4rem 0.6rem;
      border-bottom: 1px solid var(--border);
    }
    .process-table tr:hover {
      background: rgba(99, 102, 241, 0.05);
    }

    /* Metric threshold cards */
    .metric-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.7rem;
      font-size: 0.72rem;
    }
    .metric-card h4 {
      margin: 0 0 0.3rem;
      font-size: 0.8rem;
      color: var(--text);
    }
    .metric-card .mc-range {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
      margin-bottom: 0.3rem;
    }
    .metric-card .mc-range span {
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 0.65rem;
    }
    .mc-good { background: rgba(16,185,129,0.15); color: #059669; }
    .mc-warn { background: rgba(245,158,11,0.15); color: #d97706; }
    .mc-crit { background: rgba(239,68,68,0.15); color: #dc2626; }
    .metric-card .mc-meta {
      font-size: 0.62rem;
      color: var(--muted);
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    input[type="text"], textarea {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: inherit;
      font-size: 0.85rem;
      padding: 0.7rem 1rem;
      border-radius: 6px;
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus, textarea:focus {
      border-color: var(--accent);
    }

    textarea { min-height: 80px; resize: vertical; }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      font-family: inherit;
      font-size: 0.8rem;
      padding: 0.7rem 1.4rem;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s;
    }

    button:hover { background: var(--accent-hover); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-sm {
      padding: 0.3rem 0.8rem;
      font-size: 0.7rem;
    }

    .btn-secondary {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-secondary:hover { background: var(--border); }

    .result {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .result-header {
      padding: 0.7rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .result-body {
      padding: 1rem;
      font-size: 0.8rem;
      line-height: 1.6;
      max-height: none;
      overflow-y: auto;
    }

    .result-body:empty::after {
      content: "Results will appear here...";
      color: var(--muted);
      font-style: italic;
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-green { background: rgba(0,206,201,0.15); color: var(--green); }
    .badge-red { background: rgba(255,107,107,0.15); color: var(--red); }
    .badge-yellow { background: rgba(254,202,87,0.15); color: var(--yellow); }
    .badge-accent { background: rgba(108,92,231,0.15); color: var(--accent); }
    .badge-blue { background: rgba(100,149,237,0.15); color: cornflowerblue; }

    .step {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .step:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

    .step-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.4rem;
    }

    .step h3 {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.3rem;
    }

    .step p, .step li {
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .step ul { padding-left: 1.2rem; margin-top: 0.3rem; }

    .sql-block {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.6rem 0.8rem;
      margin: 0.5rem 0;
      font-size: 0.75rem;
      overflow-x: auto;
      white-space: pre-wrap;
      color: var(--green);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin: 0.5rem 0;
    }

    .data-table th {
      text-align: left;
      padding: 0.4rem 0.6rem;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }

    .data-table th:hover { color: var(--accent); }

    .data-table td {
      padding: 0.4rem 0.6rem;
      border-bottom: 1px solid var(--border);
    }

    .data-table td.editable:hover {
      outline: 1px solid var(--accent);
      cursor: pointer;
    }

    .data-table td.editing {
      padding: 0;
    }

    .data-table td.editing input {
      width: 100%;
      background: var(--bg);
      border: 2px solid var(--accent);
      color: var(--text);
      font-family: inherit;
      font-size: 0.75rem;
      padding: 0.4rem 0.6rem;
      outline: none;
    }

    .data-table td.edited {
      background: rgba(108,92,231,0.1);
    }

    .finding {
      display: flex;
      gap: 0.5rem;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .meta-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }

    .meta-card h3 {
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }

    .meta-card p {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    .col-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .col-chip {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .col-chip strong { color: var(--text); font-weight: 500; }

    .context-form { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem; }
    .context-row { display: flex; gap: 0.5rem; }

    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 2.5rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 1.5rem;
      color: var(--muted);
      font-size: 0.8rem;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(108,92,231,0.05);
      color: var(--text);
    }
    .drop-zone input[type="file"] { display: none; }
    .drop-zone .drop-icon { font-size: 1.8rem; margin-bottom: 0.5rem; display: block; }
    .drop-zone .drop-hint { font-size: 0.7rem; color: var(--muted); margin-top: 0.3rem; }

    .report-section { margin-bottom: 1rem; }
    .report-section h4 {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.4rem;
    }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .stat-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.6rem 0.8rem;
      text-align: center;
    }
    .stat-card .stat-value { font-size: 1.2rem; font-weight: 600; color: var(--accent); }
    .stat-card .stat-label { font-size: 0.65rem; color: var(--muted); margin-top: 0.1rem; }
    .stat-card .stat-unit { font-size: 0.6rem; color: var(--muted); }

    /* Hero stat cards (CFO key metrics) */
    .stat-card-hero {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      text-align: center;
    }
    .stat-card-hero .stat-value { font-size: 1.4rem; font-weight: 700; }
    .stat-card-hero .stat-label { font-size: 0.7rem; color: var(--muted); margin-top: 0.15rem; }
    .stat-card-hero .stat-unit { font-size: 0.65rem; color: var(--muted); }

    .stat-good { border-color: var(--green); }
    .stat-good .stat-value { color: var(--green); }
    .stat-warning { border-color: var(--yellow); }
    .stat-warning .stat-value { color: var(--yellow); }
    .stat-critical { border-color: var(--red); }
    .stat-critical .stat-value { color: var(--red); }

    /* CFO verdict card */
    .cfo-verdict {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
    }
    .cfo-approved {
      background: rgba(0,206,201,0.08);
      border-color: var(--green);
    }
    .cfo-rejected {
      background: rgba(255,107,107,0.08);
      border-color: var(--red);
    }
    .cfo-verdict h3 {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }
    .cfo-verdict p {
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.5;
    }

    /* Recommendation cards */
    .recommendation-card {
      display: flex;
      gap: 0.6rem;
      align-items: flex-start;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.4rem;
      font-size: 0.8rem;
      color: var(--text);
      line-height: 1.5;
    }
    .rec-number {
      background: var(--accent);
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 1px;
    }

    /* Finding cards â€” clickable for drill-down */
    .finding-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.4rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .finding-card:hover {
      border-color: var(--accent);
      background: rgba(108,92,231,0.05);
    }
    .finding-card .finding-desc {
      font-size: 0.8rem;
      color: var(--text);
      line-height: 1.5;
    }
    .finding-card .drill-hint {
      font-size: 0.65rem;
      color: var(--accent);
      margin-top: 0.25rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .finding-card:hover .drill-hint { opacity: 1; }
    .finding-impact {
      font-size: 0.72rem;
      color: var(--muted);
      margin-top: 0.2rem;
      font-style: italic;
    }

    /* Insight summary */
    .insight-summary {
      border-left: 3px solid var(--accent);
      padding: 0.6rem 0.8rem;
      background: rgba(108,92,231,0.05);
      border-radius: 0 6px 6px 0;
      margin-bottom: 0.75rem;
      font-size: 0.82rem;
      line-height: 1.5;
      color: var(--text);
    }

    /* Details/accordion */
    .details-section {
      margin-top: 0.5rem;
    }
    .details-toggle {
      cursor: pointer;
      font-size: 0.72rem;
      color: var(--muted);
      padding: 0.4rem 0;
      user-select: none;
    }
    .details-toggle:hover { color: var(--accent); }

    /* Chart */
    .chart-insight {
      font-size: 0.72rem;
      font-style: italic;
      color: var(--muted);
      margin-top: 0.3rem;
      padding: 0 0.5rem;
    }

    .chart-container {
      margin: 0.75rem 0;
      padding: 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      position: relative;
      max-width: 100%;
      min-height: 300px;
    }

    .chart-container canvas {
      max-height: 400px;
    }

    /* Drill-down breadcrumb & navigation */
    .drill-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
      font-size: 0.75rem;
    }
    .drill-breadcrumb .crumb {
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .drill-breadcrumb .crumb:hover { color: var(--accent-hover); }
    .drill-breadcrumb .crumb-sep { color: var(--muted); }
    .drill-breadcrumb .crumb-current {
      color: var(--text);
      font-weight: 500;
    }
    .drill-back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.7rem;
      font-size: 0.72rem;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 0.5rem;
    }
    .drill-back-btn:hover { border-color: var(--accent); color: var(--text); }

    /* Clickable hero stat cards */
    .stat-card-hero {
      cursor: pointer;
      transition: border-color 0.2s, transform 0.15s;
    }
    .stat-card-hero:hover { transform: translateY(-2px); }

    /* Clickable computation stat cards */
    .stat-card.clickable {
      cursor: pointer;
      transition: border-color 0.2s, transform 0.15s;
    }
    .stat-card.clickable:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    /* Drill-down loading overlay on a card */
    .finding-card.drilling, .stat-card-hero.drilling, .stat-card.drilling {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }

    .issue-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin: 0.5rem 0;
    }
    .issue-table th {
      text-align: left;
      padding: 0.4rem 0.6rem;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-weight: 500;
    }
    .issue-table td { padding: 0.4rem 0.6rem; border-bottom: 1px solid var(--border); }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--surface);
      border: 1px solid var(--green);
      color: var(--green);
      padding: 0.7rem 1.2rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show { transform: translateY(0); opacity: 1; }

    /* Chat history thread */
    .chat-thread {
      margin-bottom: 1rem;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .chat-msg {
      padding: 0.5rem 0.7rem;
      margin-bottom: 0.4rem;
      border-radius: 6px;
      font-size: 0.78rem;
    }

    .chat-msg.user {
      background: rgba(108,92,231,0.1);
      border-left: 3px solid var(--accent);
    }

    .chat-msg.assistant {
      background: rgba(0,206,201,0.05);
      border-left: 3px solid var(--green);
      color: var(--muted);
    }

    .chat-msg .chat-role {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      margin-bottom: 0.2rem;
    }

    .new-chat-btn {
      font-size: 0.7rem;
      padding: 0.3rem 0.7rem;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .new-chat-btn:hover { color: var(--text); border-color: var(--accent); }

    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .pagination button {
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90vw;
      max-width: 1000px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 1.2rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h3 { font-size: 0.85rem; }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.2rem 0.5rem;
    }

    .modal-close:hover { color: var(--text); }

    .chart-builder {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      margin: 0.5rem 0;
      font-size: 0.75rem;
    }

    .chart-builder select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: inherit;
      font-size: 0.75rem;
      padding: 0.3rem 0.5rem;
      border-radius: 4px;
      outline: none;
    }

    /* Context file upload zone */
    .ctx-file-zone {
      border: 1px dashed var(--border);
      border-radius: 6px;
      padding: 0.8rem;
      text-align: center;
      cursor: pointer;
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
      transition: all 0.2s;
    }
    .ctx-file-zone:hover { border-color: var(--accent); color: var(--text); }
    .ctx-file-zone input { display: none; }

    /* Feed discovery status bar */
    .discovery-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.75rem;
      color: var(--muted);
    }
    .discovery-bar .disc-stats { display: flex; gap: 1rem; }

    /* Feed insight cards */
    .feed-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.6rem;
      transition: border-color 0.2s;
    }
    .feed-card:hover { border-color: var(--accent); }
    .feed-card.severity-critical { border-left: 3px solid var(--red); }
    .feed-card.severity-warning { border-left: 3px solid var(--yellow); }
    .feed-card.severity-info { border-left: 3px solid var(--green); }
    .feed-card.type-story { border-left: 3px solid var(--accent); }
    .feed-card-title {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.3rem;
    }
    .feed-card-desc {
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 0.4rem;
    }
    .feed-card-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.4rem;
    }
    .feed-card-actions {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    .table-chip {
      display: inline-block;
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      font-size: 0.65rem;
      color: var(--muted);
    }
    .feed-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted);
      font-size: 0.85rem;
    }

    /* Report cards */
    .report-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.6rem;
    }
    .report-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.3rem;
    }
    .report-card-title {
      font-size: 0.85rem;
      font-weight: 500;
    }
    .report-card-meta {
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 0.4rem;
    }
    .report-card-actions {
      display: flex;
      gap: 0.4rem;
    }

    /* Suggestion pills */
    .suggestion-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
    }
    .suggestion-pill {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: inherit;
      font-size: 0.72rem;
      padding: 0.35rem 0.7rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .suggestion-pill:hover {
      border-color: var(--accent);
      color: var(--text);
      background: rgba(108,92,231,0.08);
    }

    /* Export buttons */
    .export-bar {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }
    .btn-export {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 0.35rem 0.8rem;
      font-size: 0.7rem;
    }
    .btn-export:hover { border-color: var(--accent); color: var(--text); }

    /* Deploy modal */
    .deploy-modal-content {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .deploy-modal-content label {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .deploy-modal-content input {
      width: 100%;
    }

    /* Report view in modal */
    .report-view-section {
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    .report-view-section:last-child { border-bottom: none; }
    .report-view-section h4 {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 0.4rem;
    }

    /* v3: Source cards */
    .source-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .source-card-info { flex: 1; }
    .source-card-name { font-size: 0.85rem; font-weight: 500; margin-bottom: 0.2rem; }
    .source-card-meta { font-size: 0.7rem; color: var(--muted); }
    .source-card-actions { display: flex; gap: 0.3rem; }
    .source-type-badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .source-type-badge.sheet { background: rgba(0,206,201,0.15); color: var(--green); }
    .source-type-badge.api { background: rgba(108,92,231,0.15); color: var(--accent); }
    .source-type-badge.upload { background: rgba(254,202,87,0.15); color: var(--yellow); }
    .sync-status { font-size: 0.65rem; margin-left: 0.5rem; }
    .sync-status.success { color: var(--green); }
    .sync-status.error { color: var(--red); }
    .sync-status.paused { color: var(--yellow); }

    /* v3: Alert cards */
    .alert-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.6rem;
    }
    .alert-card.triggered { border-left: 3px solid var(--red); }
    .alert-card.active { border-left: 3px solid var(--green); }
    .alert-card.paused { border-left: 3px solid var(--yellow); opacity: 0.7; }
    .alert-card-header { display: flex; justify-content: space-between; align-items: center; }
    .alert-card-name { font-size: 0.85rem; font-weight: 500; }
    .alert-card-desc { font-size: 0.75rem; color: var(--muted); margin: 0.3rem 0; line-height: 1.4; }
    .alert-card-stats { font-size: 0.7rem; color: var(--muted); display: flex; gap: 1rem; }
    .alert-card-actions { display: flex; gap: 0.3rem; margin-top: 0.4rem; }

    /* v3: Data Health indicator */
    .data-health {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 3px;
    }
    .data-health.healthy { color: var(--green); }
    .data-health.warning { color: var(--yellow); }
    .data-health.critical { color: var(--red); }

    /* Global data health indicator in tab bar */
    .data-health-global {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.65rem;
      margin-left: auto;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .data-health-global:hover { opacity: 0.8; }
    .data-health-global.healthy {
      color: var(--green);
      background: rgba(34, 197, 94, 0.1);
    }
    .data-health-global.warning {
      color: var(--yellow);
      background: rgba(234, 179, 8, 0.1);
    }
    .data-health-global.critical {
      color: var(--red);
      background: rgba(239, 68, 68, 0.1);
      animation: pulse-health 2s infinite;
    }
    @keyframes pulse-health {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* v3: Onboarding wizard */
    .onboard-step {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .onboard-step h3 { font-size: 0.85rem; margin-bottom: 0.5rem; }
    .onboard-step label { font-size: 0.75rem; color: var(--muted); display: block; margin-bottom: 0.2rem; }
    .onboard-step input, .onboard-step select, .onboard-step textarea {
      width: 100%; margin-bottom: 0.5rem;
    }
    .progress-bar {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      height: 6px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .progress-bar-fill {
      background: var(--accent);
      height: 100%;
      transition: width 0.3s;
    }

    /* v3: Alert NL input */
    .alert-nl-input {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    /* v3: Feed filters */
    .feed-filters {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 0.75rem;
    }
    .feed-filter {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: inherit;
      font-size: 0.7rem;
      padding: 0.3rem 0.7rem;
      border-radius: 20px;
      cursor: pointer;
    }
    .feed-filter.active { border-color: var(--accent); color: var(--accent); }

    /* v3: Threshold cards */
    .threshold-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }
    .threshold-range { font-size: 0.7rem; color: var(--muted); }

    /* Setup card dashboard styles are below in the "Setup Dashboard" section */

    /* Help tooltip */
    .help-tip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--border);
      font-size: 0.6rem;
      color: var(--muted);
      cursor: help;
      margin-left: 0.3rem;
      position: relative;
    }
    .help-tip:hover { border-color: var(--accent); color: var(--accent); }
    .help-tip-box {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      font-size: 0.7rem;
      color: var(--text);
      width: 260px;
      z-index: 200;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      line-height: 1.4;
      font-weight: normal;
    }
    .help-tip:hover .help-tip-box { display: block; }

    /* Green glow animation for newly added items */
    @keyframes addedGlow {
      0% { box-shadow: 0 0 0 0 rgba(0, 206, 201, 0.4); border-color: var(--green); }
      50% { box-shadow: 0 0 12px 4px rgba(0, 206, 201, 0.2); }
      100% { box-shadow: 0 0 0 0 transparent; border-color: var(--border); }
    }
    .just-added { animation: addedGlow 2.5s ease-out; }
    .added-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--green);
      color: #fff;
      font-size: 0.6rem;
      padding: 0.1rem 0.4rem;
      border-radius: 8px;
      font-weight: 600;
      animation: fadeOut 3s forwards;
    }
    @keyframes fadeOut {
      0%, 70% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Industry template banner */
    .template-banner {
      background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(0,206,201,0.1));
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.78rem;
    }
    .template-banner-text { flex: 1; }
    .template-banner-icon { font-size: 1.5rem; margin-right: 0.8rem; }
    .template-banner-actions { display: flex; gap: 0.4rem; }

    /* ===== WHAT-IF IMPROVEMENTS ===== */
    .whatif-help-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.78rem;
      line-height: 1.6;
    }
    .whatif-help-box h4 {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }
    .whatif-help-box ul { padding-left: 1.2rem; color: var(--muted); }
    .whatif-help-box li { margin-bottom: 0.3rem; }
    .whatif-templates {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .whatif-template-btn {
      padding: 0.4rem 0.8rem;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--muted);
      font-size: 0.72rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .whatif-template-btn:hover { border-color: var(--accent); color: var(--accent); }
    .whatif-template-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .whatif-var-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0.6rem;
    }
    .whatif-var-table th {
      font-size: 0.68rem;
      text-align: left;
      padding: 0.3rem 0.5rem;
      background: var(--border);
      font-weight: 500;
    }
    .whatif-var-table td {
      padding: 0.3rem 0.5rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.72rem;
    }
    .whatif-var-table input {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.72rem;
    }
    .whatif-scenario-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.4rem;
      font-size: 0.72rem;
    }
    .whatif-scenario-card h5 {
      font-size: 0.75rem;
      color: var(--accent);
      margin-bottom: 0.3rem;
    }

    /* ===== DEPLOY MODAL REDESIGN ===== */
    .deploy-steps { display: flex; gap: 0.4rem; margin-bottom: 1rem; }
    .deploy-step-indicator {
      flex: 1;
      text-align: center;
      padding: 0.4rem;
      font-size: 0.7rem;
      color: var(--muted);
      border-bottom: 2px solid var(--border);
    }
    .deploy-step-indicator.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }
    .deploy-step-indicator.done {
      color: var(--green);
      border-bottom-color: var(--green);
    }
    .deploy-pipeline {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin: 1rem 0;
      font-size: 0.72rem;
    }
    .deploy-pipeline-node {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
      text-align: center;
    }
    .deploy-pipeline-node .dp-icon { font-size: 1.2rem; display: block; }
    .deploy-pipeline-node .dp-label { font-size: 0.65rem; color: var(--muted); }
    .deploy-pipeline-arrow { color: var(--accent); font-size: 1rem; }
    .deploy-steps-bar { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 0.75rem; }
    .deploy-step-indicator { flex: 1; text-align: center; padding: 0.5rem; font-size: 0.72rem; color: var(--muted); border-bottom: 2px solid transparent; cursor: default; }
    .deploy-step-indicator.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
    .deploy-step-indicator.completed { color: var(--green); border-bottom-color: var(--green); }
    .deploy-pipeline-visual {
      display: flex; align-items: center; justify-content: center; gap: 0.3rem;
      margin: 0.75rem 0; padding: 0.8rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    }
    .pipeline-node { text-align: center; flex: 1; }
    .pipeline-icon { font-size: 1.5rem; display: block; margin-bottom: 0.2rem; }
    .pipeline-label { font-size: 0.72rem; font-weight: 500; color: var(--text); }
    .pipeline-sublabel { font-size: 0.6rem; color: var(--muted); }
    .pipeline-arrow { color: var(--accent); font-size: 1.2rem; flex: 0; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .deploy-success-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }
    .deploy-success-card {
      background: var(--surface);
      border: 1px solid var(--green);
      border-radius: 12px;
      padding: 2rem 3rem;
      text-align: center;
    }
    .deploy-success-card .dsc-icon { font-size: 3rem; margin-bottom: 0.5rem; }
    .deploy-success-card h3 { color: var(--green); margin-bottom: 0.3rem; }
    .deploy-success-card p { color: var(--muted); font-size: 0.8rem; margin-bottom: 1rem; }

    /* ===== AUTH / LOGIN ===== */
    .auth-page {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }
    .auth-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2rem 2.5rem;
      max-width: 380px;
      width: 100%;
    }
    .auth-card h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
    }
    .auth-card h2 span { color: var(--accent); }
    .auth-card label {
      font-size: 0.75rem;
      color: var(--muted);
      display: block;
      margin-bottom: 0.3rem;
    }
    .auth-card input {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 0.8rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.8rem;
    }
    .auth-card button {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.5rem;
    }
    .auth-card .auth-switch {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.75rem;
      color: var(--muted);
    }
    .auth-card .auth-switch a {
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
    }
    .user-badge {
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .user-badge .role-pill {
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 0.6rem;
      background: rgba(108,92,231,0.15);
      color: var(--accent);
    }
    .plan-badge {
      padding: 0.15rem 0.5rem;
      border-radius: 8px;
      font-size: 0.65rem;
      background: rgba(254,202,87,0.15);
      color: var(--yellow);
      font-weight: 600;
    }

    /* ===== FREE TIER LOCK ===== */
    .tab-locked, .locked-tab {
      position: relative;
      opacity: 0.5;
      cursor: not-allowed !important;
    }
    .tab-locked::after, .locked-tab::after {
      content: 'ðŸ”’';
      position: absolute;
      top: -4px;
      right: -4px;
      font-size: 0.55rem;
    }
    .upgrade-modal-content {
      text-align: center;
      padding: 1rem;
    }
    .upgrade-modal-content h3 { margin-bottom: 0.8rem; color: var(--accent); }
    .upgrade-modal-content ul {
      text-align: left;
      padding-left: 1.2rem;
      margin-bottom: 1rem;
      font-size: 0.8rem;
      line-height: 1.8;
    }

    /* ===== ONBOARDING TUTORIAL ===== */
    .tutorial-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
    }
    .tutorial-spotlight {
      position: fixed;
      z-index: 2001;
      border: 2px solid var(--accent);
      border-radius: 8px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
      transition: all 0.4s ease;
    }
    .tutorial-tooltip {
      position: fixed;
      z-index: 2002;
      background: var(--surface);
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 1rem 1.2rem;
      max-width: 320px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .tutorial-tooltip h4 {
      color: var(--accent);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .tutorial-tooltip p {
      font-size: 0.78rem;
      line-height: 1.5;
      color: var(--text);
      margin-bottom: 0.8rem;
    }
    .tutorial-tooltip .tutorial-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tutorial-tooltip .tutorial-dots {
      display: flex;
      gap: 0.3rem;
    }
    .tutorial-tooltip .tutorial-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--border);
    }
    .tutorial-tooltip .tutorial-dot.active { background: var(--accent); }
    .tutorial-tooltip .tutorial-skip {
      font-size: 0.7rem;
      color: var(--muted);
      cursor: pointer;
      background: none;
      border: none;
    }

    /* Styled modal for process steps and I/O */
    .form-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .form-modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 480px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .form-modal h3 {
      font-size: 0.95rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .form-modal label {
      font-size: 0.72rem;
      font-weight: 500;
      color: var(--muted);
      display: block;
      margin-bottom: 0.2rem;
      margin-top: 0.6rem;
    }
    .form-modal input, .form-modal select, .form-modal textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.78rem;
      font-family: inherit;
    }
    .form-modal .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }
    .form-modal .form-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .form-modal .unit-suggestions {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.2rem;
    }
    .form-modal .unit-sug-btn {
      font-size: 0.6rem;
      padding: 0.1rem 0.4rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--muted);
      cursor: pointer;
    }
    .form-modal .unit-sug-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Analyze finding action buttons */
    .finding-actions {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.4rem;
      padding-top: 0.4rem;
      border-top: 1px solid var(--border);
    }

    /* Focus Mode */
    .focus-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.4rem 1rem;
      background: linear-gradient(90deg, rgba(99,102,241,0.1), rgba(99,102,241,0.05));
      border-bottom: 1px solid var(--accent);
      font-size: 0.72rem;
      color: var(--accent);
    }
    .focus-toggle {
      position: relative;
      display: inline-block;
      width: 32px;
      height: 18px;
      flex-shrink: 0;
    }
    .focus-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .focus-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--border);
      border-radius: 18px;
      transition: 0.2s;
    }
    .focus-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      border-radius: 50%;
      transition: 0.2s;
    }
    .focus-toggle input:checked + .focus-slider {
      background-color: var(--accent);
    }
    .focus-toggle input:checked + .focus-slider:before {
      transform: translateX(14px);
    }
    .meta-card.focus-dimmed {
      opacity: 0.45;
      border-color: var(--border);
    }

    /* Setup Dashboard â€” Card Grid Layout */
    .setup-dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .setup-pct-badge {
      background: var(--accent);
      color: #fff;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.1rem 0.4rem;
      border-radius: 8px;
    }
    .setup-card-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.6rem;
      margin-bottom: 1rem;
    }
    .setup-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.7rem 0.8rem;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.1s, box-shadow 0.2s;
      position: relative;
    }
    .setup-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(108,92,231,0.12);
    }
    .setup-card-active {
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 2px rgba(108,92,231,0.15);
    }
    .setup-card-done {
      border-left: 3px solid var(--green);
    }
    .setup-card-done .setup-card-icon { color: var(--green); }
    .setup-card-header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.3rem;
    }
    .setup-card-icon { font-size: 0.85rem; color: var(--muted); }
    .setup-card-title { font-size: 0.78rem; font-weight: 600; }
    .setup-card-summary {
      font-size: 0.68rem;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }
    .setup-card-action {
      font-size: 0.65rem;
      color: var(--accent);
      font-weight: 500;
    }
    .setup-card-actions-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .setup-card-action-secondary { color: var(--muted); }
    .setup-card-suggestions {
      background: linear-gradient(135deg, rgba(108,92,231,0.05), rgba(0,206,201,0.05));
    }

    /* Setup card panel (expandable content below grid) */
    .setup-card-panel {
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      background: var(--surface);
    }
    .setup-card-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    /* Metrics section labels */
    .metrics-section-label {
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: var(--text);
      display: flex;
      align-items: center;
    }

    /* Multi-metric tag input */
    .metric-tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.3rem;
      margin-bottom: 0.5rem;
      min-height: 32px;
      align-items: center;
    }
    .metric-tags-input input {
      border: none;
      background: transparent;
      outline: none;
      font-size: 0.75rem;
      flex: 1;
      min-width: 120px;
      margin: 0;
      padding: 0.2rem;
    }
    .metric-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      background: var(--accent);
      color: #fff;
      border-radius: 12px;
      padding: 0.15rem 0.5rem;
      font-size: 0.68rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .metric-tag-remove {
      cursor: pointer;
      font-size: 0.8rem;
      margin-left: 0.15rem;
      opacity: 0.8;
    }
    .metric-tag-remove:hover { opacity: 1; }

    /* Metric chip in table */
    .metric-chip {
      display: inline-block;
      background: rgba(108,92,231,0.15);
      color: var(--accent);
      border-radius: 10px;
      padding: 0.1rem 0.4rem;
      font-size: 0.65rem;
      font-weight: 500;
      margin: 0.1rem;
    }

    /* Auto-linked hint below process name */
    .auto-linked-hint {
      font-size: 0.62rem;
      color: var(--muted);
      margin-top: 0.15rem;
    }

    /* Suggested metric card */
    .suggested-metric-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.6rem;
    }

    /* Derived metric card */
    .derived-metric-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.6rem;
    }

    /* Auto-link items */
    .auto-link-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.6rem;
      font-size: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    .auto-link-item:last-child { border-bottom: none; }
    .auto-link-done { color: var(--green); }
    .confidence-badge {
      font-size: 0.6rem;
      padding: 0.1rem 0.3rem;
      border-radius: 6px;
      background: var(--border);
      color: var(--text);
      font-weight: 600;
    }

    /* Auto-link confidence indicator */
    .confidence-bar {
      display: inline-block;
      width: 40px;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      vertical-align: middle;
    }
    .confidence-fill {
      height: 100%;
      border-radius: 3px;
    }
    .confidence-high { background: var(--green); }
    .confidence-med { background: var(--amber); }
    .confidence-low { background: var(--red); }

    @media (max-width: 700px) {
      .setup-card-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 480px) {
      .setup-card-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Auth Page (shown when not logged in) -->
  <div id="auth-page" class="auth-page" style="display:none;">
    <div class="auth-card">
      <h2 style="text-align:center;margin-bottom:1.5rem;"><span style="color:var(--accent);">Business</span> Brain</h2>

      <!-- Login Form -->
      <div id="auth-login">
        <h3 style="font-size:0.9rem;margin-bottom:0.75rem;">Sign In</h3>
        <label style="font-size:0.72rem;">Email</label>
        <input type="email" id="login-email" placeholder="you@company.com" style="width:100%;box-sizing:border-box;" />
        <label style="font-size:0.72rem;">Password</label>
        <input type="password" id="login-password" placeholder="Password" style="width:100%;box-sizing:border-box;" />
        <div id="login-error" style="color:var(--red);font-size:0.72rem;margin:0.3rem 0;display:none;"></div>
        <button onclick="doLogin()" style="width:100%;margin-top:0.5rem;">Sign In</button>
        <div style="text-align:center;margin-top:0.75rem;font-size:0.72rem;color:var(--muted);">
          New here? <a href="#" onclick="showRegister();return false;" style="color:var(--accent);">Create Account</a>
        </div>
        <div style="text-align:center;margin-top:0.3rem;font-size:0.72rem;">
          <a href="#" onclick="skipAuth();return false;" style="color:var(--muted);text-decoration:none;">Continue without login &rarr;</a>
        </div>
      </div>

      <!-- Register Form -->
      <div id="auth-register" style="display:none;">
        <h3 style="font-size:0.9rem;margin-bottom:0.75rem;">Create Account</h3>
        <label style="font-size:0.72rem;">Name</label>
        <input type="text" id="reg-name" placeholder="Your name" style="width:100%;box-sizing:border-box;" />
        <label style="font-size:0.72rem;">Email</label>
        <input type="email" id="reg-email" placeholder="you@company.com" style="width:100%;box-sizing:border-box;" />
        <label style="font-size:0.72rem;">Password</label>
        <input type="password" id="reg-password" placeholder="Choose a password" style="width:100%;box-sizing:border-box;" />
        <div id="reg-error" style="color:var(--red);font-size:0.72rem;margin:0.3rem 0;display:none;"></div>
        <button onclick="doRegister()" style="width:100%;margin-top:0.5rem;">Create Account</button>
        <div style="text-align:center;margin-top:0.75rem;font-size:0.72rem;color:var(--muted);">
          Already have an account? <a href="#" onclick="showLogin();return false;" style="color:var(--accent);">Sign In</a>
        </div>
      </div>
    </div>
  </div>

  <div class="app" id="main-app">
    <header>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <h1><span>Business</span> Brain</h1>
          <p>AI-powered business analyst &mdash; ask anything about your data</p>
        </div>
        <div id="user-info" style="display:flex;align-items:center;gap:0.5rem;font-size:0.72rem;">
          <span id="user-plan-badge" style="display:none;padding:2px 8px;border-radius:10px;font-size:0.6rem;font-weight:600;text-transform:uppercase;"></span>
          <span id="user-name-display" style="color:var(--muted);"></span>
          <button onclick="startTutorial()" style="background:none;border:1px solid var(--border);color:var(--muted);padding:3px 8px;border-radius:4px;font-size:0.65rem;cursor:pointer;" title="Product Tour">?</button>
          <button id="logout-btn" onclick="doLogout()" style="display:none;background:none;border:1px solid var(--border);color:var(--muted);padding:3px 8px;border-radius:4px;font-size:0.65rem;cursor:pointer;">Logout</button>
        </div>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-panel="feed">Feed</button>
      <button class="tab" data-panel="analyze">Analyze</button>
      <button class="tab" data-panel="reports">Reports</button>
      <button class="tab" data-panel="alerts">Alerts</button>
      <button class="tab" data-panel="data">Data</button>
      <button class="tab" data-panel="setup">Setup</button>
      <div class="tab-more-wrap">
        <button class="tab-more-btn" id="tab-more-btn">More &#x25BE;</button>
        <div class="tab-more-menu" id="tab-more-menu">
          <button class="tab-menu-item" data-panel="relationships">Relationships</button>
          <button class="tab-menu-item" data-panel="goals">Goals</button>
          <button class="tab-menu-item" data-panel="whatif">What-If</button>
          <button class="tab-menu-item" data-panel="changelog">Audit Log</button>
          <button class="tab-menu-item" data-panel="users">Users</button>
        </div>
      </div>
      <span class="data-health-global" id="data-health-global" title="Data health status"></span>
    </div>

    <!-- Focus Mode Banner -->
    <div id="focus-banner" class="focus-banner" style="display:none;">
      <span>Focus Mode: Analyzing <strong id="focus-count">0</strong> of <strong id="focus-total">0</strong> tables</span>
      <button class="btn-sm btn-secondary" onclick="clearFocusMode()" style="font-size:0.65rem;">Clear Focus</button>
    </div>

    <!-- Feed Panel (Default) -->
    <div id="feed" class="panel active">
      <div class="discovery-bar" id="discovery-bar">
        <div class="disc-stats" id="disc-stats">
          <span>No discovery runs yet</span>
        </div>
        <button class="btn-export btn-sm" onclick="exportFeed('json')" title="Export insights as JSON">Export JSON</button>
        <button class="btn-export btn-sm" onclick="exportFeed('csv')" title="Export insights as CSV">Export CSV</button>
        <button class="btn-sm btn-secondary" onclick="dismissAllInsights()" id="dismiss-all-btn">Dismiss All</button>
        <button class="btn-sm" onclick="triggerDiscovery()" id="scan-btn">Scan Now</button>
      </div>
      <div id="dashboard-kpis" style="display:none;margin-bottom:0.75rem;"></div>
      <div id="recommendations-bar" style="display:none;margin-bottom:0.5rem;"></div>
      <div class="feed-filters">
        <button class="feed-filter active" onclick="filterFeed('all', this)">All</button>
        <button class="feed-filter" onclick="filterFeed('alert', this)">Alerts</button>
        <button class="feed-filter" onclick="filterFeed('insight', this)">Insights</button>
        <button class="feed-filter" onclick="filterFeed('sanctity', this)">Data Issues</button>
        <span style="border-left:1px solid var(--border);height:16px;margin:0 4px;"></span>
        <button class="feed-filter" onclick="filterFeedByStatus('new', this)">New</button>
        <button class="feed-filter" onclick="filterFeedByStatus('seen', this)">Seen</button>
        <button class="feed-filter" onclick="filterFeedByStatus('dismissed', this)">Dismissed</button>
      </div>
      <div id="feed-body">
        <div class="feed-empty" id="feed-empty">
          Upload some data and run a discovery scan to see insights here.
        </div>
      </div>
    </div>

    <!-- Analyze Panel -->
    <div id="analyze" class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
        <span style="font-size:0.7rem;color:var(--muted);" id="session-label"></span>
        <button class="new-chat-btn" onclick="newChat()">New Chat</button>
      </div>
      <div id="chat-thread" class="chat-thread" style="display:none;"></div>
      <div class="suggestion-pills" id="suggestion-pills"></div>
      <div class="input-group">
        <input type="text" id="question" placeholder="Ask a business question..." />
        <button id="ask-btn" onclick="runAnalysis()">Analyze</button>
      </div>
      <div id="analyze-result" class="result">
        <div class="result-header">
          <span>Analysis Pipeline</span>
          <div style="display:flex;gap:0.4rem;align-items:center;">
            <button class="btn-export btn-sm" onclick="exportCSV()" title="Export CSV">CSV</button>
            <button class="btn-export btn-sm" onclick="exportPDF()" title="Export PDF">PDF</button>
            <span id="analyze-status"></span>
          </div>
        </div>
        <div class="result-body" id="analyze-body"></div>
      </div>
    </div>

    <!-- Context Panel -->
    <div id="context" class="panel">
      <div class="context-form">
        <textarea id="ctx-text" placeholder="Enter business context (e.g., 'Enterprise customers generate 80% of our revenue')"></textarea>
        <div class="context-row">
          <input type="text" id="ctx-source" placeholder="Source (optional)" value="manual" />
          <button onclick="submitContext()">Submit Context</button>
        </div>
      </div>
      <div class="ctx-file-zone" id="ctx-file-zone">
        Upload a document as context (.txt, .md, .pdf)
        <input type="file" id="ctx-file-input" accept=".txt,.md,.pdf" />
      </div>
      <div id="context-result" class="result">
        <div class="result-header"><span>Ingestion Log</span></div>
        <div class="result-body" id="context-body"></div>
      </div>
    </div>

    <!-- Upload Panel -->
    <div id="upload" class="panel">
      <div class="drop-zone" id="drop-zone">
        <span class="drop-icon">&#8593;</span>
        <div>Drag &amp; drop a file here, or click to browse</div>
        <div class="drop-hint">Accepts .csv, .xlsx, .pdf</div>
        <input type="file" id="file-input" accept=".csv,.xlsx,.xls,.pdf" />
      </div>
      <div id="upload-result" class="result" style="display:none">
        <div class="result-header">
          <span>Upload Report</span>
          <span id="upload-status"></span>
        </div>
        <div class="result-body" id="upload-body"></div>
      </div>
    </div>

    <!-- Reports Panel -->
    <div id="reports" class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <span style="font-size:0.8rem;color:var(--muted);">Deployed Reports</span>
      </div>
      <div id="reports-body">
        <div class="feed-empty">No deployed reports yet. Deploy insights from the Feed tab.</div>
      </div>
    </div>

    <!-- Alerts Panel -->
    <div id="alerts" class="panel">
      <div class="alert-nl-input">
        <input type="text" id="alert-text" placeholder="Describe an alert condition (e.g., 'Alert me when truck count exceeds 40')..." />
        <button onclick="deployAlert()">Deploy Alert</button>
      </div>
      <div id="alert-confirmation" style="display:none;" class="meta-card">
        <p id="alert-confirm-text"></p>
        <div style="display:flex;gap:0.4rem;margin-top:0.5rem;">
          <button class="btn-sm" onclick="confirmAlertDeploy()">Confirm</button>
          <button class="btn-sm btn-secondary" onclick="cancelAlertDeploy()">Cancel</button>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
        <span style="font-size:0.8rem;color:var(--muted);">Active Alert Rules</span>
        <span class="data-health" id="alerts-health"></span>
      </div>
      <div id="alerts-body">
        <div class="feed-empty">No alert rules deployed yet. Use natural language above to create one.</div>
      </div>
    </div>

    <!-- =====================================================================
         DATA TAB (consolidated: Tables/Schema + Upload + Sources + Quality)
         ===================================================================== -->
    <div id="data" class="panel">
      <div class="sub-nav" id="data-sub-nav">
        <button class="sub-nav-pill active" data-sub="data-tables">Tables</button>
        <button class="sub-nav-pill" data-sub="data-upload">Upload</button>
        <button class="sub-nav-pill" data-sub="data-sources">Sources</button>
        <button class="sub-nav-pill" data-sub="data-quality">Quality</button>
      </div>

      <!-- Sub: Tables (was Schema) -->
      <div id="data-tables" class="sub-panel active">
        <div id="data-schema-body">
          <div class="feed-empty">Loading schema...</div>
        </div>
      </div>

      <!-- Sub: Upload -->
      <div id="data-upload" class="sub-panel">
        <div class="drop-zone" id="data-drop-zone">
          <span class="drop-icon">&#8593;</span>
          <div>Drag &amp; drop a file here, or click to browse</div>
          <div class="drop-hint">Accepts .csv, .xlsx, .pdf</div>
          <input type="file" id="data-file-input" accept=".csv,.xlsx,.xls,.pdf" />
        </div>
        <div id="data-upload-result" class="result" style="display:none">
          <div class="result-header">
            <span>Upload Report</span>
            <span id="data-upload-status"></span>
          </div>
          <div class="result-body" id="data-upload-body"></div>
        </div>
      </div>

      <!-- Sub: Sources -->
      <div id="data-sources" class="sub-panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <span style="font-size:0.8rem;color:var(--muted);">Connected Data Sources</span>
          <div style="display:flex;gap:0.4rem;">
            <button class="btn-sm" onclick="showAddSourceModal('sheet')">+ Google Sheet</button>
            <button class="btn-sm btn-secondary" onclick="showAddSourceModal('api')">+ API</button>
          </div>
        </div>
        <div id="data-sources-body">
          <div class="feed-empty">No data sources connected yet.</div>
        </div>
      </div>

      <!-- Sub: Quality -->
      <div id="data-quality" class="sub-panel">
        <div class="input-group">
          <button onclick="loadDataQuality()">Refresh Quality Scores</button>
        </div>
        <div id="data-quality-body">
          <div class="feed-empty">Click refresh to load data quality scores.</div>
        </div>
      </div>
    </div>

    <!-- Sources Panel (legacy â€” kept for backward compat, hidden from tabs) -->
    <div id="sources" class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <span style="font-size:0.8rem;color:var(--muted);">Connected Data Sources</span>
        <div style="display:flex;gap:0.4rem;">
          <button class="btn-sm" onclick="showAddSourceModal('sheet')">+ Google Sheet</button>
          <button class="btn-sm btn-secondary" onclick="showAddSourceModal('api')">+ API</button>
        </div>
      </div>
      <div id="sources-body">
        <div class="feed-empty">No data sources connected yet. Add a Google Sheet or API endpoint to get started.</div>
      </div>
    </div>

    <!-- =====================================================================
         SETUP TAB (consolidated: Company Profile + Context + Process Map + Metrics + I/O)
         ===================================================================== -->
    <div id="setup" class="panel">
      <!-- Setup Dashboard Header -->
      <div class="setup-dashboard-header">
        <div style="display:flex;align-items:center;gap:0.5rem;">
          <span style="font-size:1rem;font-weight:600;">Setup Dashboard</span>
          <span class="setup-pct-badge" id="setup-completeness">0%</span>
        </div>
        <div class="progress-bar" style="flex:1;max-width:200px;margin:0;"><div class="progress-bar-fill" id="setup-progress" style="width:0%"></div></div>
      </div>

      <!-- Card-Based Dashboard Grid -->
      <div class="setup-card-grid" id="setup-card-grid">
        <div class="setup-card" data-card="profile" onclick="toggleSetupCard('profile')">
          <div class="setup-card-header">
            <span class="setup-card-icon" id="card-icon-profile">&#9675;</span>
            <span class="setup-card-title">Company Profile</span>
          </div>
          <div class="setup-card-summary" id="card-summary-profile">Not configured</div>
          <div class="setup-card-action">Edit</div>
        </div>
        <div class="setup-card" data-card="process" onclick="toggleSetupCard('process')">
          <div class="setup-card-header">
            <span class="setup-card-icon" id="card-icon-process">&#9675;</span>
            <span class="setup-card-title">Process Map</span>
          </div>
          <div class="setup-card-summary" id="card-summary-process">No steps defined</div>
          <div class="setup-card-action">Edit</div>
        </div>
        <div class="setup-card" data-card="metrics" onclick="toggleSetupCard('metrics')">
          <div class="setup-card-header">
            <span class="setup-card-icon" id="card-icon-metrics">&#9675;</span>
            <span class="setup-card-title">Metrics &amp; KPIs</span>
          </div>
          <div class="setup-card-summary" id="card-summary-metrics">No metrics configured</div>
          <div class="setup-card-actions-row">
            <span class="setup-card-action">Edit</span>
            <span class="setup-card-action setup-card-action-secondary" onclick="event.stopPropagation(); runAutoScan()">Auto-scan</span>
          </div>
        </div>
        <div class="setup-card" data-card="io" onclick="toggleSetupCard('io')">
          <div class="setup-card-header">
            <span class="setup-card-icon" id="card-icon-io">&#9675;</span>
            <span class="setup-card-title">Inputs &amp; Outputs</span>
          </div>
          <div class="setup-card-summary" id="card-summary-io">Not configured</div>
          <div class="setup-card-action">Edit</div>
        </div>
        <div class="setup-card" data-card="context" onclick="toggleSetupCard('context')">
          <div class="setup-card-header">
            <span class="setup-card-icon" id="card-icon-context">&#9675;</span>
            <span class="setup-card-title">Business Context</span>
          </div>
          <div class="setup-card-summary" id="card-summary-context">No context added</div>
          <div class="setup-card-action">Edit</div>
        </div>
        <div class="setup-card setup-card-suggestions" data-card="suggestions" onclick="toggleSetupCard('suggestions')">
          <div class="setup-card-header">
            <span class="setup-card-icon">&#128161;</span>
            <span class="setup-card-title">Auto-Suggestions</span>
          </div>
          <div class="setup-card-summary" id="card-summary-suggestions">Upload data to enable</div>
          <div class="setup-card-action">Review</div>
        </div>
      </div>

      <!-- Card Panel: Company Profile -->
      <div id="setup-profile" class="sub-panel setup-card-panel">
        <div class="setup-card-panel-header">
          <span style="font-size:0.9rem;font-weight:500;">Company Profile</span>
          <button class="btn-sm btn-secondary" onclick="collapseSetupCard('profile')">&times; Close</button>
        </div>
        <div class="template-banner" id="template-banner" style="display:none;">
          <span class="template-banner-icon">&#127981;</span>
          <div class="template-banner-text">
            <strong id="template-industry-name">Steel Manufacturing</strong> detected &mdash; Load recommended setup?
            <div style="font-size:0.7rem;color:var(--muted);margin-top:0.2rem;">Pre-fills process map, metrics, inputs &amp; outputs with industry defaults. You can edit everything.</div>
          </div>
          <div class="template-banner-actions">
            <button class="btn-sm" onclick="applyIndustryTemplate()">Apply Template</button>
            <button class="btn-sm btn-secondary" onclick="dismissTemplateBanner()">I'll do it manually</button>
          </div>
        </div>
        <div class="onboard-step">
          <h3>Company Basics</h3>
          <label>Company Name</label>
          <input type="text" id="ob-name" placeholder="Your company name" oninput="updateSetupChecklist()" />
          <label>Industry</label>
          <select id="ob-industry" onchange="onIndustryChange(); updateSetupChecklist();">
            <option value="">Select industry...</option>
            <option value="steel">Steel</option>
            <option value="cement">Cement</option>
            <option value="textile">Textile</option>
            <option value="pharma">Pharma</option>
            <option value="auto">Automotive</option>
            <option value="food">Food Processing</option>
            <option value="other">Other</option>
          </select>
          <label>Products (comma-separated)</label>
          <input type="text" id="ob-products" placeholder="e.g., TMT bars, billets, wire rods" oninput="updateSetupChecklist()" />
        </div>
        <div class="onboard-step">
          <h3>Process Flow</h3>
          <label>Describe your production process</label>
          <textarea id="ob-process" rows="3" placeholder="e.g., Scrap/sponge iron &#8594; Induction furnace &#8594; Continuous casting &#8594; Rolling mill &#8594; TMT bars" oninput="updateSetupChecklist()"></textarea>
        </div>
        <div class="onboard-step">
          <h3>Data Systems</h3>
          <label>List your systems (one per line: Name - Description)</label>
          <textarea id="ob-systems" rows="4" placeholder="Tally - Financial accounting&#10;VEGA - Truck/logistics management&#10;SCADA - Electrical monitoring"></textarea>
        </div>
        <div style="display:flex;gap:0.5rem;">
          <button onclick="saveOnboarding()">Save Profile</button>
          <button class="btn-secondary" onclick="loadOnboarding()">Refresh</button>
        </div>
      </div>

      <!-- Card Panel: Process Map -->
      <div id="setup-process" class="sub-panel setup-card-panel">
        <div class="setup-card-panel-header">
          <div style="display:flex;align-items:center;">
            <span style="font-size:0.85rem;font-weight:500;">Production Process Map</span>
            <span class="help-tip">?<div class="help-tip-box">Define each step of your production process. The AI uses this to understand how your plant works and detect where issues occur.</div></span>
          </div>
          <div style="display:flex;gap:0.3rem;">
            <button class="btn-sm" onclick="openProcessStepModal()">+ Add Step</button>
            <button class="btn-sm btn-secondary" onclick="collapseSetupCard('process')">&times; Close</button>
          </div>
        </div>
        <div id="process-steps-body">
          <div class="feed-empty" style="padding:0.8rem;">No process steps defined yet. Click "+ Add Step" to start.</div>
        </div>
      </div>

      <!-- Card Panel: Metrics & KPIs -->
      <div id="setup-metrics" class="sub-panel setup-card-panel">
        <div class="setup-card-panel-header">
          <div style="display:flex;align-items:center;">
            <span style="font-size:0.85rem;font-weight:500;">Metrics &amp; KPIs</span>
            <span class="help-tip">?<div class="help-tip-box">Set target ranges for your critical metrics. The AI will alert you when any metric goes outside these ranges.</div></span>
          </div>
          <div style="display:flex;gap:0.3rem;">
            <button class="btn-sm" onclick="showAddThresholdModal()">+ Add Metric</button>
            <button class="btn-sm btn-secondary" onclick="collapseSetupCard('metrics')">&times; Close</button>
          </div>
        </div>
        <!-- Your Metrics -->
        <div class="metrics-section-label">Your Metrics</div>
        <div id="thresholds-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.5rem;">
          <div class="feed-empty" style="padding:0.8rem;grid-column:1/-1;">No thresholds configured yet.</div>
        </div>
        <!-- Auto-Discovered Metrics -->
        <div class="metrics-section-label" style="margin-top:1rem;">Auto-Discovered from Data
          <button class="btn-sm btn-secondary" onclick="loadSuggestedMetrics()" style="margin-left:0.5rem;font-size:0.65rem;">Scan Now</button>
        </div>
        <div id="suggested-metrics-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.5rem;">
          <div class="feed-empty" style="padding:0.5rem;grid-column:1/-1;font-size:0.72rem;">Upload data first, then click "Scan Now" to discover metrics.</div>
        </div>
        <!-- Derived Metrics -->
        <div class="metrics-section-label" style="margin-top:1rem;">Derived Metrics
          <button class="btn-sm btn-secondary" onclick="openDerivedMetricModal()" style="margin-left:0.5rem;font-size:0.65rem;">+ Create</button>
        </div>
        <div id="derived-metrics-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.5rem;">
          <div class="feed-empty" style="padding:0.5rem;grid-column:1/-1;font-size:0.72rem;">No derived metrics. Create formulas like <em>total_kwh / output_mt</em>.</div>
        </div>
      </div>

      <!-- Card Panel: Inputs & Outputs -->
      <div id="setup-io" class="sub-panel setup-card-panel">
        <div class="setup-card-panel-header">
          <div style="display:flex;align-items:center;">
            <span style="font-size:0.85rem;font-weight:500;">Process Inputs &amp; Outputs</span>
            <span class="help-tip">?<div class="help-tip-box">List what goes into your production process and what comes out. This helps track yield, losses, and cost per unit.</div></span>
          </div>
          <div style="display:flex;gap:0.3rem;">
            <button class="btn-sm" onclick="openIOModal('input')">+ Input</button>
            <button class="btn-sm btn-secondary" onclick="openIOModal('output')">+ Output</button>
            <button class="btn-sm btn-secondary" onclick="collapseSetupCard('io')">&times; Close</button>
          </div>
        </div>
        <div id="process-io-body">
          <div class="feed-empty" style="padding:0.8rem;">No inputs or outputs defined yet.</div>
        </div>
      </div>

      <!-- Card Panel: Business Context -->
      <div id="setup-context" class="sub-panel setup-card-panel">
        <div class="setup-card-panel-header">
          <div style="display:flex;align-items:center;">
            <span style="font-size:0.85rem;font-weight:500;">Business Context</span>
            <span class="help-tip">?<div class="help-tip-box">Add any business rules, constraints, or knowledge that the AI should know about when analyzing your data.</div></span>
          </div>
          <div style="display:flex;gap:0.3rem;">
            <button class="btn-sm" onclick="showAddContextModal()">+ Add Context</button>
            <button class="btn-sm btn-secondary" onclick="loadContextEntries()">Refresh</button>
            <button class="btn-sm btn-secondary" onclick="collapseSetupCard('context')">&times; Close</button>
          </div>
        </div>
        <div class="context-form" style="margin-bottom:0.75rem;">
          <textarea id="ctx-text" rows="2" placeholder="Enter business context (e.g., 'Enterprise customers generate 80% of our revenue')" style="font-size:0.75rem;"></textarea>
          <div style="display:flex;gap:0.3rem;margin-top:0.3rem;">
            <input type="text" id="ctx-source" placeholder="Source label" value="manual" style="font-size:0.72rem;flex:1;" />
            <button class="btn-sm" onclick="submitContext()">Add</button>
          </div>
        </div>
        <div id="context-entries-body">
          <div class="feed-empty" style="padding:0.8rem;">Loading context entries...</div>
        </div>
      </div>

      <!-- Card Panel: Auto-Suggestions -->
      <div id="setup-suggestions" class="sub-panel setup-card-panel">
        <div class="setup-card-panel-header">
          <div style="display:flex;align-items:center;">
            <span style="font-size:0.85rem;font-weight:500;">Auto-Suggestions</span>
            <span class="help-tip">?<div class="help-tip-box">The system automatically matches your metrics to data columns. Review and accept suggestions or manually override.</div></span>
          </div>
          <div style="display:flex;gap:0.3rem;">
            <button class="btn-sm" onclick="runAutoLink()">Run Auto-Link</button>
            <button class="btn-sm btn-secondary" onclick="collapseSetupCard('suggestions')">&times; Close</button>
          </div>
        </div>
        <div id="auto-link-body">
          <div class="feed-empty" style="padding:0.8rem;">Click "Run Auto-Link" to match your metrics to data columns automatically.</div>
        </div>
      </div>
    </div>

    <!-- Process Step Modal (multi-metric, no linked table) -->
    <div class="form-modal-overlay" id="process-step-modal" style="display:none;" onclick="if(event.target===this)this.style.display='none'">
      <div class="form-modal">
        <h3>Add Process Step <button onclick="document.getElementById('process-step-modal').style.display='none'" style="background:none;border:none;color:var(--text);font-size:1.2rem;cursor:pointer;">&times;</button></h3>
        <label>Process Name *</label>
        <input type="text" id="ps-name" placeholder="e.g., Induction Furnace Melting" />
        <div class="form-row">
          <div><label>Inputs</label><input type="text" id="ps-inputs" placeholder="e.g., Scrap, Electricity" /></div>
          <div><label>Outputs</label><input type="text" id="ps-outputs" placeholder="e.g., Molten steel" /></div>
        </div>
        <label>Key Metrics <span style="font-size:0.65rem;color:var(--muted);">(comma-separated, e.g., SEC, Yield %, Tap-to-tap time)</span></label>
        <div class="metric-tags-input" id="ps-metrics-tags">
          <input type="text" id="ps-metric-input" placeholder="Type a metric and press Enter" onkeydown="if(event.key==='Enter'){event.preventDefault();addMetricTag()}" />
        </div>
        <input type="hidden" id="ps-metric" value="" />
        <div id="ps-ranges-container">
          <label>Target Ranges <span style="font-size:0.65rem;color:var(--muted);">(per metric)</span></label>
          <div id="ps-ranges-list">
            <input type="text" id="ps-range" placeholder="e.g., 500-625 kWh/ton" />
          </div>
        </div>
        <div class="form-row">
          <div><label>Step Order</label><input type="number" id="ps-order" value="1" min="1" /></div>
        </div>
        <input type="hidden" id="ps-edit-id" value="" />
        <input type="hidden" id="ps-table" value="" />
        <div class="form-actions">
          <button onclick="submitProcessStep()">Save Step</button>
          <button class="btn-secondary" onclick="document.getElementById('process-step-modal').style.display='none'">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Derived Metric Modal -->
    <div class="form-modal-overlay" id="derived-metric-modal" style="display:none;" onclick="if(event.target===this)this.style.display='none'">
      <div class="form-modal">
        <h3>Create Derived Metric <button onclick="document.getElementById('derived-metric-modal').style.display='none'" style="background:none;border:none;color:var(--text);font-size:1.2rem;cursor:pointer;">&times;</button></h3>
        <label>Metric Name *</label>
        <input type="text" id="dm-name" placeholder="e.g., Specific Energy Consumption" />
        <label>Unit</label>
        <input type="text" id="dm-unit" placeholder="e.g., kWh/ton" />
        <label>Formula <span style="font-size:0.65rem;color:var(--muted);">(use table.column notation)</span></label>
        <input type="text" id="dm-formula" placeholder="e.g., power_data.total_kwh / production.output_mt" style="font-family:monospace;" />
        <div class="form-row">
          <div><label>Warning Below</label><input type="number" id="dm-warn-min" step="any" placeholder="e.g., 450" /></div>
          <div><label>Warning Above</label><input type="number" id="dm-warn-max" step="any" placeholder="e.g., 650" /></div>
        </div>
        <div class="form-row">
          <div><label>Critical Below</label><input type="number" id="dm-crit-min" step="any" placeholder="e.g., 400" /></div>
          <div><label>Critical Above</label><input type="number" id="dm-crit-max" step="any" placeholder="e.g., 750" /></div>
        </div>
        <div class="form-actions">
          <button onclick="submitDerivedMetric()">Create Metric</button>
          <button class="btn-secondary" onclick="document.getElementById('derived-metric-modal').style.display='none'">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Process I/O Modal (replaces browser prompt) -->
    <div class="form-modal-overlay" id="process-io-modal" style="display:none;" onclick="if(event.target===this)this.style.display='none'">
      <div class="form-modal">
        <h3 id="io-modal-title">Add Input <button onclick="document.getElementById('process-io-modal').style.display='none'" style="background:none;border:none;color:var(--text);font-size:1.2rem;cursor:pointer;">&times;</button></h3>
        <input type="hidden" id="io-type" value="input" />
        <label>Name *</label>
        <input type="text" id="io-name" placeholder="e.g., Scrap Iron (HMS1/HMS2)" />
        <label id="io-src-label">Source</label>
        <input type="text" id="io-src" placeholder="e.g., Scrap dealers, importers" />
        <div class="form-row">
          <div>
            <label>Unit</label>
            <input type="text" id="io-unit" placeholder="e.g., MT" />
            <div class="unit-suggestions">
              <button class="unit-sug-btn" onclick="document.getElementById('io-unit').value='MT'">MT</button>
              <button class="unit-sug-btn" onclick="document.getElementById('io-unit').value='kWh'">kWh</button>
              <button class="unit-sug-btn" onclick="document.getElementById('io-unit').value='kg'">kg</button>
              <button class="unit-sug-btn" onclick="document.getElementById('io-unit').value='litres'">litres</button>
              <button class="unit-sug-btn" onclick="document.getElementById('io-unit').value='%'">%</button>
              <button class="unit-sug-btn" onclick="document.getElementById('io-unit').value='&#176;C'">&deg;C</button>
            </div>
          </div>
          <div><label>Typical Range</label><input type="text" id="io-range" placeholder="e.g., 3-5 per heat" /></div>
        </div>
        <label>Linked Table</label>
        <input type="text" id="io-table" placeholder="e.g., purchases" />
        <div class="form-actions">
          <button onclick="submitProcessIO()">Save</button>
          <button class="btn-secondary" onclick="document.getElementById('process-io-modal').style.display='none'">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Data Quality Panel -->
    <div id="quality" class="panel">
      <div class="input-group">
        <button onclick="loadDataQuality()">Refresh Quality Scores</button>
      </div>
      <div id="quality-body">
        <div class="feed-empty">Click refresh to load data quality scores for all tables.</div>
      </div>
      <div id="time-analysis-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow:auto;">
        <div style="max-width:700px;margin:3rem auto;background:var(--bg);border-radius:12px;padding:1.5rem;border:1px solid var(--border);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3 id="time-analysis-title" style="margin:0;">Time Analysis</h3>
            <button onclick="document.getElementById('time-analysis-overlay').style.display='none'" style="background:none;border:none;color:var(--text);font-size:1.2rem;cursor:pointer;">X</button>
          </div>
          <div id="time-analysis-body">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Relationships Panel -->
    <div id="relationships" class="panel">
      <div class="input-group" style="display:flex;gap:0.5rem;">
        <button onclick="loadRelationships()">Refresh Relationships</button>
        <button onclick="loadLineage()" style="background:var(--accent);">View Lineage</button>
      </div>
      <div id="relationships-body">
        <div class="feed-empty">Click refresh to load discovered cross-table relationships.</div>
      </div>
      <div id="lineage-body" style="margin-top:1rem;"></div>
    </div>

    <!-- Audit Log Panel -->
    <div id="changelog" class="panel">
      <div class="input-group">
        <button onclick="loadAuditLog()">Refresh Audit Log</button>
      </div>
      <div id="changelog-body">
        <div class="feed-empty">Click refresh to load recent data changes.</div>
      </div>
    </div>

    <!-- Goals Panel -->
    <div id="goals" class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
        <h3 style="margin:0;font-size:0.95rem;">Metric Goals</h3>
        <button class="btn-sm" onclick="showAddGoalForm()">+ Add Goal</button>
      </div>
      <div id="goal-form" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.75rem;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-bottom:0.4rem;">
          <input id="goal-metric" placeholder="Metric name (e.g. revenue)" style="padding:6px;border-radius:4px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:0.75rem;">
          <input id="goal-target" type="number" placeholder="Target value" style="padding:6px;border-radius:4px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:0.75rem;">
          <select id="goal-direction" style="padding:6px;border-radius:4px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:0.75rem;">
            <option value="above">Target: Above</option>
            <option value="below">Target: Below</option>
            <option value="between">Target: Between</option>
          </select>
          <input id="goal-baseline" type="number" placeholder="Baseline (optional)" style="padding:6px;border-radius:4px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:0.75rem;">
        </div>
        <div style="display:flex;gap:0.4rem;">
          <button class="btn-sm" onclick="addGoal()">Save Goal</button>
          <button class="btn-sm btn-secondary" onclick="document.getElementById('goal-form').style.display='none'">Cancel</button>
        </div>
      </div>
      <div id="goals-health" style="margin-bottom:0.75rem;"></div>
      <div id="goals-body"><div class="feed-empty">No goals set yet. Click "+ Add Goal" to define metric targets.</div></div>
    </div>

    <!-- What-If Panel (redesigned) -->
    <div id="whatif" class="panel">
      <!-- Help Section -->
      <div style="background:linear-gradient(135deg,rgba(108,92,231,0.08),rgba(0,206,201,0.05));border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:1rem;">
        <div style="font-size:0.95rem;font-weight:600;margin-bottom:0.4rem;">&#128202; What-If Scenario Modeler</div>
        <div style="font-size:0.78rem;color:var(--muted);line-height:1.5;margin-bottom:0.5rem;">
          Answer "what would happen if...?" questions about your business.<br>
          Change one or more variables and see how it affects your results.
        </div>
        <div style="font-size:0.72rem;color:var(--muted);line-height:1.6;">
          <strong>Examples:</strong><br>
          &bull; What if scrap price goes up by &#8377;2,000/ton?<br>
          &bull; What if we increase production to 85% utilization?<br>
          &bull; What if power tariff increases by &#8377;1/kWh?
        </div>
      </div>

      <!-- Quick Scenario Templates -->
      <div style="margin-bottom:0.75rem;">
        <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.4rem;font-weight:500;">Quick scenarios:</div>
        <div id="whatif-templates" style="display:flex;gap:0.3rem;flex-wrap:wrap;">
          <button class="btn-sm btn-secondary" onclick="loadWhatIfTemplate('custom')" style="font-size:0.68rem;">&#9998; Custom</button>
          <button class="btn-sm" onclick="tryWhatIfExample()" style="font-size:0.68rem;background:var(--green);color:#000;">&#9654; Try Example</button>
        </div>
      </div>

      <!-- Formula Section -->
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.75rem;">
        <div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.4rem;">
          <span style="font-size:0.75rem;font-weight:600;">Formula</span>
          <span class="help-tip" style="position:relative;">?<div class="help-tip-box">Write a math formula using your variables. Example: revenue = price * quantity. The formula is evaluated for each scenario.</div></span>
        </div>
        <input id="whatif-formula" placeholder="e.g. scrap_price * monthly_tonnage" style="width:100%;padding:6px;border-radius:4px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:0.75rem;margin-bottom:0.6rem;box-sizing:border-box;">

        <!-- Visual Variable Builder -->
        <div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.4rem;">
          <span style="font-size:0.75rem;font-weight:600;">Variables</span>
          <span class="help-tip" style="position:relative;">?<div class="help-tip-box">Define the variables used in your formula. Set their current values and units. Scenarios will change these values to see the impact.</div></span>
        </div>
        <div id="whatif-vars-table">
          <table style="width:100%;font-size:0.72rem;border-collapse:collapse;margin-bottom:0.4rem;">
            <thead><tr style="border-bottom:1px solid var(--border);color:var(--muted);">
              <th style="padding:4px;text-align:left;">Variable</th>
              <th style="padding:4px;text-align:left;">Current Value</th>
              <th style="padding:4px;text-align:left;">Unit</th>
              <th style="padding:4px;width:30px;"></th>
            </tr></thead>
            <tbody id="whatif-vars-body"></tbody>
          </table>
          <button class="btn-sm btn-secondary" onclick="addWhatIfVar()" style="font-size:0.65rem;">+ Add Variable</button>
        </div>

        <!-- Scenarios (visual) -->
        <div style="display:flex;align-items:center;gap:0.3rem;margin:0.6rem 0 0.4rem;">
          <span style="font-size:0.75rem;font-weight:600;">Scenarios</span>
          <span class="help-tip" style="position:relative;">?<div class="help-tip-box">Each scenario changes one or more variables. You'll see side-by-side results showing how each change impacts your formula's output.</div></span>
        </div>
        <div id="whatif-scenarios-visual"></div>
        <button class="btn-sm btn-secondary" onclick="addWhatIfScenario()" style="font-size:0.65rem;margin-top:0.3rem;">+ Add Scenario</button>

        <!-- Hidden fields for backward compatibility with existing runWhatIf -->
        <input type="hidden" id="whatif-base" />
        <textarea id="whatif-scenarios" style="display:none;"></textarea>

        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.6rem;">
          <button class="btn-sm" onclick="syncWhatIfAndRun()">Compare Scenarios</button>
          <button class="btn-sm btn-secondary" onclick="syncWhatIfAndBreakeven()">
            Breakeven
            <span class="help-tip" style="position:relative;font-size:0.6rem;margin-left:2px;">?<div class="help-tip-box">Find the exact point where revenue equals cost (profit = 0)</div></span>
          </button>
          <button class="btn-sm btn-secondary" onclick="syncWhatIfAndSensitivity()">
            Sensitivity
            <span class="help-tip" style="position:relative;font-size:0.6rem;margin-left:2px;">?<div class="help-tip-box">See which variable has the biggest impact on your result</div></span>
          </button>
        </div>
      </div>
      <div id="whatif-body"><div class="feed-empty">Choose a quick scenario above or build your own, then click "Compare Scenarios" to model outcomes.</div></div>
    </div>

    <!-- Users / Access Management Panel -->
    <div id="users" class="panel">
      <div class="sub-nav" id="users-sub-nav">
        <button class="sub-nav-pill active" data-sub="users-list" onclick="switchUsersSub('users-list')">Team Members</button>
        <button class="sub-nav-pill" data-sub="users-invite" onclick="switchUsersSub('users-invite')">Invite User</button>
        <button class="sub-nav-pill" data-sub="users-pending" onclick="switchUsersSub('users-pending')">Pending Invites</button>
      </div>

      <!-- Sub: Team Members List -->
      <div id="users-list" class="sub-panel active">
        <div id="users-list-body">
          <div class="feed-empty">Loading team members...</div>
        </div>
      </div>

      <!-- Sub: Invite User Form -->
      <div id="users-invite" class="sub-panel">
        <div class="onboard-step" style="max-width:480px;">
          <h3 style="margin-top:0;">Invite a Team Member</h3>
          <label>Email Address</label>
          <input type="email" id="invite-email" placeholder="colleague@company.com" />
          <label style="margin-top:0.5rem;">Role</label>
          <select id="invite-role">
            <option value="viewer">Viewer â€” Read-only access to Feed &amp; Reports</option>
            <option value="operator">Operator â€” Can also analyze data</option>
            <option value="manager" selected>Manager â€” Can create reports, alerts, what-if</option>
            <option value="admin">Admin â€” Full access including user management</option>
          </select>
          <label style="margin-top:0.5rem;">Plan</label>
          <select id="invite-plan">
            <option value="free">Free</option>
            <option value="basic">Basic</option>
            <option value="pro" selected>Pro</option>
          </select>
          <button onclick="sendInvite()" style="margin-top:0.8rem;">Send Invite</button>
          <div id="invite-result" style="display:none;margin-top:0.7rem;"></div>
        </div>
      </div>

      <!-- Sub: Pending Invites -->
      <div id="users-pending" class="sub-panel">
        <div id="pending-invites-body">
          <div class="feed-empty">Loading pending invites...</div>
        </div>
      </div>
    </div>

    <!-- Schema Panel -->
    <div id="schema" class="panel">
      <div class="input-group" style="display:flex;gap:0.5rem;">
        <button onclick="loadSchema()">Refresh Schema</button>
        <button onclick="redescribeSchema()" style="background:var(--accent);color:#fff;">Enrich Descriptions</button>
        <button onclick="cleanupOrphanedTables()" style="background:var(--orange,#e67e22);color:#fff;">Cleanup Unused Tables</button>
      </div>
      <div id="schema-body"></div>
    </div>
  </div>

  <!-- Deploy Modal (Multi-step Wizard) -->
  <div class="modal-overlay" id="deploy-modal">
    <div class="modal" style="max-width:550px;">
      <div class="modal-header">
        <h3 id="deploy-modal-title">Deploy as Report</h3>
        <button class="modal-close" onclick="closeDeployModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Step indicators -->
        <div class="deploy-steps-bar">
          <div class="deploy-step-indicator active" id="deploy-step-1">1. Review</div>
          <div class="deploy-step-indicator" id="deploy-step-2">2. Pipeline</div>
          <div class="deploy-step-indicator" id="deploy-step-3">3. Configure</div>
        </div>

        <!-- Step 1: Review -->
        <div id="deploy-review" class="deploy-step-panel">
          <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.3rem;text-transform:uppercase;letter-spacing:0.5px;">Insight Summary</div>
          <div id="deploy-summary" style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.75rem;font-size:0.78rem;line-height:1.5;">
            <!-- Populated dynamically -->
          </div>
          <div style="text-align:right;">
            <button class="btn-sm" onclick="goDeployStep(2)">Next: View Pipeline &#8594;</button>
          </div>
        </div>

        <!-- Step 2: Pipeline Visualization -->
        <div id="deploy-pipeline" class="deploy-step-panel" style="display:none;">
          <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.5rem;text-transform:uppercase;letter-spacing:0.5px;">How this report works</div>
          <div class="deploy-pipeline-visual">
            <div class="pipeline-node">
              <div class="pipeline-icon">&#128202;</div>
              <div class="pipeline-label" id="pipeline-source">Data Source</div>
              <div class="pipeline-sublabel">source</div>
            </div>
            <div class="pipeline-arrow">&#8594;</div>
            <div class="pipeline-node">
              <div class="pipeline-icon">&#128269;</div>
              <div class="pipeline-label">SQL Query</div>
              <div class="pipeline-sublabel">filter &amp; aggregate</div>
            </div>
            <div class="pipeline-arrow">&#8594;</div>
            <div class="pipeline-node">
              <div class="pipeline-icon">&#128200;</div>
              <div class="pipeline-label">Analysis</div>
              <div class="pipeline-sublabel">trend + anomaly</div>
            </div>
            <div class="pipeline-arrow">&#8594;</div>
            <div class="pipeline-node">
              <div class="pipeline-icon">&#128203;</div>
              <div class="pipeline-label">Report</div>
              <div class="pipeline-sublabel">saved &amp; tracked</div>
            </div>
          </div>
          <div id="deploy-pipeline-details" style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem;font-size:0.72rem;line-height:1.6;margin:0.75rem 0;">
            <!-- Populated dynamically -->
          </div>
          <div style="display:flex;justify-content:space-between;">
            <button class="btn-sm btn-secondary" onclick="goDeployStep(1)">&#8592; Back</button>
            <button class="btn-sm" onclick="goDeployStep(3)">Next: Configure &#8594;</button>
          </div>
        </div>

        <!-- Step 3: Configure & Confirm -->
        <div id="deploy-configure" class="deploy-step-panel" style="display:none;">
          <div class="deploy-modal-content">
            <label>Report Name</label>
            <input type="text" id="deploy-name" placeholder="Enter report name..." />
            <label>Refresh Frequency</label>
            <div style="display:flex;gap:0.5rem;margin-bottom:0.75rem;">
              <label style="display:flex;align-items:center;gap:0.2rem;font-size:0.72rem;cursor:pointer;">
                <input type="radio" name="deploy-freq" value="manual" checked> Manual
              </label>
              <label style="display:flex;align-items:center;gap:0.2rem;font-size:0.72rem;cursor:pointer;">
                <input type="radio" name="deploy-freq" value="daily"> Daily
              </label>
              <label style="display:flex;align-items:center;gap:0.2rem;font-size:0.72rem;cursor:pointer;">
                <input type="radio" name="deploy-freq" value="weekly"> Weekly
              </label>
              <label style="display:flex;align-items:center;gap:0.2rem;font-size:0.72rem;cursor:pointer;">
                <input type="radio" name="deploy-freq" value="never"> Never
              </label>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <button class="btn-sm btn-secondary" onclick="goDeployStep(2)">&#8592; Back</button>
              <button onclick="confirmDeploy()">Deploy Report &#8594;</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Deploy Success Overlay -->
  <div id="deploy-success" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:2000;display:none;align-items:center;justify-content:center;">
    <div style="text-align:center;animation:fadeInUp 0.5s ease;">
      <div style="font-size:3rem;">&#10004;</div>
      <div style="font-size:1.3rem;font-weight:600;margin:0.5rem 0;">Report Deployed!</div>
      <div id="deploy-success-name" style="color:var(--accent);font-size:0.9rem;margin-bottom:1rem;"></div>
      <div style="display:flex;gap:0.5rem;justify-content:center;">
        <button class="btn-sm" onclick="viewDeployedReport()" style="padding:8px 16px;">View Report &#8594;</button>
        <button class="btn-sm btn-secondary" onclick="closeDeploySuccess()" style="padding:8px 16px;">Back to Feed</button>
      </div>
    </div>
  </div>

  <!-- Data Viewer Modal -->
  <div class="modal-overlay" id="data-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Data Viewer</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Add Source Modal -->
  <div class="modal-overlay" id="source-modal">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 id="source-modal-title">Add Google Sheet</h3>
        <button class="modal-close" onclick="closeSourceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="source-sheet-form">
          <div class="deploy-modal-content">
            <label>Google Sheets URL or ID</label>
            <input type="text" id="src-sheet-url" placeholder="https://docs.google.com/spreadsheets/d/..." />
            <label>Name (optional)</label>
            <input type="text" id="src-sheet-name" placeholder="e.g., SCADA Power Log" />
            <label>Tab Name (optional, defaults to first tab)</label>
            <input type="text" id="src-sheet-tab" placeholder="Sheet1" />
            <label>Table Name (optional)</label>
            <input type="text" id="src-table-name" placeholder="auto-generated from sheet name" />
            <label>Sync Frequency (minutes, 0 = manual only)</label>
            <input type="number" id="src-freq" value="5" min="0" />
            <button onclick="submitGoogleSheet()">Connect Sheet</button>
          </div>
        </div>
        <div id="source-api-form" style="display:none;">
          <div class="deploy-modal-content">
            <label>API URL</label>
            <input type="text" id="src-api-url" placeholder="https://api.example.com/data" />
            <label>Name</label>
            <input type="text" id="src-api-name" placeholder="e.g., ERP Production Data" />
            <label>Target Table Name</label>
            <input type="text" id="src-api-table" placeholder="erp_production" />
            <label>Sync Frequency (minutes, 0 = manual only)</label>
            <input type="number" id="src-api-freq" value="0" min="0" />
            <button onclick="submitApiSource()">Connect API</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Threshold Modal -->
  <div class="modal-overlay" id="threshold-modal">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h3>Add Metric Threshold</h3>
        <button class="modal-close" onclick="document.getElementById('threshold-modal').classList.remove('active')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="deploy-modal-content">
          <label>Metric Name</label>
          <input type="text" id="th-metric" placeholder="e.g., power_consumption_per_ton" />
          <label>Table Name (optional)</label>
          <input type="text" id="th-table" placeholder="" />
          <label>Column Name (optional)</label>
          <input type="text" id="th-column" placeholder="" />
          <label>Unit</label>
          <input type="text" id="th-unit" placeholder="e.g., kWh/ton" />
          <label>Normal Range</label>
          <div style="display:flex;gap:0.4rem;">
            <input type="number" id="th-normal-min" placeholder="Min" />
            <input type="number" id="th-normal-max" placeholder="Max" />
          </div>
          <label>Warning Range</label>
          <div style="display:flex;gap:0.4rem;">
            <input type="number" id="th-warning-min" placeholder="Min" />
            <input type="number" id="th-warning-max" placeholder="Max" />
          </div>
          <label>Critical Range</label>
          <div style="display:flex;gap:0.4rem;">
            <input type="number" id="th-critical-min" placeholder="Min" />
            <input type="number" id="th-critical-max" placeholder="Max" />
          </div>
          <button onclick="submitThreshold()">Save Threshold</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upgrade Modal -->
  <div class="modal-overlay" id="upgrade-modal">
    <div class="modal" style="max-width:420px;">
      <div class="modal-header">
        <h3>Upgrade Required</h3>
        <button class="modal-close" onclick="document.getElementById('upgrade-modal').classList.remove('active')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="upgrade-modal-content">
          <div style="font-size:2rem;margin-bottom:0.5rem;">&#128274;</div>
          <h3 id="upgrade-feature-name">This feature requires an upgrade</h3>
          <p style="color:var(--muted);font-size:0.78rem;margin-bottom:1rem;">Upgrade to unlock advanced features:</p>
          <ul style="text-align:left;font-size:0.78rem;line-height:2;">
            <li>&#10003; Unlimited data uploads</li>
            <li>&#10003; Reports &amp; Alerts</li>
            <li>&#10003; What-If scenarios</li>
            <li>&#10003; Full Setup &amp; Context</li>
            <li>&#10003; Deploy reports</li>
            <li>&#10003; Export data</li>
          </ul>
          <div style="display:flex;gap:0.5rem;justify-content:center;margin-top:1rem;">
            <button onclick="window.open('mailto:sales@businessbrain.ai?subject=Upgrade%20Request','_blank');document.getElementById('upgrade-modal').classList.remove('active')">Contact for Upgrade</button>
            <button class="btn-secondary" onclick="document.getElementById('upgrade-modal').classList.remove('active')">Maybe Later</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tutorial Overlay -->
  <div id="tutorial-overlay" class="tutorial-overlay" style="display:none;" onclick="endTutorial()"></div>
  <div id="tutorial-spotlight" class="tutorial-spotlight" style="display:none;"></div>
  <div id="tutorial-tooltip" class="tutorial-tooltip" style="display:none;">
    <div id="tutorial-title" style="font-weight:600;font-size:0.85rem;margin-bottom:0.3rem;"></div>
    <div id="tutorial-text" style="font-size:0.75rem;color:var(--muted);line-height:1.5;margin-bottom:0.6rem;"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span id="tutorial-progress" style="font-size:0.65rem;color:var(--muted);"></span>
      <div style="display:flex;gap:0.3rem;">
        <button class="btn-sm btn-secondary" onclick="endTutorial()" style="font-size:0.65rem;">Skip</button>
        <button class="btn-sm" onclick="nextTutorialStep()" id="tutorial-next-btn" style="font-size:0.65rem;">Next</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API = window.location.origin;

    // -----------------------------------------------------------------------
    // Auth State
    // -----------------------------------------------------------------------
    let authToken = localStorage.getItem('bb_auth_token');
    let currentUser = null;

    function getAuthHeaders() {
      if (!authToken) return {};
      return { 'Authorization': 'Bearer ' + authToken };
    }

    // Safe JSON fetch â€” handles non-JSON error responses (e.g. Vercel 500 HTML pages)
    async function apiFetch(url, options = {}) {
      // Auto-add auth header
      options.headers = { ...getAuthHeaders(), ...(options.headers || {}) };
      const res = await fetch(url, options);
      const ct = (res.headers.get('content-type') || '');

      // Handle 401 â€” redirect to login
      if (res.status === 401) {
        authToken = null;
        localStorage.removeItem('bb_auth_token');
        showAuthPage();
        throw new Error('Session expired. Please log in again.');
      }

      if (res.status === 403) {
        if (ct.includes('application/json')) {
          const d = await res.json();
          throw new Error(d.detail || 'Insufficient permissions');
        }
        throw new Error('Access denied. You do not have permission for this action.');
      }

      if (!res.ok) {
        if (ct.includes('application/json')) {
          const d = await res.json();
          throw new Error(d.detail || d.error || 'Server error ' + res.status);
        }
        throw new Error('Server error (' + res.status + ')');
      }
      if (ct.includes('application/json')) return res.json();
      // Some endpoints return JSON without proper content-type
      const text = await res.text();
      try { return JSON.parse(text); } catch (_) {
        throw new Error('Invalid response from server');
      }
    }

    // -----------------------------------------------------------------------
    // Auth UI
    // -----------------------------------------------------------------------
    function showAuthPage() {
      document.getElementById('auth-page').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
    }

    function showMainApp() {
      document.getElementById('auth-page').style.display = 'none';
      document.getElementById('main-app').style.display = '';
      updateUserDisplay();
    }

    function showLogin() {
      document.getElementById('auth-login').style.display = '';
      document.getElementById('auth-register').style.display = 'none';
    }

    function showRegister() {
      document.getElementById('auth-login').style.display = 'none';
      document.getElementById('auth-register').style.display = '';
    }

    function skipAuth() {
      showMainApp();
    }

    async function doLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const errEl = document.getElementById('login-error');
      errEl.style.display = 'none';

      if (!email || !password) { errEl.textContent = 'Please fill in all fields'; errEl.style.display = ''; return; }

      try {
        const data = await fetch(API + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const result = await data.json();
        if (!data.ok) { errEl.textContent = result.detail || 'Login failed'; errEl.style.display = ''; return; }

        authToken = result.token;
        currentUser = result.user;
        localStorage.setItem('bb_auth_token', authToken);
        showMainApp();
        applyRolePermissions();
      } catch (e) {
        errEl.textContent = e.message; errEl.style.display = '';
      }
    }

    async function doRegister() {
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      const errEl = document.getElementById('reg-error');
      errEl.style.display = 'none';

      if (!name || !email || !password) { errEl.textContent = 'Please fill in all fields'; errEl.style.display = ''; return; }
      if (password.length < 6) { errEl.textContent = 'Password must be at least 6 characters'; errEl.style.display = ''; return; }

      try {
        const data = await fetch(API + '/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password }),
        });
        const result = await data.json();
        if (!data.ok) { errEl.textContent = result.detail || 'Registration failed'; errEl.style.display = ''; return; }

        authToken = result.token;
        currentUser = result.user;
        localStorage.setItem('bb_auth_token', authToken);
        showMainApp();
        applyRolePermissions();
      } catch (e) {
        errEl.textContent = e.message; errEl.style.display = '';
      }
    }

    function doLogout() {
      authToken = null;
      currentUser = null;
      localStorage.removeItem('bb_auth_token');
      showAuthPage();
    }

    function updateUserDisplay() {
      const nameEl = document.getElementById('user-name-display');
      const planBadge = document.getElementById('user-plan-badge');
      const logoutBtn = document.getElementById('logout-btn');

      if (currentUser) {
        nameEl.textContent = currentUser.name + ' (' + currentUser.role + ')';
        logoutBtn.style.display = '';

        const planColors = { free: 'var(--muted)', basic: 'var(--green)', pro: 'var(--accent)', enterprise: 'var(--yellow)' };
        planBadge.textContent = currentUser.plan;
        planBadge.style.background = (planColors[currentUser.plan] || 'var(--muted)') + '20';
        planBadge.style.color = planColors[currentUser.plan] || 'var(--muted)';
        planBadge.style.display = '';
      } else {
        nameEl.textContent = '';
        planBadge.style.display = 'none';
        logoutBtn.style.display = 'none';
      }
    }

    // Role-based permissions matrix
    const ROLE_PERMISSIONS = {
      owner: ['setup', 'upload', 'delete_data', 'analyze', 'feed', 'feed_actions', 'reports', 'deploy', 'alerts', 'whatif', 'users', 'sources'],
      admin: ['setup', 'upload', 'delete_data', 'analyze', 'feed', 'feed_actions', 'reports', 'deploy', 'alerts', 'whatif', 'users', 'sources'],
      manager: ['upload', 'analyze', 'feed', 'feed_actions', 'reports', 'deploy', 'alerts', 'whatif'],
      operator: ['analyze', 'feed', 'reports'],
      viewer: ['feed', 'reports'],
    };

    function applyRolePermissions() {
      if (!currentUser) return;
      const perms = ROLE_PERMISSIONS[currentUser.role] || ROLE_PERMISSIONS.viewer;

      // Tab visibility
      const tabMapping = {
        'setup': ['setup'],
        'analyze': ['analyze'],
        'feed': ['feed'],
        'reports': ['reports'],
        'alerts': ['alerts'],
        'whatif': ['whatif'],
        'sources': ['data'],
        'users': ['users'],
      };

      document.querySelectorAll('.tab, .tab-menu-item').forEach(tab => {
        const panel = tab.dataset.panel;
        // Find which permission controls this tab
        let allowed = true;
        for (const [perm, panels] of Object.entries(tabMapping)) {
          if (panels.includes(panel) && !perms.includes(perm)) {
            allowed = false;
            break;
          }
        }
        if (!allowed) {
          tab.classList.add('locked-tab');
          tab.title = 'Requires higher access level';
        } else {
          tab.classList.remove('locked-tab');
          tab.title = '';
        }
      });
    }

    // Check auth on page load
    async function checkAuth() {
      if (authToken) {
        try {
          const data = await apiFetch(API + '/auth/me');
          if (data.authenticated) {
            currentUser = data.user;
            showMainApp();
            applyRolePermissions();
            return;
          }
        } catch (e) { /* Token expired or invalid */ }
      }
      // No valid token â€” show login (but allow skip)
      showAuthPage();
    }

    // -----------------------------------------------------------------------
    // Users / Access Management Panel
    // -----------------------------------------------------------------------

    function switchUsersSub(subId) {
      document.querySelectorAll('#users .sub-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('#users-sub-nav .sub-nav-pill').forEach(b => b.classList.remove('active'));
      const target = document.getElementById(subId);
      if (target) target.classList.add('active');
      const btn = document.querySelector(`#users-sub-nav [data-sub="${subId}"]`);
      if (btn) btn.classList.add('active');
      if (subId === 'users-list') loadUsersList();
      if (subId === 'users-pending') loadPendingInvites();
    }

    async function loadUsersList() {
      const body = document.getElementById('users-list-body');
      if (!currentUser || !['admin','owner'].includes(currentUser.role)) {
        body.innerHTML = '<div class="feed-empty">Admin or owner access required to view team members.</div>';
        return;
      }
      body.innerHTML = '<div class="feed-empty"><span class="spinner"></span> Loading team members...</div>';
      try {
        const users = await apiFetch(API + '/users');
        if (!users.length) {
          body.innerHTML = '<div class="feed-empty">No users found.</div>';
          return;
        }
        const myId = currentUser ? currentUser.id : null;
        body.innerHTML = users.map(u => {
          const isOwner = u.role === 'owner';
          const isSelf = u.id === myId;
          const roleOptions = ['viewer','operator','manager','admin','owner'].map(r =>
            `<option value="${r}" ${r === u.role ? 'selected' : ''}>${r}</option>`
          ).join('');
          return `
            <div class="meta-card" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
              <div style="flex:1;min-width:200px;">
                <strong>${esc(u.name)}</strong>${isSelf ? ' <span style="color:var(--accent);font-size:0.68rem;">(you)</span>' : ''}
                <span style="color:var(--muted);font-size:0.72rem;margin-left:0.3rem;">${esc(u.email)}</span>
                ${!u.is_active ? '<span style="color:var(--red);font-size:0.68rem;margin-left:0.3rem;">INACTIVE</span>' : ''}
                <div style="font-size:0.68rem;color:var(--muted);margin-top:0.15rem;">
                  Joined: ${u.created_at ? new Date(u.created_at).toLocaleDateString() : 'N/A'}
                  &middot; Last login: ${u.last_login_at ? new Date(u.last_login_at).toLocaleDateString() : 'Never'}
                  &middot; Uploads: ${u.upload_count || 0}
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:0.4rem;flex-shrink:0;">
                <span class="plan-badge" style="font-size:0.62rem;padding:0.1rem 0.4rem;">${esc(u.plan)}</span>
                <select class="role-select" style="font-size:0.72rem;padding:0.2rem 0.3rem;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:4px;"
                  onchange="changeUserRole('${u.id}', this.value, this)"
                  ${isOwner || isSelf ? 'disabled' : ''}>
                  ${roleOptions}
                </select>
                ${!isSelf && !isOwner && u.is_active ? `<button class="btn-sm" style="background:var(--red);color:#fff;font-size:0.65rem;" onclick="deactivateUser('${u.id}', '${esc(u.name)}')">Deactivate</button>` : ''}
              </div>
            </div>`;
        }).join('');
      } catch (e) {
        body.innerHTML = `<div class="feed-empty" style="color:var(--red);">${e.message}</div>`;
      }
    }

    async function changeUserRole(userId, newRole, selectEl) {
      try {
        await apiFetch(API + `/users/${userId}/role`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: newRole }),
        });
        toast('Role updated to ' + newRole);
      } catch (e) {
        toast('Failed: ' + e.message);
        loadUsersList(); // reload to reset dropdown
      }
    }

    async function deactivateUser(userId, userName) {
      if (!confirm(`Deactivate user "${userName}"? They will lose access immediately.`)) return;
      try {
        await apiFetch(API + `/users/${userId}`, { method: 'DELETE' });
        toast(userName + ' has been deactivated');
        loadUsersList();
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    }

    async function sendInvite() {
      const email = document.getElementById('invite-email').value.trim();
      const role = document.getElementById('invite-role').value;
      const plan = document.getElementById('invite-plan').value;
      if (!email) { toast('Email is required'); return; }
      try {
        const result = await apiFetch(API + '/auth/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, role, plan }),
        });
        const resultDiv = document.getElementById('invite-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div style="background:var(--surface);border:1px solid var(--green);border-radius:8px;padding:0.7rem;">
            <strong>Invite created!</strong><br>
            <span style="font-size:0.72rem;">Share this token with <strong>${esc(email)}</strong> so they can register:</span>
            <div style="margin-top:0.4rem;padding:0.4rem;background:var(--bg);border-radius:4px;font-family:monospace;font-size:0.68rem;word-break:break-all;user-select:all;">${esc(result.token)}</div>
            <span style="font-size:0.62rem;color:var(--muted);">Expires in 7 days. Role: ${esc(role)} &middot; Plan: ${esc(plan)}</span>
          </div>`;
        document.getElementById('invite-email').value = '';
      } catch (e) {
        toast('Invite failed: ' + e.message);
      }
    }

    async function loadPendingInvites() {
      const body = document.getElementById('pending-invites-body');
      if (!currentUser || !['admin','owner'].includes(currentUser.role)) {
        body.innerHTML = '<div class="feed-empty">Admin or owner access required to view invites.</div>';
        return;
      }
      body.innerHTML = '<div class="feed-empty"><span class="spinner"></span> Loading pending invites...</div>';
      try {
        const invites = await apiFetch(API + '/auth/invites');
        if (!invites.length) {
          body.innerHTML = '<div class="feed-empty">No pending invites.</div>';
          return;
        }
        body.innerHTML = invites.map(inv => {
          const isExpired = inv.expired;
          return `
            <div class="meta-card" style="display:flex;justify-content:space-between;align-items:center;opacity:${isExpired ? '0.5' : '1'};">
              <div>
                <strong>${esc(inv.email)}</strong>
                <span style="color:var(--muted);font-size:0.72rem;margin-left:0.3rem;">Role: ${esc(inv.role)} &middot; Plan: ${esc(inv.plan)}</span>
                ${isExpired ? '<span style="color:var(--red);font-size:0.68rem;margin-left:0.3rem;">EXPIRED</span>' : ''}
                <div style="font-size:0.62rem;color:var(--muted);margin-top:0.1rem;font-family:monospace;word-break:break-all;">Token: ${esc(inv.token)}</div>
                <div style="font-size:0.62rem;color:var(--muted);">Expires: ${inv.expires_at ? new Date(inv.expires_at).toLocaleString() : 'N/A'}</div>
              </div>
              <button class="btn-sm" style="background:var(--red);color:#fff;font-size:0.65rem;" onclick="revokeInvite('${inv.id}')">Revoke</button>
            </div>`;
        }).join('');
      } catch (e) {
        body.innerHTML = `<div class="feed-empty" style="color:var(--red);">${e.message}</div>`;
      }
    }

    async function revokeInvite(inviteId) {
      if (!confirm('Revoke this invite?')) return;
      try {
        await apiFetch(API + `/auth/invites/${inviteId}`, { method: 'DELETE' });
        toast('Invite revoked');
        loadPendingInvites();
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    }

    // Wire Users tab auto-load
    document.querySelector('[data-panel="users"]')?.addEventListener('click', () => {
      loadUsersList();
    });

    // -----------------------------------------------------------------------
    // Free Tier â€” Plan Gating
    // -----------------------------------------------------------------------
    let planLimits = null;

    async function loadPlanLimits() {
      try {
        const data = await apiFetch(API + '/plan/limits');
        planLimits = data;
        applyPlanGating();
      } catch (e) { /* Plan limits optional â€” full access if endpoint fails */ }
    }

    function applyPlanGating() {
      if (!planLimits || !currentUser) return;
      const limits = planLimits.limits;
      const plan = planLimits.plan;

      if (plan === 'pro' || plan === 'enterprise') return; // Full access

      // Show plan badge in header with upload count
      const planBadge = document.getElementById('user-plan-badge');
      if (planBadge && plan === 'free') {
        planBadge.textContent = `Free Plan â€¢ ${planLimits.upload_count || 0}/${limits.max_uploads} uploads`;
      }

      // Lock tabs based on plan
      const lockedFeatures = [];
      if (!limits.setup) lockedFeatures.push('setup');
      if (!limits.whatif) lockedFeatures.push('whatif');
      if (!limits.alerts) lockedFeatures.push('alerts');
      if (!limits.reports) lockedFeatures.push('reports');

      document.querySelectorAll('.tab, .tab-menu-item').forEach(tab => {
        const panel = tab.dataset.panel;
        if (lockedFeatures.includes(panel)) {
          tab.classList.add('locked-tab');
          tab.title = `Requires upgrade from ${plan} plan`;
          // Override click to show upgrade modal
          tab.addEventListener('click', (e) => {
            if (tab.classList.contains('locked-tab')) {
              e.stopImmediatePropagation();
              showUpgradeModal(panel);
            }
          }, true);
        }
      });
    }

    function showUpgradeModal(feature) {
      const featureNames = {
        setup: 'Setup & Configuration',
        whatif: 'What-If Scenarios',
        alerts: 'Alerts',
        reports: 'Reports',
        deploy: 'Deploy Reports',
        export: 'Data Export',
        sources: 'Data Sources',
      };
      const nameEl = document.getElementById('upgrade-feature-name');
      if (nameEl) nameEl.textContent = `${featureNames[feature] || feature} requires an upgrade`;
      document.getElementById('upgrade-modal').classList.add('active');
    }

    // Run auth check on load
    checkAuth();
    // Load plan limits after auth
    setTimeout(loadPlanLimits, 1000);

    // Session management
    let sessionId = localStorage.getItem('bb_session_id');
    if (!sessionId) {
      sessionId = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2);
      localStorage.setItem('bb_session_id', sessionId);
    }

    const chatMessages = [];
    let lastAnalysisData = null;
    let activeCharts = [];

    // Drill-down navigation stack
    // Each entry: { question, data, finding (null for root) }
    let analysisStack = [];

    function updateSessionLabel() {
      document.getElementById('session-label').textContent = `Session: ${sessionId.slice(0, 8)}...`;
    }
    updateSessionLabel();

    function newChat() {
      sessionId = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2);
      localStorage.setItem('bb_session_id', sessionId);
      chatMessages.length = 0;
      analysisStack = [];
      destroyCharts();
      document.getElementById('chat-thread').style.display = 'none';
      document.getElementById('chat-thread').innerHTML = '';
      document.getElementById('analyze-body').innerHTML = '';
      document.getElementById('analyze-status').innerHTML = '';
      updateSessionLabel();
      toast('New chat started');
    }

    // Tabs â€” primary bar + "More" dropdown
    function switchToPanel(panelId, source) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-menu-item').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.getElementById(panelId).classList.add('active');
      if (source) source.classList.add('active');
      // Highlight "More" button when a dropdown panel is active
      const moreBtn = document.getElementById('tab-more-btn');
      const isDropdownPanel = !!document.querySelector(`.tab-menu-item[data-panel="${panelId}"]`);
      moreBtn.classList.toggle('has-active', isDropdownPanel);
    }

    document.querySelectorAll('.tabs > .tab').forEach(tab => {
      tab.addEventListener('click', () => switchToPanel(tab.dataset.panel, tab));
    });

    // "More" dropdown toggle
    const moreBtn = document.getElementById('tab-more-btn');
    const moreMenu = document.getElementById('tab-more-menu');
    moreBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      moreMenu.classList.toggle('open');
    });
    document.addEventListener('click', () => moreMenu.classList.remove('open'));

    document.querySelectorAll('.tab-menu-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        switchToPanel(item.dataset.panel, item);
        moreMenu.classList.remove('open');
      });
    });

    // Sub-navigation pills (for Data and Setup tabs)
    document.querySelectorAll('.sub-nav').forEach(nav => {
      nav.querySelectorAll('.sub-nav-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          const parentPanel = nav.closest('.panel');
          parentPanel.querySelectorAll('.sub-nav-pill').forEach(p => p.classList.remove('active'));
          parentPanel.querySelectorAll('.sub-panel').forEach(sp => sp.classList.remove('active'));
          pill.classList.add('active');
          document.getElementById(pill.dataset.sub).classList.add('active');

          // Auto-load content when switching sub-panels
          const sub = pill.dataset.sub;
          if (sub === 'data-tables') loadSchemaIntoData();
          if (sub === 'data-sources') loadSourcesIntoData();
          if (sub === 'data-quality') loadDataQualityIntoData();
          if (sub === 'setup-process') loadProcessSteps();
          if (sub === 'setup-metrics') loadThresholds();
          if (sub === 'setup-io') loadProcessIO();
          if (sub === 'setup-context') loadContextEntries();
        });
      });
    });

    // -----------------------------------------------------------------------
    // Setup Dashboard â€” Card Navigation
    // -----------------------------------------------------------------------
    let currentSetupStep = 0;
    const setupStepIds = ['setup-profile', 'setup-process', 'setup-metrics', 'setup-io', 'setup-context', 'setup-suggestions'];
    const setupCardMap = {
      'profile': { panelId: 'setup-profile', loader: null },
      'process': { panelId: 'setup-process', loader: loadProcessSteps },
      'metrics': { panelId: 'setup-metrics', loader: loadThresholds },
      'io': { panelId: 'setup-io', loader: loadProcessIO },
      'context': { panelId: 'setup-context', loader: loadContextEntries },
      'suggestions': { panelId: 'setup-suggestions', loader: null },
    };
    const setupStepLoaders = [null, loadProcessSteps, loadThresholds, loadProcessIO, loadContextEntries, null];
    let activeSetupCard = null;

    function toggleSetupCard(cardName) {
      const info = setupCardMap[cardName];
      if (!info) return;
      const panel = document.getElementById(info.panelId);
      if (!panel) return;

      // If already open, close it
      if (activeSetupCard === cardName) {
        collapseSetupCard(cardName);
        return;
      }

      // Close any open card
      setupStepIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
      });

      // Open this card's panel
      panel.classList.add('active');
      activeSetupCard = cardName;

      // Highlight the card
      document.querySelectorAll('.setup-card').forEach(c => c.classList.remove('setup-card-active'));
      const card = document.querySelector(`.setup-card[data-card="${cardName}"]`);
      if (card) card.classList.add('setup-card-active');

      // Load content
      if (info.loader) info.loader();

      // Scroll to panel
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function collapseSetupCard(cardName) {
      const info = setupCardMap[cardName];
      if (!info) return;
      const panel = document.getElementById(info.panelId);
      if (panel) panel.classList.remove('active');
      activeSetupCard = null;
      document.querySelectorAll('.setup-card').forEach(c => c.classList.remove('setup-card-active'));
      updateSetupCardSummaries();
    }

    function goToSetupStep(stepIndex) {
      // Legacy function â€” map to card-based navigation
      const cardNames = ['profile', 'process', 'metrics', 'io', 'context', 'suggestions'];
      if (stepIndex >= 0 && stepIndex < cardNames.length) {
        toggleSetupCard(cardNames[stepIndex]);
      }
    }

    // -----------------------------------------------------------------------
    // Setup Dashboard â€” Progress & Card Summaries
    // -----------------------------------------------------------------------
    function updateSetupChecklist() {
      const checks = {
        'profile': !!(document.getElementById('ob-name')?.value.trim() && document.getElementById('ob-industry')?.value),
        'process': !!(document.getElementById('process-steps-body')?.querySelector('table')),
        'metrics': !!(document.getElementById('thresholds-body') && !document.getElementById('thresholds-body').querySelector('.feed-empty')),
        'io': !!(document.getElementById('process-io-body')?.querySelector('table')),
        'context': !!(document.getElementById('context-entries-body') && !document.getElementById('context-entries-body').querySelector('.feed-empty') && document.getElementById('context-entries-body').textContent.trim() !== 'Loading context entries...'),
      };

      let completed = 0;
      const total = Object.keys(checks).length;
      for (const [card, done] of Object.entries(checks)) {
        const iconEl = document.getElementById(`card-icon-${card}`);
        if (iconEl) iconEl.innerHTML = done ? '&#10003;' : '&#9675;';
        const cardEl = document.querySelector(`.setup-card[data-card="${card}"]`);
        if (cardEl) {
          cardEl.classList.toggle('setup-card-done', !!done);
        }
        if (done) completed++;
      }

      const pct = Math.round((completed / total) * 100);
      const compEl = document.getElementById('setup-completeness');
      if (compEl) compEl.textContent = pct + '%';
      const progEl = document.getElementById('setup-progress');
      if (progEl) progEl.style.width = pct + '%';

      updateSetupCardSummaries();
    }

    function updateSetupCardSummaries() {
      // Profile
      const name = document.getElementById('ob-name')?.value.trim();
      const industry = document.getElementById('ob-industry')?.value;
      const profileSum = document.getElementById('card-summary-profile');
      if (profileSum) {
        if (name && industry) profileSum.textContent = `${name} (${industry})`;
        else if (name) profileSum.textContent = name;
        else profileSum.textContent = 'Not configured';
      }

      // Process
      const stepBody = document.getElementById('process-steps-body');
      const processSum = document.getElementById('card-summary-process');
      if (processSum) {
        const rows = stepBody?.querySelectorAll('table tr');
        const stepCount = rows ? Math.max(0, rows.length - 1) : 0;
        processSum.textContent = stepCount > 0 ? `${stepCount} step${stepCount > 1 ? 's' : ''} defined` : 'No steps defined';
      }

      // Metrics
      const thBody = document.getElementById('thresholds-body');
      const metricsSum = document.getElementById('card-summary-metrics');
      if (metricsSum) {
        const hasMetrics = thBody && !thBody.querySelector('.feed-empty');
        const metricCards = thBody?.querySelectorAll('.threshold-card, .metric-card');
        const count = metricCards?.length || 0;
        metricsSum.textContent = hasMetrics ? `${count} metric${count !== 1 ? 's' : ''} configured` : 'No metrics configured';
      }

      // I/O
      const ioBody = document.getElementById('process-io-body');
      const ioSum = document.getElementById('card-summary-io');
      if (ioSum) {
        const hasIO = ioBody && ioBody.querySelector('table');
        if (hasIO) {
          const inputCount = ioBody.querySelectorAll('table:first-of-type tr').length - 1;
          ioSum.textContent = `${Math.max(0, inputCount)} entries configured`;
        } else {
          ioSum.textContent = 'Not configured';
        }
      }

      // Context
      const ctxBody = document.getElementById('context-entries-body');
      const ctxSum = document.getElementById('card-summary-context');
      if (ctxSum) {
        const hasCtx = ctxBody && !ctxBody.querySelector('.feed-empty') && ctxBody.textContent.trim() !== 'Loading context entries...';
        ctxSum.textContent = hasCtx ? 'Context added' : 'No context added';
      }
    }

    function toggleChecklist() {
      // Legacy â€” no-op in card dashboard
    }

    // -----------------------------------------------------------------------
    // Setup Wizard â€” Industry Template
    // -----------------------------------------------------------------------
    let templateBannerDismissed = false;

    function onIndustryChange() {
      const industry = document.getElementById('ob-industry')?.value;
      const banner = document.getElementById('template-banner');
      const nameEl = document.getElementById('template-industry-name');
      if (!banner) return;

      if (industry && industry !== 'other' && !templateBannerDismissed) {
        const names = { steel: 'Steel Manufacturing', cement: 'Cement Manufacturing', textile: 'Textile Manufacturing', pharma: 'Pharmaceutical Manufacturing', auto: 'Automotive Manufacturing', food: 'Food Processing' };
        if (nameEl) nameEl.textContent = names[industry] || (industry.charAt(0).toUpperCase() + industry.slice(1)) + ' Manufacturing';
        banner.style.display = 'flex';
      } else {
        banner.style.display = 'none';
      }
    }

    async function applyIndustryTemplate() {
      const industry = document.getElementById('ob-industry')?.value;
      if (!industry) return toast('Select an industry first');

      const banner = document.getElementById('template-banner');
      const applyBtn = banner?.querySelector('.btn-sm');
      if (applyBtn) { applyBtn.disabled = true; applyBtn.textContent = 'Applying...'; }

      try {
        const data = await apiFetch(API + '/setup/apply-template/' + encodeURIComponent(industry), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId }),
        });

        if (data.error) {
          toast('Error: ' + data.error);
          if (applyBtn) { applyBtn.disabled = false; applyBtn.textContent = 'Apply Template'; }
          return;
        }

        toast(`Template applied: ${data.process_steps_created} steps, ${data.metrics_created} metrics, ${data.ios_created} I/O`);
        if (banner) banner.style.display = 'none';
        templateBannerDismissed = true;

        // Reload all setup sub-panels
        loadProcessSteps();
        loadThresholds();
        loadProcessIO();
        updateSetupChecklist();
        markFeedDirty();
      } catch (e) {
        toast('Failed to apply template: ' + e.message);
        if (applyBtn) { applyBtn.disabled = false; applyBtn.textContent = 'Apply Template'; }
      }
    }

    function dismissTemplateBanner() {
      const banner = document.getElementById('template-banner');
      if (banner) banner.style.display = 'none';
      templateBannerDismissed = true;
    }

    // -----------------------------------------------------------------------
    // Setup Dashboard â€” Metric Tags Input
    // -----------------------------------------------------------------------
    let currentMetricTags = [];
    let currentMetricRanges = {};

    function addMetricTag(value) {
      const input = document.getElementById('ps-metric-input');
      const val = (value || input?.value || '').trim();
      if (!val || currentMetricTags.includes(val)) { if (input) input.value = ''; return; }
      currentMetricTags.push(val);
      renderMetricTags();
      if (input) { input.value = ''; input.focus(); }
    }

    function removeMetricTag(idx) {
      currentMetricTags.splice(idx, 1);
      renderMetricTags();
    }

    function renderMetricTags() {
      const container = document.getElementById('ps-metrics-tags');
      if (!container) return;
      const input = container.querySelector('input');
      // Remove old tags
      container.querySelectorAll('.metric-tag').forEach(t => t.remove());
      // Add tags before input
      currentMetricTags.forEach((tag, i) => {
        const el = document.createElement('span');
        el.className = 'metric-tag';
        el.innerHTML = `${tag} <span class="metric-tag-remove" onclick="event.stopPropagation();removeMetricTag(${i})">&times;</span>`;
        container.insertBefore(el, input);
      });
      // Sync hidden field
      const hidden = document.getElementById('ps-metric');
      if (hidden) hidden.value = currentMetricTags[0] || '';
      // Re-render per-metric range inputs
      renderMetricRanges();
    }

    function renderMetricRanges() {
      const container = document.getElementById('ps-ranges-list');
      if (!container) return;
      if (currentMetricTags.length === 0) {
        container.innerHTML = '<input type="text" id="ps-range" placeholder="e.g., 500-625 kWh/ton" />';
        return;
      }
      container.innerHTML = currentMetricTags.map(tag => {
        const safeTag = tag.replace(/'/g, "\\'");
        return `<div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.3rem;">
          <span style="min-width:120px;font-size:0.72rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${esc(tag)}">${esc(tag)}:</span>
          <input type="text" class="metric-range-input" data-metric="${esc(tag)}"
            placeholder="e.g., 85-95%" value="${esc(currentMetricRanges[tag] || '')}"
            oninput="currentMetricRanges['${safeTag}']=this.value"
            style="flex:1;" />
        </div>`;
      }).join('');
    }

    // -----------------------------------------------------------------------
    // Setup Dashboard â€” Process Step Modal
    // -----------------------------------------------------------------------
    function openProcessStepModal(editId) {
      // Reset form
      document.getElementById('ps-name').value = '';
      document.getElementById('ps-inputs').value = '';
      document.getElementById('ps-outputs').value = '';
      document.getElementById('ps-metric').value = '';
      document.getElementById('ps-range').value = '';
      document.getElementById('ps-table').value = '';
      document.getElementById('ps-order').value = '1';
      document.getElementById('ps-edit-id').value = editId || '';
      currentMetricTags = [];
      currentMetricRanges = {};
      renderMetricTags();

      if (editId) {
        // Pre-fill from existing step
        _prefillProcessStepModal(editId);
      } else {
        // Auto-set step order to next available
        const rows = document.getElementById('process-steps-body')?.querySelectorAll('tr');
        if (rows && rows.length > 1) {
          document.getElementById('ps-order').value = rows.length;
        }
      }
      document.getElementById('process-step-modal').style.display = 'flex';
      document.getElementById('ps-name').focus();
    }

    async function _prefillProcessStepModal(editId) {
      try {
        const res = await fetch('/process-steps');
        const steps = await res.json();
        const step = steps.find(s => s.id === editId);
        if (!step) return;
        document.getElementById('ps-name').value = step.process_name || '';
        document.getElementById('ps-inputs').value = step.inputs || '';
        document.getElementById('ps-outputs').value = step.outputs || '';
        document.getElementById('ps-table').value = step.linked_table || '';
        document.getElementById('ps-order').value = step.step_order || 1;
        // Multi-metric: use key_metrics array if available, fallback to key_metric
        currentMetricTags = [];
        if (step.key_metrics && step.key_metrics.length) {
          currentMetricTags = [...step.key_metrics];
        } else if (step.key_metric) {
          currentMetricTags = [step.key_metric];
        }
        // Per-metric ranges
        currentMetricRanges = step.target_ranges || {};
        // Backward compat: if no target_ranges but has single target_range, map to first metric
        if (!Object.keys(currentMetricRanges).length && step.target_range && currentMetricTags.length) {
          currentMetricRanges = { [currentMetricTags[0]]: step.target_range };
        }
        renderMetricTags();
      } catch (e) { /* ignore */ }
    }

    async function submitProcessStep() {
      const name = document.getElementById('ps-name').value.trim();
      if (!name) return toast('Process name is required');

      // Build target_ranges from per-metric range inputs, or fallback to single range
      const singleRange = document.getElementById('ps-range')?.value?.trim() || '';
      const targetRanges = Object.keys(currentMetricRanges).length ? { ...currentMetricRanges } : {};
      // If single range input was used (no per-metric inputs) and we have metrics, map it
      if (singleRange && !Object.keys(targetRanges).length && currentMetricTags.length) {
        targetRanges[currentMetricTags[0]] = singleRange;
      }

      const payload = {
        process_name: name,
        inputs: document.getElementById('ps-inputs').value.trim(),
        outputs: document.getElementById('ps-outputs').value.trim(),
        key_metric: currentMetricTags[0] || '',
        key_metrics: currentMetricTags.length ? currentMetricTags : [],
        target_range: singleRange || (currentMetricTags.length ? (currentMetricRanges[currentMetricTags[0]] || '') : ''),
        target_ranges: targetRanges,
        linked_table: document.getElementById('ps-table').value.trim(),
        step_order: parseInt(document.getElementById('ps-order').value) || 1,
      };

      const editId = document.getElementById('ps-edit-id').value;

      try {
        if (editId) {
          await apiFetch(`/process-steps/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          toast('Step updated');
        } else {
          await apiFetch('/process-steps', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          toast('Step added');
        }
        document.getElementById('process-step-modal').style.display = 'none';
        loadProcessSteps();
        updateSetupChecklist();

        // Green glow effect on the newly added row
        setTimeout(() => {
          const table = document.getElementById('process-steps-body')?.querySelector('table');
          if (table) {
            const rows = table.querySelectorAll('tr');
            const lastRow = rows[rows.length - 1];
            if (lastRow && !editId) {
              lastRow.classList.add('added-glow');
              setTimeout(() => lastRow.classList.remove('added-glow'), 3500);
            }
          }
        }, 300);
      } catch (e) {
        toast('Failed to save step: ' + e.message);
      }
    }

    // -----------------------------------------------------------------------
    // Setup Wizard â€” Process I/O Modal (replaces browser prompt)
    // -----------------------------------------------------------------------
    function openIOModal(ioType) {
      document.getElementById('io-type').value = ioType || 'input';
      document.getElementById('io-modal-title').childNodes[0].textContent = ioType === 'output' ? 'Add Output ' : 'Add Input ';
      const srcLabel = document.getElementById('io-src-label');
      if (srcLabel) srcLabel.textContent = ioType === 'output' ? 'Destination' : 'Source';
      document.getElementById('io-src').placeholder = ioType === 'output' ? 'e.g., Dealers, builders, fabricators' : 'e.g., Scrap dealers, importers';

      // Reset form
      document.getElementById('io-name').value = '';
      document.getElementById('io-src').value = '';
      document.getElementById('io-unit').value = '';
      document.getElementById('io-range').value = '';
      document.getElementById('io-table').value = '';

      document.getElementById('process-io-modal').style.display = 'flex';
      document.getElementById('io-name').focus();
    }

    async function submitProcessIO() {
      const name = document.getElementById('io-name').value.trim();
      if (!name) return toast('Name is required');

      const ioType = document.getElementById('io-type').value;
      const payload = {
        io_type: ioType,
        name,
        source_or_destination: document.getElementById('io-src').value.trim(),
        unit: document.getElementById('io-unit').value.trim(),
        typical_range: document.getElementById('io-range').value.trim(),
        linked_table: document.getElementById('io-table').value.trim(),
      };

      try {
        await apiFetch('/process-io', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        toast(`${ioType.charAt(0).toUpperCase() + ioType.slice(1)} added`);
        document.getElementById('process-io-modal').style.display = 'none';
        loadProcessIO();
        updateSetupChecklist();

        // Green glow on new entry
        setTimeout(() => {
          const body = document.getElementById('process-io-body');
          if (body) {
            const tables = body.querySelectorAll('table');
            const lastTable = tables[tables.length - 1];
            if (lastTable) {
              const rows = lastTable.querySelectorAll('tr');
              const lastRow = rows[rows.length - 1];
              if (lastRow) {
                lastRow.classList.add('added-glow');
                setTimeout(() => lastRow.classList.remove('added-glow'), 3500);
              }
            }
          }
        }, 300);
      } catch (e) {
        toast('Failed to save: ' + e.message);
      }
    }

    // Load Data tab sub-content (wiring to existing functions where possible)
    async function loadSchemaIntoData() {
      const body = document.getElementById('data-schema-body');
      const existingSchema = document.getElementById('schema-body');
      if (existingSchema && existingSchema.innerHTML.trim() &&
          !existingSchema.innerHTML.includes('No metadata found')) {
        body.innerHTML = existingSchema.innerHTML;
      } else {
        body.innerHTML = '<div class="feed-empty"><span class="spinner"></span> Loading schema data...</div>';
        await loadSchema();
        // After loadSchema completes, copy the freshly loaded content
        if (existingSchema) {
          body.innerHTML = existingSchema.innerHTML;
        }
      }
    }

    function loadSourcesIntoData() {
      const body = document.getElementById('data-sources-body');
      const existingSources = document.getElementById('sources-body');
      if (existingSources && existingSources.innerHTML.trim()) {
        body.innerHTML = existingSources.innerHTML;
      }
    }

    function loadDataQualityIntoData() {
      const body = document.getElementById('data-quality-body');
      const existingQuality = document.getElementById('quality-body');
      if (existingQuality && existingQuality.innerHTML.trim()) {
        body.innerHTML = existingQuality.innerHTML;
      } else {
        if (typeof loadDataQuality === 'function') loadDataQuality();
      }
    }

    // Auto-load Data tab schema on first visit
    document.querySelector('[data-panel="data"]')?.addEventListener('click', () => {
      loadSchemaIntoData();
    });

    // Auto-load Setup tab content on first visit
    document.querySelector('[data-panel="setup"]')?.addEventListener('click', () => {
      if (typeof loadOnboarding === 'function') loadOnboarding();
      setTimeout(() => updateSetupChecklist(), 500);
    });

    // ---- Context Entries Management ----
    async function loadContextEntries() {
      const body = document.getElementById('context-entries-body');
      try {
        const res = await fetch('/context/entries');
        const data = await res.json();
        if (!data.sources || data.total === 0) {
          body.innerHTML = '<div class="feed-empty" style="padding:0.8rem;">No context entries yet. Add some from the form above or they will be auto-generated from your company profile and data uploads.</div>';
          return;
        }
        let html = '';
        for (const [source, entries] of Object.entries(data.sources)) {
          const icon = source.startsWith('onboarding') ? 'ðŸ“‹' :
                       source.startsWith('upload') ? 'ðŸ“„' :
                       source.startsWith('structured') ? 'ðŸ­' :
                       source === 'manual' ? 'âœï¸' : 'ðŸ“Ž';
          html += `<div style="font-size:0.72rem;font-weight:500;color:var(--muted);margin:0.6rem 0 0.3rem;padding-left:0.2rem;">${icon} ${source} (${entries.length} chunks)</div>`;
          for (const entry of entries) {
            const truncated = entry.content.length > 200 ? entry.content.substring(0, 200) + '...' : entry.content;
            const isEditable = source === 'manual' || source.startsWith('onboarding');
            html += `<div class="ctx-entry">
              <div class="ctx-actions">
                ${isEditable ? `<button onclick="editContextEntry(${entry.id})">Edit</button>` : ''}
                <button onclick="deleteContextEntry(${entry.id})" style="color:#e74c3c;">Delete</button>
              </div>
              <div style="padding-right:5rem;">${truncated}</div>
            </div>`;
          }
        }
        body.innerHTML = html;
        updateSetupChecklist();
      } catch (e) {
        body.innerHTML = '<div class="feed-empty">Failed to load context entries.</div>';
      }
    }

    async function editContextEntry(id) {
      // Find the entry text from the DOM
      const entries = document.querySelectorAll('.ctx-entry');
      let currentText = '';
      for (const entry of entries) {
        const editBtn = entry.querySelector(`button[onclick="editContextEntry(${id})"]`);
        if (editBtn) {
          currentText = entry.querySelector('div[style*="padding-right"]')?.textContent?.trim() || '';
          break;
        }
      }

      // Use the context textarea for inline editing
      const ctxText = document.getElementById('ctx-text');
      if (ctxText) {
        ctxText.value = currentText;
        ctxText.focus();
        ctxText.dataset.editId = id;
        ctxText.placeholder = 'Editing context entry... Press "Update" to save.';
        // Change the submit button temporarily
        const addBtn = ctxText.closest('.context-form')?.querySelector('.btn-sm');
        if (addBtn) {
          addBtn.textContent = 'Update';
          addBtn.onclick = async () => {
            const newContent = ctxText.value.trim();
            if (!newContent) return toast('Enter content');
            try {
              await fetch(`/context/entries/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: newContent})
              });
              toast('Context updated');
              ctxText.value = '';
              ctxText.placeholder = "Enter business context (e.g., 'Enterprise customers generate 80% of our revenue')";
              delete ctxText.dataset.editId;
              addBtn.textContent = 'Add';
              addBtn.onclick = () => submitContext();
              loadContextEntries();
              updateSetupChecklist();
            } catch (e) {
              toast('Failed to update context');
            }
          };
        }
      }
    }

    async function deleteContextEntry(id) {
      if (!confirm('Delete this context entry?')) return;
      try {
        await fetch(`/context/entries/${id}`, {method: 'DELETE'});
        toast('Context deleted');
        loadContextEntries();
      } catch (e) {
        toast('Failed to delete context');
      }
    }

    // ---- Process Steps Management ----
    async function loadProcessSteps() {
      const body = document.getElementById('process-steps-body');
      try {
        const res = await fetch('/process-steps');
        const steps = await res.json();
        if (!steps.length) {
          body.innerHTML = '<div class="feed-empty" style="padding:0.8rem;">No process steps defined yet. Click "+ Add Step" to start mapping your production process.</div>';
          updateSetupChecklist();
          return;
        }
        let html = '<table class="process-table"><tr><th>#</th><th>Process</th><th>Inputs</th><th>Outputs</th><th>Key Metrics</th><th>Target</th><th></th></tr>';
        for (const s of steps) {
          // Display metrics as chips
          const metrics = s.key_metrics && s.key_metrics.length ? s.key_metrics : (s.key_metric ? [s.key_metric] : []);
          const metricChips = metrics.length
            ? metrics.map(m => `<span class="metric-chip">${m}</span>`).join(' ')
            : '<span style="color:var(--muted);">-</span>';
          // Show auto-linked table if present
          const tableInfo = s.linked_table ? `<div class="auto-linked-hint" title="Auto-linked to ${s.linked_table}">&#128279; ${s.linked_table}</div>` : '';
          html += `<tr>
            <td>${s.step_order}</td>
            <td>${s.process_name}${tableInfo}</td>
            <td>${s.inputs || '-'}</td>
            <td>${s.outputs || '-'}</td>
            <td>${metricChips}</td>
            <td>${(() => {
              const ranges = s.target_ranges || {};
              if (Object.keys(ranges).length > 0) {
                return Object.entries(ranges).map(([m, r]) =>
                  `<div style="font-size:0.68rem;"><span style="color:var(--muted);">${m}:</span> ${r}</div>`
                ).join('');
              }
              return s.target_range || '-';
            })()}</td>
            <td style="white-space:nowrap;">
              <button class="btn-sm" onclick="editProcessStep(${s.id})" style="font-size:0.6rem;">Edit</button>
              <button class="btn-sm" onclick="deleteProcessStep(${s.id})" style="font-size:0.6rem;color:#e74c3c;">Del</button>
            </td>
          </tr>`;
        }
        html += '</table>';
        body.innerHTML = html;
        updateSetupChecklist();
      } catch (e) {
        body.innerHTML = '<div class="feed-empty">Failed to load process steps.</div>';
      }
    }

    // showAddProcessStepModal and editProcessStep replaced by openProcessStepModal/submitProcessStep above
    function showAddProcessStepModal() { openProcessStepModal(); }
    function editProcessStep(id) { openProcessStepModal(id); }

    async function deleteProcessStep(id) {
      if (!confirm('Delete this process step?')) return;
      fetch(`/process-steps/${id}`, {method: 'DELETE'}).then(() => { toast('Deleted'); loadProcessSteps(); }).catch(() => toast('Failed'));
    }

    // ---- Process I/O Management ----
    async function loadProcessIO() {
      const body = document.getElementById('process-io-body');
      try {
        const res = await fetch('/process-io');
        const ios = await res.json();
        if (!ios.length) {
          body.innerHTML = '<div class="feed-empty" style="padding:0.8rem;">No inputs or outputs defined yet.</div>';
          return;
        }
        const inputs = ios.filter(io => io.io_type === 'input');
        const outputs = ios.filter(io => io.io_type === 'output');
        let html = '';

        if (inputs.length) {
          html += '<div style="font-size:0.78rem;font-weight:500;margin-bottom:0.3rem;">ðŸ“¥ INPUTS</div>';
          html += '<table class="process-table"><tr><th>Name</th><th>Source</th><th>Unit</th><th>Range</th><th>Table</th><th></th></tr>';
          for (const io of inputs) {
            html += `<tr><td>${io.name}</td><td>${io.source_or_destination || '-'}</td><td>${io.unit || '-'}</td><td>${io.typical_range || '-'}</td><td>${io.linked_table || '-'}</td>
              <td><button class="btn-sm" onclick="deleteProcessIO(${io.id})" style="font-size:0.6rem;color:#e74c3c;">Del</button></td></tr>`;
          }
          html += '</table>';
        }

        if (outputs.length) {
          html += '<div style="font-size:0.78rem;font-weight:500;margin:0.6rem 0 0.3rem;">ðŸ“¤ OUTPUTS</div>';
          html += '<table class="process-table"><tr><th>Name</th><th>Destination</th><th>Unit</th><th>Range</th><th>Table</th><th></th></tr>';
          for (const io of outputs) {
            html += `<tr><td>${io.name}</td><td>${io.source_or_destination || '-'}</td><td>${io.unit || '-'}</td><td>${io.typical_range || '-'}</td><td>${io.linked_table || '-'}</td>
              <td><button class="btn-sm" onclick="deleteProcessIO(${io.id})" style="font-size:0.6rem;color:#e74c3c;">Del</button></td></tr>`;
          }
          html += '</table>';
        }
        body.innerHTML = html;
        updateSetupChecklist();
      } catch (e) {
        body.innerHTML = '<div class="feed-empty">Failed to load inputs/outputs.</div>';
      }
    }

    // showAddIOModal replaced by openIOModal/submitProcessIO above
    function showAddIOModal(ioType) { openIOModal(ioType); }

    async function deleteProcessIO(id) {
      if (!confirm('Delete this entry?')) return;
      fetch(`/process-io/${id}`, {method: 'DELETE'}).then(() => { toast('Deleted'); loadProcessIO(); }).catch(() => toast('Failed'));
    }

    function showAddContextModal() {
      document.getElementById('ctx-text').focus();
    }

    // -----------------------------------------------------------------------
    // Setup Dashboard â€” Auto-Scan, Auto-Link, Derived Metrics
    // -----------------------------------------------------------------------
    async function runAutoScan() {
      toast('Scanning data for metrics...');
      await loadSuggestedMetrics();
      toggleSetupCard('metrics');
    }

    async function loadSuggestedMetrics() {
      const body = document.getElementById('suggested-metrics-body');
      if (!body) return;
      body.innerHTML = '<div class="feed-empty" style="padding:0.5rem;grid-column:1/-1;font-size:0.72rem;">Scanning...</div>';
      try {
        const data = await apiFetch('/setup/suggest-metrics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const suggestions = data.suggestions || [];
        if (!suggestions.length) {
          body.innerHTML = '<div class="feed-empty" style="padding:0.5rem;grid-column:1/-1;font-size:0.72rem;">No additional metrics found in your data.</div>';
          return;
        }
        let html = '';
        for (const s of suggestions) {
          html += `<div class="suggested-metric-card">
            <div style="font-weight:500;font-size:0.78rem;">${s.column_name}</div>
            <div style="font-size:0.68rem;color:var(--muted);">Table: ${s.table_name}</div>
            <div style="font-size:0.68rem;color:var(--muted);">Range: ${s.min != null ? s.min.toFixed(1) : '?'} &ndash; ${s.max != null ? s.max.toFixed(1) : '?'} (avg: ${s.avg != null ? s.avg.toFixed(1) : '?'})</div>
            <button class="btn-sm" onclick="addSuggestedMetric('${s.table_name}','${s.column_name}')" style="margin-top:0.3rem;font-size:0.65rem;">+ Add as Metric</button>
          </div>`;
        }
        body.innerHTML = html;
      } catch (e) {
        body.innerHTML = '<div class="feed-empty" style="padding:0.5rem;grid-column:1/-1;font-size:0.72rem;">Failed to scan. Upload data first.</div>';
      }
    }

    async function addSuggestedMetric(tableName, columnName) {
      try {
        await apiFetch('/metrics/thresholds', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            metric_name: columnName,
            table_name: tableName,
            column_name: columnName,
            auto_linked: true,
            confidence: 1.0,
          }),
        });
        toast(`Added ${columnName} as metric`);
        loadThresholds();
        loadSuggestedMetrics();
      } catch (e) {
        toast('Failed to add metric: ' + (e.message || 'unknown error'));
      }
    }

    async function runAutoLink() {
      const body = document.getElementById('auto-link-body');
      if (!body) return;
      body.innerHTML = '<div class="feed-empty" style="padding:0.8rem;">Running auto-link...</div>';
      try {
        const data = await apiFetch('/setup/auto-link-metrics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        let html = '';
        const autoLinked = data.auto_linked || [];
        const suggestions = data.suggestions || [];
        const unmatched = data.unmatched || [];

        if (autoLinked.length) {
          html += '<div class="metrics-section-label" style="color:var(--green);">Auto-Linked (high confidence)</div>';
          for (const l of autoLinked) {
            html += `<div class="auto-link-item auto-link-done">
              <span>&#10003; <strong>${l.metric_name}</strong> &rarr; ${l.table_name}.${l.column_name}</span>
              <span class="confidence-badge" style="background:var(--green);">${Math.round((l.confidence||1)*100)}%</span>
            </div>`;
          }
        }
        if (suggestions.length) {
          html += '<div class="metrics-section-label" style="margin-top:0.5rem;">Suggestions (review needed)</div>';
          for (const s of suggestions) {
            html += `<div class="auto-link-item">
              <span><strong>${s.metric_name}</strong> &rarr; ${s.table_name}.${s.column_name}?</span>
              <span class="confidence-badge">${Math.round((s.confidence||0)*100)}%</span>
              <button class="btn-sm" onclick="acceptAutoLink('${s.metric_name}','${s.table_name}','${s.column_name}')" style="font-size:0.6rem;">Accept</button>
            </div>`;
          }
        }
        if (unmatched.length) {
          html += '<div class="metrics-section-label" style="margin-top:0.5rem;color:var(--muted);">Unmatched</div>';
          for (const u of unmatched) {
            html += `<div class="auto-link-item" style="opacity:0.6;"><span>${u}</span><span style="font-size:0.65rem;color:var(--muted);">No matching column found</span></div>`;
          }
        }
        if (!html) html = '<div class="feed-empty" style="padding:0.8rem;">No metrics to link. Add metrics first.</div>';
        body.innerHTML = html;
        updateSetupCardSummaries();
      } catch (e) {
        body.innerHTML = '<div class="feed-empty" style="padding:0.8rem;">Auto-link failed. Ensure data is uploaded and metrics are defined.</div>';
      }
    }

    async function acceptAutoLink(metricName, tableName, columnName) {
      try {
        await apiFetch('/setup/auto-link-metrics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accept: { metric_name: metricName, table_name: tableName, column_name: columnName } }),
        });
        toast(`Linked ${metricName} to ${tableName}.${columnName}`);
        runAutoLink();
      } catch (e) {
        toast('Failed to accept link');
      }
    }

    function openDerivedMetricModal() {
      document.getElementById('dm-name').value = '';
      document.getElementById('dm-unit').value = '';
      document.getElementById('dm-formula').value = '';
      document.getElementById('dm-warn-min').value = '';
      document.getElementById('dm-warn-max').value = '';
      document.getElementById('dm-crit-min').value = '';
      document.getElementById('dm-crit-max').value = '';
      document.getElementById('derived-metric-modal').style.display = 'flex';
      document.getElementById('dm-name').focus();
    }

    async function submitDerivedMetric() {
      const name = document.getElementById('dm-name').value.trim();
      const formula = document.getElementById('dm-formula').value.trim();
      if (!name) return toast('Metric name is required');
      if (!formula) return toast('Formula is required');

      const payload = {
        metric_name: name,
        unit: document.getElementById('dm-unit').value.trim(),
        formula: formula,
        warning_min: parseFloat(document.getElementById('dm-warn-min').value) || null,
        warning_max: parseFloat(document.getElementById('dm-warn-max').value) || null,
        critical_min: parseFloat(document.getElementById('dm-crit-min').value) || null,
        critical_max: parseFloat(document.getElementById('dm-crit-max').value) || null,
      };

      try {
        const data = await apiFetch('/metrics/derived', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (data.error) {
          toast('Error: ' + data.error);
          return;
        }
        toast(`Derived metric "${name}" created`);
        document.getElementById('derived-metric-modal').style.display = 'none';
        loadThresholds();
        loadDerivedMetrics();
      } catch (e) {
        toast('Failed: ' + (e.message || 'unknown error'));
      }
    }

    async function loadDerivedMetrics() {
      const body = document.getElementById('derived-metrics-body');
      if (!body) return;
      try {
        const res = await fetch('/metrics/thresholds');
        const all = await res.json();
        const derived = (all || []).filter(m => m.is_derived);
        if (!derived.length) {
          body.innerHTML = '<div class="feed-empty" style="padding:0.5rem;grid-column:1/-1;font-size:0.72rem;">No derived metrics. Create formulas like <em>total_kwh / output_mt</em>.</div>';
          return;
        }
        let html = '';
        for (const m of derived) {
          html += `<div class="derived-metric-card">
            <div style="font-weight:500;font-size:0.78rem;">${m.metric_name}</div>
            <div style="font-family:monospace;font-size:0.68rem;color:var(--accent);margin:0.2rem 0;">${m.formula || ''}</div>
            ${m.unit ? `<div style="font-size:0.65rem;color:var(--muted);">Unit: ${m.unit}</div>` : ''}
          </div>`;
        }
        body.innerHTML = html;
      } catch (e) {
        // ignore
      }
    }

    // Toast
    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    // Chat thread rendering
    function addChatMessage(role, content) {
      chatMessages.push({ role, content });
      const thread = document.getElementById('chat-thread');
      thread.style.display = 'block';
      const div = document.createElement('div');
      div.className = `chat-msg ${role}`;
      div.innerHTML = `<div class="chat-role">${role}</div><div>${esc(content)}</div>`;
      thread.appendChild(div);
      thread.scrollTop = thread.scrollHeight;
    }

    // ---------------------------------------------------------------------------
    // Number formatting helper
    // ---------------------------------------------------------------------------
    function formatCompValue(comp) {
      const raw = comp.value;
      const fmt = comp.format || '';
      const unit = comp.unit || '';
      let val = typeof raw === 'string' ? parseFloat(raw.replace(/[^0-9.\-]/g, '')) : raw;

      if (isNaN(val)) return raw; // not a number, return as-is

      if (fmt === 'currency' || unit.toLowerCase().includes('rs')) {
        try {
          return 'Rs ' + val.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        } catch(e) { return 'Rs ' + val.toFixed(2); }
      }
      if (fmt === 'percentage' || unit === '%') {
        return val.toFixed(2) + '%';
      }
      if (fmt === 'number' || fmt === 'decimal') {
        try {
          return val.toLocaleString('en-IN', { maximumFractionDigits: 2 });
        } catch(e) { return val.toFixed(2); }
      }
      return String(raw);
    }

    function fmtTick(value, numberFormat) {
      if (numberFormat === 'currency') {
        try {
          return 'Rs ' + value.toLocaleString('en-IN', { maximumFractionDigits: 0 });
        } catch(e) { return 'Rs ' + Math.round(value); }
      }
      if (numberFormat === 'percentage') return value.toFixed(1) + '%';
      if (typeof value === 'number' && Math.abs(value) >= 1000) {
        try { return value.toLocaleString('en-IN', { maximumFractionDigits: 1 }); }
        catch(e) { return value.toFixed(1); }
      }
      return value;
    }

    // ---------------------------------------------------------------------------
    // Analyze
    // ---------------------------------------------------------------------------
    async function runAnalysis(parentFinding) {
      const q = document.getElementById('question').value.trim();
      if (!q) return;

      const btn = document.getElementById('ask-btn');
      const status = document.getElementById('analyze-status');
      const body = document.getElementById('analyze-body');

      btn.disabled = true;
      status.innerHTML = '<span class="spinner"></span> Running...';
      body.innerHTML = '';
      destroyCharts();

      addChatMessage('user', q);

      // Fresh query â†’ reset drill-down stack
      if (!parentFinding) analysisStack = [];

      try {
        const payload = { question: q, session_id: sessionId };
        if (parentFinding) payload.parent_finding = parentFinding;

        const data = await apiFetch(`${API}/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // Update session_id if server returns one
        if (data.session_id) {
          sessionId = data.session_id;
          localStorage.setItem('bb_session_id', sessionId);
          updateSessionLabel();
        }

        lastAnalysisData = data;

        // Push to drill-down stack
        analysisStack.push({ question: q, data, finding: parentFinding || null });

        status.innerHTML = data.approved
          ? '<span class="badge badge-green">APPROVED</span>'
          : '<span class="badge badge-red">REJECTED</span>';
        body.innerHTML = renderAnalysis(data);

        // Add assistant message to chat
        const summary = data.analysis?.summary || 'Analysis completed.';
        addChatMessage('assistant', summary);

        // Auto-render charts
        autoRenderCharts(data);

        document.getElementById('question').value = '';
      } catch (e) {
        status.innerHTML = '<span class="badge badge-red">ERROR</span>';
        body.textContent = e.message;
      }
      btn.disabled = false;
    }

    document.getElementById('question').addEventListener('keydown', e => {
      if (e.key === 'Enter') runAnalysis();
    });

    // ---------------------------------------------------------------------------
    // Insight-first layout
    // ---------------------------------------------------------------------------
    function renderAnalysis(d) {
      let html = '';

      // Store data for drill-down onclick references
      _currentFindings = d.analysis?.findings || [];
      _currentMetrics = d.cfo_key_metrics || [];
      _currentComputations = d.python_analysis?.computations || [];

      // Breadcrumb navigation (only show when drilled down)
      if (analysisStack.length > 1) {
        html += `<div class="drill-breadcrumb">`;
        html += `<button class="drill-back-btn" onclick="drillBack(${analysisStack.length - 2})">&#8592; Back</button>`;
        analysisStack.forEach((entry, i) => {
          if (i > 0) html += `<span class="crumb-sep">&#8250;</span>`;
          const label = entry.question.length > 40
            ? entry.question.slice(0, 40) + '...'
            : entry.question;
          if (i < analysisStack.length - 1) {
            html += `<span class="crumb" onclick="drillBack(${i})">${esc(label)}</span>`;
          } else {
            html += `<span class="crumb-current">${esc(label)}</span>`;
          }
        });
        html += `</div>`;
      }

      // Analysis Actions Bar (Feed-parity)
      html += `<div style="display:flex;gap:0.4rem;margin-bottom:0.75rem;flex-wrap:wrap;">`;
      html += `<button class="btn-sm" onclick="deployFullAnalysis()">Deploy Full Analysis</button>`;
      html += `<button class="btn-sm btn-secondary" onclick="saveFullAnalysisToFeed()">Save to Feed</button>`;
      html += `<button class="btn-sm btn-secondary" onclick="exportCSV()">Export CSV</button>`;
      html += `<button class="btn-sm btn-secondary" onclick="exportPDF()">Export PDF</button>`;
      html += `</div>`;

      // 1. CFO Key Metrics â€” Hero stat cards (clickable for drill-down)
      if (d.cfo_key_metrics?.length) {
        html += `<div class="step"><div class="step-label">Key Metrics <span style="font-size:0.6rem;color:var(--accent);font-style:italic;">click to investigate</span></div>`;
        html += `<div class="stat-grid">`;
        d.cfo_key_metrics.forEach((m, i) => {
          const verdict = m.verdict || 'good';
          const cls = `stat-card-hero stat-${verdict}`;
          html += `<div class="${cls}" onclick="drillFromMetric(_currentMetrics[${i}])">`;
          html += `<div class="stat-value">${esc(String(m.value))}</div>`;
          html += `<div class="stat-label">${esc(m.label)}</div>`;
          if (m.unit) html += `<div class="stat-unit">${esc(m.unit)}</div>`;
          html += `</div>`;
        });
        html += `</div></div>`;
      }

      // 2. Auto-rendered charts area (analyst + CFO)
      html += `<div id="chart-area"></div>`;
      html += `<div id="cfo-chart-area"></div>`;

      // 3. CFO Assessment â€” verdict + recommendations
      html += `<div class="step">`;
      html += `<div class="step-label">CFO Assessment</div>`;
      const verdictClass = d.approved ? 'cfo-approved' : 'cfo-rejected';
      html += `<div class="cfo-verdict ${verdictClass}">`;
      html += `<h3>${d.approved ? '&#10003; Approved' : '&#10007; Needs Attention'}</h3>`;
      if (d.cfo_notes) html += `<p>${esc(d.cfo_notes)}</p>`;
      html += `</div>`;
      if (d.recommendations?.length) {
        d.recommendations.forEach((r, i) => {
          html += `<div class="recommendation-card">`;
          html += `<div class="rec-number">${i + 1}</div>`;
          html += `<div>${esc(r)}</div>`;
          html += `</div>`;
        });
      }
      html += `</div>`;

      // 4. Analyst Findings (clickable for drill-down)
      if (d.analysis) {
        html += `<div class="step"><div class="step-label">Analyst Findings <span style="font-size:0.6rem;color:var(--accent);font-style:italic;">click to drill down</span></div>`;
        if (d.analysis.summary) {
          html += `<div class="insight-summary">${esc(d.analysis.summary)}</div>`;
        }
        if (d.analysis.findings?.length) {
          d.analysis.findings.forEach((f, i) => {
            const badge = f.type === 'trend' ? 'badge-yellow'
              : f.type === 'anomaly' ? 'badge-red'
              : f.type === 'correlation' ? 'badge-accent'
              : f.type === 'comparison' ? 'badge-accent'
              : 'badge-green';
            html += `<div class="finding-card">`;
            html += `<div class="finding-desc" onclick="drillDown(_currentFindings[${i}])" style="cursor:pointer;"><span class="badge ${badge}" style="margin-right:0.4rem;">${esc(f.type)}</span>${esc(f.description)}</div>`;
            if (f.business_impact) {
              html += `<div class="finding-impact">${esc(f.business_impact)}</div>`;
            }
            html += `<div class="finding-actions">`;
            html += `<button class="btn-sm" onclick="event.stopPropagation();deployFromAnalysis(${i})">Deploy as Report</button>`;
            html += `<button class="btn-sm btn-secondary" onclick="event.stopPropagation();drillDown(_currentFindings[${i}])">Go Deeper</button>`;
            html += `<button class="btn-sm btn-secondary" onclick="event.stopPropagation();saveToFeed(${i})">Save to Feed</button>`;
            html += `</div>`;
            html += `</div>`;
          });
        }
        // Extra chart suggestion buttons (beyond the 2 auto-rendered)
        if (d.analysis.chart_suggestions?.length > 2) {
          html += `<div style="margin-top:0.5rem;">`;
          d.analysis.chart_suggestions.slice(2).forEach((cs, ci) => {
            html += `<button class="btn-sm" style="margin-right:0.3rem;margin-bottom:0.3rem;" onclick="renderSuggestedChart(${ci + 2}, 'analyst')">Generate: ${esc(cs.title || cs.type + ' chart')}</button>`;
          });
          html += `</div>`;
        }
        html += `</div>`;
      }

      // 5. Python Computations â€” priority-sorted
      if (d.python_analysis) {
        html += `<div class="step"><div class="step-label">Computational Analysis</div>`;
        if (d.python_analysis.error) {
          html += `<p style="color:var(--red);">${esc(d.python_analysis.error)}</p>`;
        } else {
          if (d.python_analysis.computations?.length) {
            // Sort by priority (higher first)
            const sorted = [...d.python_analysis.computations].sort((a, b) => (b.priority || 5) - (a.priority || 5));
            // Build index map so onclick finds the right computation
            const compIndexMap = sorted.map(s => d.python_analysis.computations.indexOf(s));
            html += `<div class="stat-grid">`;
            sorted.forEach((c, si) => {
              const fmtVal = formatCompValue(c);
              const origIdx = compIndexMap[si];
              html += `<div class="stat-card clickable" onclick="drillFromComputation(_currentComputations[${origIdx}])"><div class="stat-value">${esc(String(fmtVal))}</div><div class="stat-label">${esc(c.label)}</div>`;
              if (c.unit) html += `<div class="stat-unit">${esc(c.unit)}</div>`;
              html += `</div>`;
            });
            html += `</div>`;
          }
          if (d.python_analysis.narrative) {
            html += `<p style="color:var(--muted);font-size:0.8rem;line-height:1.5;">${esc(d.python_analysis.narrative)}</p>`;
          }
        }
        html += `</div>`;
      }

      // 6. Collapsible Details â€” SQL, plan, raw data, code
      html += `<div class="details-section">`;
      html += `<details><summary class="details-toggle">Show Details (SQL, Plan, Raw Data, Code)</summary>`;
      html += `<div style="padding-top:0.5rem;">`;

      // Plan
      if (d.plan?.length) {
        html += `<div class="step"><div class="step-label">Supervisor Plan</div><ul>`;
        d.plan.forEach(s => {
          html += `<li><span class="badge badge-accent">${esc(s.agent)}</span> ${esc(s.task)}</li>`;
        });
        html += `</ul></div>`;
      }

      // SQL Results
      const sqlResults = d.sql_results || (d.sql_result ? [d.sql_result] : []);
      sqlResults.forEach((sr, i) => {
        html += `<div class="step"><div class="step-label">SQL${sqlResults.length > 1 ? ` (Query ${i+1})` : ''}</div>`;
        if (sr.task) {
          html += `<p style="margin-bottom:0.3rem;font-size:0.75rem;color:var(--accent);">${esc(sr.task)}</p>`;
        }
        if (sr.query) {
          html += `<div class="sql-block">${esc(sr.query)}</div>`;
        }
        if (sr.error) {
          html += `<p style="color:var(--red);">${esc(sr.error)}</p>`;
        }
        if (sr.rows?.length) {
          html += renderTable(sr.rows, 10);
          if (sr.rows.length > 10) {
            html += `<button class="btn-sm btn-secondary" onclick="openDataModal(${i})">View Full Data (${sr.rows.length} rows)</button>`;
          }
        }
        html += `</div>`;
      });

      // Python code
      if (d.python_analysis?.code) {
        html += `<div class="step"><div class="step-label">Generated Python Code</div>`;
        html += `<div class="sql-block">${esc(d.python_analysis.code)}</div>`;
        html += `</div>`;
      }

      html += `</div></details></div>`;

      // Manual chart builder
      if (sqlResults.length && sqlResults.some(sr => sr.rows?.length)) {
        const allRows = sqlResults.flatMap(sr => sr.rows || []);
        if (allRows.length) {
          const cols = Object.keys(allRows[0]);
          html += `<div class="step"><div class="step-label">Chart Builder</div>`;
          html += `<div class="chart-builder">`;
          html += `<label>Type:</label><select id="cb-type"><option>bar</option><option>line</option><option>pie</option><option>scatter</option></select>`;
          html += `<label>X:</label><select id="cb-x">${cols.map(c => `<option>${esc(c)}</option>`).join('')}</select>`;
          html += `<label>Y:</label><select id="cb-y" multiple size="3">${cols.map(c => `<option>${esc(c)}</option>`).join('')}</select>`;
          html += `<button class="btn-sm" onclick="buildCustomChart()">Build Chart</button>`;
          html += `</div><div id="custom-chart-area"></div></div>`;
        }
      }

      return html;
    }

    function renderTable(rows, maxRows) {
      if (!rows.length) return '';
      const keys = Object.keys(rows[0]);
      const show = maxRows ? rows.slice(0, maxRows) : rows;
      let html = '<div style="overflow-x:auto;"><table class="data-table"><thead><tr>';
      keys.forEach(k => { html += `<th>${esc(k)}</th>`; });
      html += '</tr></thead><tbody>';
      show.forEach(row => {
        html += '<tr>';
        keys.forEach(k => { html += `<td>${esc(String(row[k] ?? ''))}</td>`; });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      if (maxRows && rows.length > maxRows) {
        html += `<p style="color:var(--muted);font-size:0.7rem;">Showing ${maxRows} of ${rows.length} rows</p>`;
      }
      return html;
    }

    // ---------------------------------------------------------------------------
    // Chart rendering (improved)
    // ---------------------------------------------------------------------------
    function destroyCharts() {
      activeCharts.forEach(c => c.destroy());
      activeCharts = [];
    }

    function renderSuggestedChart(index, source) {
      const suggestions = source === 'cfo'
        ? lastAnalysisData?.cfo_chart_suggestions
        : lastAnalysisData?.analysis?.chart_suggestions;
      if (!suggestions || !suggestions[index]) return;

      const cs = suggestions[index];
      const sqlResults = lastAnalysisData.sql_results || [lastAnalysisData.sql_result];
      const allRows = sqlResults.flatMap(sr => sr.rows || []);

      const areaId = source === 'cfo' ? 'cfo-chart-area' : 'chart-area';
      const area = document.getElementById(areaId);
      if (!area) return;

      _renderChart(area, cs, allRows);
    }

    function _renderChart(container, cs, allRows) {
      const wrapper = document.createElement('div');
      wrapper.className = 'chart-container';
      const canvas = document.createElement('canvas');
      wrapper.appendChild(canvas);
      container.appendChild(wrapper);

      const labels = allRows.map(r => String(r[cs.x] ?? ''));
      const yColumns = Array.isArray(cs.y) ? cs.y : [cs.y];
      const colors = ['#6c5ce7', '#00cec9', '#ff6b6b', '#feca57', '#a29bfe', '#55efc4'];
      const numberFormat = cs.number_format || 'decimal';

      const datasets = yColumns.filter(Boolean).map((col, i) => {
        const data = allRows.map(r => {
          const v = r[col];
          return v != null ? parseFloat(v) || 0 : 0;
        });

        const baseConfig = {
          label: col,
          data: data,
          backgroundColor: cs.type === 'scatter'
            ? colors[i % colors.length] + '66'
            : colors[i % colors.length],
          borderColor: colors[i % colors.length],
          borderWidth: cs.type === 'line' ? 2 : 1,
        };

        if (cs.type === 'scatter') {
          baseConfig.pointRadius = 4;
          baseConfig.data = allRows.map(r => ({
            x: parseFloat(r[cs.x]) || 0,
            y: parseFloat(r[col]) || 0,
          }));
        }
        if (cs.type === 'line') {
          baseConfig.fill = false;
          baseConfig.tension = 0.3;
        }
        return baseConfig;
      });

      const isPie = cs.type === 'pie';

      const chartConfig = {
        type: cs.type || 'bar',
        data: cs.type === 'scatter'
          ? { datasets }
          : { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.8,
          plugins: {
            title: {
              display: true,
              text: cs.title || 'Chart',
              color: '#e2e2e8',
              font: { size: 13, weight: '600' },
            },
            tooltip: {
              backgroundColor: '#1e1e2e',
              titleColor: '#e2e2e8',
              bodyColor: '#e2e2e8',
              borderColor: '#333',
              borderWidth: 1,
              callbacks: {
                label: function(ctx) {
                  const v = ctx.parsed?.y ?? ctx.parsed ?? ctx.raw;
                  const val = typeof v === 'object' ? v.y : v;
                  return ctx.dataset.label + ': ' + fmtTick(val, numberFormat);
                }
              }
            },
            legend: {
              labels: { color: '#8888a0', font: { size: 11 } }
            }
          },
        }
      };

      if (!isPie) {
        chartConfig.options.scales = {
          x: {
            ticks: {
              color: '#8888a0',
              maxRotation: 45,
              autoSkip: true,
            },
            grid: { color: '#1e1e2e' },
            title: {
              display: !!(cs.x_label),
              text: cs.x_label || '',
              color: '#8888a0',
              font: { size: 11 },
            }
          },
          y: {
            beginAtZero: cs.type !== 'scatter',
            ticks: {
              color: '#8888a0',
              callback: function(value) { return fmtTick(value, numberFormat); }
            },
            grid: { color: '#1e1e2e' },
            title: {
              display: !!(cs.y_label),
              text: cs.y_label || '',
              color: '#8888a0',
              font: { size: 11 },
            }
          }
        };
      }

      const chart = new Chart(canvas, chartConfig);
      activeCharts.push(chart);

      // Add insight caption
      if (cs.insight) {
        const caption = document.createElement('div');
        caption.className = 'chart-insight';
        caption.textContent = cs.insight;
        wrapper.appendChild(caption);
      }
    }

    function autoRenderCharts(data) {
      // Auto-render top 2 analyst chart suggestions
      const analystCharts = data.analysis?.chart_suggestions || [];
      analystCharts.slice(0, 2).forEach((cs, i) => {
        const area = document.getElementById('chart-area');
        if (!area) return;
        const sqlResults = data.sql_results || [data.sql_result];
        const allRows = sqlResults.flatMap(sr => sr.rows || []);
        if (allRows.length) _renderChart(area, cs, allRows);
      });

      // Auto-render all CFO chart suggestions
      const cfoCharts = data.cfo_chart_suggestions || [];
      cfoCharts.forEach((cs, i) => {
        const area = document.getElementById('cfo-chart-area');
        if (!area) return;
        const sqlResults = data.sql_results || [data.sql_result];
        const allRows = sqlResults.flatMap(sr => sr.rows || []);
        if (allRows.length) _renderChart(area, cs, allRows);
      });
    }

    // ---------------------------------------------------------------------------
    // Drill-down into an insight
    // ---------------------------------------------------------------------------
    async function drillDown(finding) {
      const btn = document.getElementById('ask-btn');
      const status = document.getElementById('analyze-status');
      const body = document.getElementById('analyze-body');

      btn.disabled = true;
      status.innerHTML = '<span class="spinner"></span> Drilling deeper...';
      body.innerHTML = '';
      destroyCharts();

      const drillQuestion = `Investigate deeper: ${finding.description}` +
        (finding.business_impact ? ` â€” ${finding.business_impact}` : '');

      addChatMessage('user', drillQuestion);

      try {
        const payload = {
          question: drillQuestion,
          session_id: sessionId,
          parent_finding: finding,
        };
        const data = await apiFetch(`${API}/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (data.session_id) {
          sessionId = data.session_id;
          localStorage.setItem('bb_session_id', sessionId);
          updateSessionLabel();
        }

        lastAnalysisData = data;

        // Push to stack
        analysisStack.push({ question: drillQuestion, data, finding });

        status.innerHTML = data.approved
          ? '<span class="badge badge-green">APPROVED</span>'
          : '<span class="badge badge-red">REJECTED</span>';
        body.innerHTML = renderAnalysis(data);

        const summary = data.analysis?.summary || 'Analysis completed.';
        addChatMessage('assistant', summary);

        autoRenderCharts(data);
      } catch (e) {
        status.innerHTML = '<span class="badge badge-red">ERROR</span>';
        body.textContent = e.message;
      }
      btn.disabled = false;
    }

    function drillBack(targetIndex) {
      if (targetIndex < 0 || targetIndex >= analysisStack.length) return;

      // Trim stack to target
      analysisStack = analysisStack.slice(0, targetIndex + 1);
      const entry = analysisStack[targetIndex];

      lastAnalysisData = entry.data;

      const status = document.getElementById('analyze-status');
      const body = document.getElementById('analyze-body');
      destroyCharts();

      status.innerHTML = entry.data.approved
        ? '<span class="badge badge-green">APPROVED</span>'
        : '<span class="badge badge-red">REJECTED</span>';
      body.innerHTML = renderAnalysis(entry.data);
      autoRenderCharts(entry.data);
    }

    function drillFromMetric(metric) {
      // Build a finding-like object from a CFO key metric
      drillDown({
        type: 'insight',
        description: `${metric.label}: ${metric.value}${metric.unit ? ' ' + metric.unit : ''}`,
        business_impact: `This key metric has a "${metric.verdict}" verdict â€” investigate what drives it and how to improve it.`,
      });
    }

    function drillFromComputation(comp) {
      // Build a finding-like object from a python computation
      drillDown({
        type: 'insight',
        description: `${comp.label}: ${comp.value}${comp.unit ? ' ' + comp.unit : ''}`,
        business_impact: 'Investigate the underlying data and breakdown behind this metric.',
      });
    }

    // Store findings and metrics globally for onclick references
    let _currentFindings = [];
    let _currentMetrics = [];
    let _currentComputations = [];

    // -----------------------------------------------------------------------
    // Analyze â†’ Feed Parity Actions
    // -----------------------------------------------------------------------
    async function deployFromAnalysis(findingIndex) {
      const finding = _currentFindings[findingIndex];
      if (!finding || !lastAnalysisData) return;

      // First save to feed, then deploy the resulting insight
      try {
        const data = await apiFetch(API + '/feed/from-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: finding.description?.substring(0, 200) || 'Analysis Finding',
            description: (finding.description || '') + (finding.business_impact ? '\n\nBusiness Impact: ' + finding.business_impact : ''),
            insight_type: finding.type || 'analysis',
            severity: 'info',
            evidence: { sql_query: lastAnalysisData.sql_results?.[0]?.query || '' },
            suggested_actions: lastAnalysisData.recommendations || [],
            source_tables: lastAnalysisData.sql_results?.map(sr => sr.task) || [],
          }),
        });

        if (data.error) return toast('Error: ' + data.error);
        // Now show deploy modal for this insight
        showDeployModal(data.insight_id, finding.description?.substring(0, 100) || 'Analysis Report');
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    }

    async function saveToFeed(findingIndex) {
      const finding = _currentFindings[findingIndex];
      if (!finding || !lastAnalysisData) return;

      try {
        const data = await apiFetch(API + '/feed/from-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: finding.description?.substring(0, 200) || 'Analysis Finding',
            description: (finding.description || '') + (finding.business_impact ? '\n\nBusiness Impact: ' + finding.business_impact : ''),
            insight_type: finding.type || 'analysis',
            severity: 'info',
            evidence: { sql_query: lastAnalysisData.sql_results?.[0]?.query || '' },
            suggested_actions: lastAnalysisData.recommendations || [],
            source_tables: lastAnalysisData.sql_results?.map(sr => sr.task) || [],
          }),
        });

        if (data.error) return toast('Error: ' + data.error);
        toast('Saved to Feed');
        markFeedDirty();
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    }

    async function deployFullAnalysis() {
      if (!lastAnalysisData) return toast('No analysis to deploy');

      const summary = lastAnalysisData.analysis?.summary || 'Full Analysis';
      try {
        const data = await apiFetch(API + '/feed/from-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: summary.substring(0, 200),
            description: summary + '\n\nFindings: ' + (lastAnalysisData.analysis?.findings || []).map(f => f.description).join('; '),
            insight_type: 'composite',
            severity: lastAnalysisData.approved ? 'info' : 'warning',
            evidence: {
              sql_queries: (lastAnalysisData.sql_results || []).map(sr => sr.query),
              findings_count: (lastAnalysisData.analysis?.findings || []).length,
            },
            suggested_actions: lastAnalysisData.recommendations || [],
            source_tables: lastAnalysisData.sql_results?.map(sr => sr.task) || [],
          }),
        });

        if (data.error) return toast('Error: ' + data.error);
        showDeployModal(data.insight_id, summary.substring(0, 100));
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    }

    async function saveFullAnalysisToFeed() {
      if (!lastAnalysisData) return toast('No analysis to save');

      const summary = lastAnalysisData.analysis?.summary || 'Full Analysis';
      try {
        const data = await apiFetch(API + '/feed/from-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: summary.substring(0, 200),
            description: summary,
            insight_type: 'composite',
            severity: lastAnalysisData.approved ? 'info' : 'warning',
            evidence: { findings_count: (lastAnalysisData.analysis?.findings || []).length },
            suggested_actions: lastAnalysisData.recommendations || [],
            source_tables: lastAnalysisData.sql_results?.map(sr => sr.task) || [],
          }),
        });

        if (data.error) return toast('Error: ' + data.error);
        toast('Full analysis saved to Feed');
        markFeedDirty();
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    }

    function buildCustomChart() {
      const type = document.getElementById('cb-type').value;
      const xCol = document.getElementById('cb-x').value;
      const ySelect = document.getElementById('cb-y');
      const yCols = Array.from(ySelect.selectedOptions).map(o => o.value);

      if (!yCols.length) { toast('Select at least one Y column'); return; }

      const sqlResults = lastAnalysisData.sql_results || [lastAnalysisData.sql_result];
      const allRows = sqlResults.flatMap(sr => sr.rows || []);

      const area = document.getElementById('custom-chart-area');
      area.innerHTML = '';

      _renderChart(area, {
        type,
        x: xCol,
        y: yCols,
        title: `${yCols.join(', ')} by ${xCol}`,
        number_format: 'decimal',
      }, allRows);
    }

    // ---------------------------------------------------------------------------
    // Data viewer modal
    // ---------------------------------------------------------------------------
    function openDataModal(queryIndex) {
      if (!lastAnalysisData) return;
      const sqlResults = lastAnalysisData.sql_results || [lastAnalysisData.sql_result];
      const sr = sqlResults[queryIndex];
      if (!sr?.rows?.length) return;

      const modal = document.getElementById('data-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      title.textContent = sr.task || `Query ${queryIndex + 1} Results`;

      const pageSize = 50;
      let page = 1;
      const totalPages = Math.ceil(sr.rows.length / pageSize);

      function renderPage() {
        const start = (page - 1) * pageSize;
        const pageRows = sr.rows.slice(start, start + pageSize);
        const keys = Object.keys(sr.rows[0]);

        let html = '<div style="overflow-x:auto;"><table class="data-table"><thead><tr>';
        keys.forEach(k => { html += `<th>${esc(k)}</th>`; });
        html += '</tr></thead><tbody>';
        pageRows.forEach(row => {
          html += '<tr>';
          keys.forEach(k => { html += `<td>${esc(String(row[k] ?? ''))}</td>`; });
          html += '</tr>';
        });
        html += '</tbody></table></div>';

        html += `<div class="pagination">`;
        html += `<button class="btn-sm btn-secondary" onclick="modalPrev()" ${page<=1?'disabled':''}>Prev</button>`;
        html += `<span>Page ${page} of ${totalPages} (${sr.rows.length} rows)</span>`;
        html += `<button class="btn-sm btn-secondary" onclick="modalNext()" ${page>=totalPages?'disabled':''}>Next</button>`;
        html += `</div>`;

        body.innerHTML = html;
      }

      window.modalPrev = () => { if (page > 1) { page--; renderPage(); } };
      window.modalNext = () => { if (page < totalPages) { page++; renderPage(); } };

      renderPage();
      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('data-modal').classList.remove('active');
    }

    document.getElementById('data-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('data-modal')) closeModal();
    });

    // Server-side data viewer (for uploaded tables)
    async function openTableViewer(tableName) {
      const modal = document.getElementById('data-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      title.textContent = `Table: ${tableName}`;
      body.innerHTML = '<p><span class="spinner"></span> Loading...</p>';
      modal.classList.add('active');

      let page = 1;
      let sortBy = null;
      let sortDir = 'asc';

      async function loadPage() {
        let url = `${API}/data/${tableName}?page=${page}&page_size=50`;
        if (sortBy) url += `&sort_by=${sortBy}&sort_dir=${sortDir}`;

        const data = await apiFetch(url);

        if (data.error) {
          body.innerHTML = `<p style="color:var(--red)">${esc(data.error)}</p>`;
          return;
        }

        const totalPages = Math.ceil(data.total / data.page_size);
        const keys = data.columns.length ? data.columns : (data.rows.length ? Object.keys(data.rows[0]) : []);

        let html = '<div style="overflow-x:auto;"><table class="data-table"><thead><tr>';
        keys.forEach(k => {
          const arrow = sortBy === k ? (sortDir === 'asc' ? ' &#9650;' : ' &#9660;') : '';
          html += `<th onclick="tableSort('${tableName}', '${k}')">${esc(k)}${arrow}</th>`;
        });
        html += '</tr></thead><tbody>';
        data.rows.forEach(row => {
          html += '<tr>';
          keys.forEach((k, ci) => {
            const val = String(row[k] ?? '');
            const pkVal = row[keys[0]];
            html += `<td class="editable" ondblclick="startEdit(this, '${tableName}', '${pkVal}', '${k}')">${esc(val)}</td>`;
          });
          html += '</tr>';
        });
        html += '</tbody></table></div>';

        html += `<div class="pagination">`;
        html += `<button class="btn-sm btn-secondary" onclick="tvPrev()" ${page<=1?'disabled':''}>Prev</button>`;
        html += `<span>Page ${page} of ${totalPages} (${data.total} rows)</span>`;
        html += `<button class="btn-sm btn-secondary" onclick="tvNext()" ${page>=totalPages?'disabled':''}>Next</button>`;
        html += `</div>`;

        body.innerHTML = html;
      }

      window.tableSort = async (tn, col) => {
        if (sortBy === col) {
          sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          sortBy = col;
          sortDir = 'asc';
        }
        await loadPage();
      };

      window.tvPrev = async () => { if (page > 1) { page--; await loadPage(); } };
      window.tvNext = async () => { page++; await loadPage(); };

      await loadPage();
    }

    // Inline cell editing
    window.startEdit = function(td, tableName, rowId, column) {
      if (td.classList.contains('editing')) return;
      const oldVal = td.textContent;
      td.classList.add('editing');
      const input = document.createElement('input');
      input.value = oldVal;
      td.textContent = '';
      td.appendChild(input);
      input.focus();

      async function save() {
        const newVal = input.value;
        td.classList.remove('editing');
        td.textContent = newVal;
        if (newVal !== oldVal) {
          try {
            const data = await apiFetch(`${API}/data/${tableName}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ row_id: rowId, column, value: newVal })
            });
            if (data.error) {
              td.textContent = oldVal;
              toast('Save failed: ' + data.error);
            } else {
              td.classList.add('edited');
              toast('Cell updated');
            }
          } catch (e) {
            td.textContent = oldVal;
            toast('Save failed');
          }
        }
      }

      input.addEventListener('blur', save);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') input.blur();
        if (e.key === 'Escape') {
          td.classList.remove('editing');
          td.textContent = oldVal;
        }
      });
    };

    // ---------------------------------------------------------------------------
    // Context
    // ---------------------------------------------------------------------------
    async function submitContext() {
      const text = document.getElementById('ctx-text').value.trim();
      const source = document.getElementById('ctx-source').value.trim() || 'manual';
      if (!text) return;

      try {
        const data = await apiFetch(`${API}/context`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, source })
        });
        const body = document.getElementById('context-body');
        body.innerHTML = `<p>Stored context <strong>${data.chunks} chunk${data.chunks !== 1 ? 's' : ''}</strong> (ids: ${data.ids.join(', ')}) from source <span class="badge badge-accent">${esc(data.source)}</span></p>` + body.innerHTML;
        document.getElementById('ctx-text').value = '';
        toast('Context ingested successfully');
      } catch (e) {
        toast('Error: ' + e.message);
      }
    }

    // Context file upload
    const ctxFileZone = document.getElementById('ctx-file-zone');
    const ctxFileInput = document.getElementById('ctx-file-input');
    ctxFileZone.addEventListener('click', () => ctxFileInput.click());
    ctxFileInput.addEventListener('change', async () => {
      if (!ctxFileInput.files.length) return;
      const file = ctxFileInput.files[0];
      const form = new FormData();
      form.append('file', file);

      try {
        const data = await apiFetch(`${API}/context/file`, { method: 'POST', body: form });
        const body = document.getElementById('context-body');
        if (data.error) {
          body.innerHTML = `<p style="color:var(--red);">${esc(data.error)}</p>` + body.innerHTML;
        } else {
          body.innerHTML = `<p>Uploaded <strong>${esc(file.name)}</strong>: ${data.chunks} chunks stored (${data.text_length} chars) from <span class="badge badge-accent">${esc(data.source)}</span></p>` + body.innerHTML;
          toast('Context file ingested');
          markFeedDirty();
        }
      } catch (e) {
        toast('Error: ' + e.message);
      }
      ctxFileInput.value = '';
    });

    // ---------------------------------------------------------------------------
    // Schema
    // ---------------------------------------------------------------------------
    let _focusState = {}; // {table_name: is_included}

    async function loadSchema() {
      const body = document.getElementById('schema-body');
      body.innerHTML = '<p style="color:var(--muted)"><span class="spinner"></span> Loading...</p>';

      try {
        const data = await apiFetch(`${API}/metadata`);

        if (!data.length) {
          body.innerHTML = '<p style="color:var(--muted)">No metadata found. Seed some data first.</p>';
          return;
        }

        // Load focus state
        await loadFocusState();

        body.innerHTML = data.map(t => {
          const included = _focusState[t.table_name] !== false; // default true
          return `
          <div class="meta-card${included ? '' : ' focus-dimmed'}" id="table-card-${esc(t.table_name)}">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="display:flex;align-items:center;gap:0.5rem;">
                <label class="focus-toggle" title="${included ? 'Included in analysis' : 'Excluded from analysis'}">
                  <input type="checkbox" class="focus-checkbox" data-table="${esc(t.table_name)}"
                    ${included ? 'checked' : ''}
                    onchange="toggleFocusTable('${esc(t.table_name)}', this.checked)" />
                  <span class="focus-slider"></span>
                </label>
                <h3 style="margin:0;">${esc(t.table_name)}</h3>
              </div>
              <div style="display:flex;gap:0.4rem;">
                <button class="btn-sm btn-secondary" onclick="openTableViewer('${esc(t.table_name)}')">View Data</button>
                <button class="btn-sm" onclick="deleteTable('${esc(t.table_name)}')" style="background:var(--red);color:#fff;font-size:0.68rem;">Delete</button>
              </div>
            </div>
            <p>${esc(t.description || 'No description')}</p>
            <div class="col-list">
              ${(t.columns || []).map(c =>
                `<span class="col-chip"><strong>${esc(c.name)}</strong> ${esc(c.type)}</span>`
              ).join('')}
            </div>
          </div>`;
        }).join('');
      } catch (e) {
        body.innerHTML = `<div class="feed-empty" style="color:var(--red)">
          Failed to load tables: ${e.message}<br>
          <small style="color:var(--muted)">Try refreshing the page or uploading data first.</small>
        </div>`;
      }
    }

    // ---------------------------------------------------------------------------
    // Focus Mode â€” Table Scoping
    // ---------------------------------------------------------------------------

    async function loadFocusState() {
      try {
        const data = await apiFetch(API + '/focus');
        _focusState = {};
        (data.tables || []).forEach(t => { _focusState[t.table_name] = t.is_included; });
        updateFocusBanner(data);
      } catch (e) {
        _focusState = {};
      }
    }

    function updateFocusBanner(focusData) {
      const banner = document.getElementById('focus-banner');
      if (!focusData || !focusData.active) {
        banner.style.display = 'none';
        return;
      }
      const included = (focusData.tables || []).filter(t => t.is_included).length;
      const total = focusData.total || focusData.tables.length;
      document.getElementById('focus-count').textContent = included;
      document.getElementById('focus-total').textContent = total;
      banner.style.display = 'flex';
    }

    async function toggleFocusTable(tableName, included) {
      _focusState[tableName] = included;

      // Update card visual
      const card = document.getElementById('table-card-' + tableName);
      if (card) {
        if (included) card.classList.remove('focus-dimmed');
        else card.classList.add('focus-dimmed');
      }

      await saveFocusState();
    }

    async function saveFocusState() {
      const tables = Object.entries(_focusState).map(([table_name, is_included]) => ({
        table_name, is_included,
      }));

      // If all included, treat as focus off
      const allIncluded = tables.every(t => t.is_included);
      if (allIncluded) {
        try {
          await apiFetch(API + '/focus', { method: 'DELETE' });
          updateFocusBanner({ active: false, tables: [] });
        } catch (e) { /* ignore */ }
        return;
      }

      try {
        const result = await apiFetch(API + '/focus', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tables }),
        });
        // Refresh banner
        const data = await apiFetch(API + '/focus');
        updateFocusBanner(data);
      } catch (e) {
        toast('Failed to save focus: ' + e.message);
      }
    }

    async function clearFocusMode() {
      try {
        await apiFetch(API + '/focus', { method: 'DELETE' });
        _focusState = {};
        updateFocusBanner({ active: false, tables: [] });
        // Re-check all checkboxes
        document.querySelectorAll('.focus-checkbox').forEach(cb => {
          cb.checked = true;
          const card = cb.closest('.meta-card');
          if (card) card.classList.remove('focus-dimmed');
        });
        toast('Focus mode cleared â€” analyzing all tables');
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    }

    // Load focus state on startup
    loadFocusState();

    // ---------------------------------------------------------------------------
    // Upload (original + data tab clone)
    // ---------------------------------------------------------------------------
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');

    // Wire up the Data tab upload zone too
    const dataDropZone = document.getElementById('data-drop-zone');
    const dataFileInput = document.getElementById('data-file-input');
    if (dataDropZone && dataFileInput) {
      dataDropZone.addEventListener('click', () => dataFileInput.click());
      dataDropZone.addEventListener('dragover', e => { e.preventDefault(); dataDropZone.classList.add('drag-over'); });
      dataDropZone.addEventListener('dragleave', () => dataDropZone.classList.remove('drag-over'));
      dataDropZone.addEventListener('drop', e => {
        e.preventDefault();
        dataDropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0], 'data');
      });
      dataFileInput.addEventListener('change', () => {
        if (dataFileInput.files.length) handleUpload(dataFileInput.files[0], 'data');
      });
    }

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) handleUpload(fileInput.files[0]);
    });

    async function gzipBlob(blob) {
      const cs = new CompressionStream('gzip');
      const writer = cs.writable.getWriter();
      const reader = blob.stream().getReader();
      (async () => {
        while (true) {
          const { done, value } = await reader.read();
          if (done) { writer.close(); break; }
          writer.write(value);
        }
      })();
      return new Response(cs.readable).blob();
    }

    async function handleUpload(file, target) {
      // Detect which upload area to use: main panel or data-tab
      const isDataTab = target === 'data' || document.getElementById('data-upload')?.classList.contains('active');
      const resultEl = document.getElementById(isDataTab ? 'data-upload-result' : 'upload-result');
      const status = document.getElementById(isDataTab ? 'data-upload-status' : 'upload-status');
      const body = document.getElementById(isDataTab ? 'data-upload-body' : 'upload-body');

      resultEl.style.display = 'block';
      status.innerHTML = '<span class="spinner"></span> Uploading &amp; analysing...';
      body.innerHTML = '';

      const MAX_RAW = 100 * 1024 * 1024;  // 100 MB raw limit
      if (file.size > MAX_RAW) {
        status.innerHTML = '<span class="badge badge-red">ERROR</span>';
        body.textContent = `File is too large (${(file.size / 1024 / 1024).toFixed(1)} MB). Maximum size is 100 MB.`;
        return;
      }

      const form = new FormData();

      // Gzip compress to stay under Vercel's 4.5 MB body limit
      const MAX_VERCEL = 4 * 1024 * 1024;  // 4 MB threshold (leave margin)
      if (file.size > MAX_VERCEL && typeof CompressionStream !== 'undefined') {
        status.innerHTML = '<span class="spinner"></span> Compressing &amp; uploading...';
        const compressed = await gzipBlob(file);
        if (compressed.size >= file.size) {
          if (file.size > 4.5 * 1024 * 1024) {
            status.innerHTML = '<span class="badge badge-red">ERROR</span>';
            body.textContent = `File is too large (${(file.size / 1024 / 1024).toFixed(1)} MB). The upload limit is 4.5 MB and this file could not be compressed further.`;
            return;
          }
          form.append('file', file);
        } else {
          if (compressed.size > 4.5 * 1024 * 1024) {
            status.innerHTML = '<span class="badge badge-red">ERROR</span>';
            body.textContent = `File is too large even after compression (${(compressed.size / 1024 / 1024).toFixed(1)} MB compressed from ${(file.size / 1024 / 1024).toFixed(1)} MB). Try splitting into smaller files.`;
            return;
          }
          form.append('file', compressed, file.name + '.gz');
        }
      } else {
        if (file.size > 4.5 * 1024 * 1024 && typeof CompressionStream === 'undefined') {
          status.innerHTML = '<span class="badge badge-red">ERROR</span>';
          body.textContent = `File is too large (${(file.size / 1024 / 1024).toFixed(1)} MB). The upload limit is 4.5 MB. Try a smaller file or use a modern browser that supports compression.`;
          return;
        }
        form.append('file', file);
      }

      try {
        status.innerHTML = '<span class="spinner"></span> Uploading &amp; processing...';
        const data = await apiFetch(`${API}/upload`, { method: 'POST', body: form });

        if (data.detail || data.error) {
          status.innerHTML = '<span class="badge badge-red">ERROR</span>';
          body.textContent = data.detail || data.error;
          return;
        }

        // Show the upload report (works for both normal and recurring uploads)
        if (data.recurring) {
          status.innerHTML = '<span class="badge badge-green">LOADED</span> <span class="badge badge-accent">Recurring</span>';
          body.innerHTML = `<div class="stat-grid">
            <div class="stat-card"><div class="stat-value">${data.rows}</div><div class="stat-label">Rows Appended</div></div>
          </div>
          <div class="report-section"><p>${esc(data.message || '')}</p>
            <button class="btn-sm btn-secondary" onclick="openTableViewer('${esc(data.table_name)}')" style="margin-top:0.5rem;">View Data</button>
          </div>`;
        } else {
          status.innerHTML = '<span class="badge badge-green">LOADED</span>';
          body.innerHTML = renderUploadReport(data);
        }

        toast('File uploaded successfully');
        markFeedDirty();
        loadSchema().then(() => {
          if (document.getElementById('data-schema-body')) {
            loadSchemaIntoData();
          }
        });
      } catch (e) {
        status.innerHTML = '<span class="badge badge-red">ERROR</span>';
        body.textContent = e.message;
      }

      fileInput.value = '';
    }

    function renderUploadReport(d) {
      let html = '';

      // Stats
      html += `<div class="stat-grid">
        <div class="stat-card"><div class="stat-value">${d.rows_total}</div><div class="stat-label">Total Rows</div></div>
        <div class="stat-card"><div class="stat-value">${d.rows_inserted}</div><div class="stat-label">Inserted</div></div>
        <div class="stat-card"><div class="stat-value">${d.rows_dropped}</div><div class="stat-label">Dropped</div></div>
        <div class="stat-card"><div class="stat-value">${d.duplicates_removed}</div><div class="stat-label">Duplicates</div></div>
      </div>`;

      // Table name with view button
      html += `<div class="report-section"><h4>Table</h4><p><span style="color:var(--accent);font-weight:500">${esc(d.table_name)}</span> <button class="btn-sm btn-secondary" onclick="openTableViewer('${esc(d.table_name)}')" style="margin-left:0.5rem;">View Data</button></p></div>`;

      // Issues
      if (d.issues && d.issues.length) {
        html += `<div class="report-section"><h4>Data Issues</h4><table class="issue-table"><thead><tr><th>Column</th><th>Issue</th><th>Action</th></tr></thead><tbody>`;
        d.issues.forEach(i => {
          const actionBadge = i.action.startsWith('will_')
            ? `<span class="badge badge-yellow">${esc(i.action)}</span>`
            : `<span class="badge badge-accent">${esc(i.action)}</span>`;
          html += `<tr><td><strong>${esc(i.column)}</strong></td><td>${esc(i.issue)}</td><td>${actionBadge}</td></tr>`;
        });
        html += `</tbody></table></div>`;
      } else {
        html += `<div class="report-section"><h4>Data Issues</h4><p style="color:var(--green)">No issues found</p></div>`;
      }

      // Metadata
      if (d.metadata) {
        html += `<div class="report-section"><h4>Generated Metadata</h4>`;
        html += `<div class="meta-card"><p>${esc(d.metadata.description || 'No description')}</p>`;
        if (d.metadata.columns && d.metadata.columns.length) {
          html += `<div class="col-list">`;
          d.metadata.columns.forEach(c => {
            html += `<span class="col-chip"><strong>${esc(c.name)}</strong> ${esc(c.type)}${c.description ? ' â€” ' + esc(c.description) : ''}</span>`;
          });
          html += `</div>`;
        }
        html += `</div></div>`;
      }

      // Context
      if (d.context_generated) {
        html += `<div class="report-section"><h4>Business Context</h4><p style="color:var(--muted);font-size:0.8rem;">${esc(d.context_generated)}</p></div>`;
      }

      return html;
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    async function deleteTable(tableName) {
      if (!confirm(`Delete table "${tableName}" and ALL its dependent data (metadata, vectors, insights, profiles, alerts, reports)?\n\nThis cannot be undone.`)) return;
      try {
        const data = await apiFetch(`${API}/tables/${encodeURIComponent(tableName)}`, { method: 'DELETE' });
        if (data.error) {
          toast('Delete failed: ' + data.error);
        } else {
          const r = data.removed || {};
          const parts = [];
          if (r.insights) parts.push(r.insights + ' insights');
          if (r.deployed_reports) parts.push(r.deployed_reports + ' reports');
          if (r.relationships) parts.push(r.relationships + ' relationships');
          if (r.data_sources) parts.push(r.data_sources + ' sources');
          const extra = parts.length ? ' (' + parts.join(', ') + ')' : '';
          toast('Deleted ' + tableName + extra);
          loadSchema();
        }
      } catch (e) {
        toast('Delete failed: ' + e.message);
      }
    }

    async function cleanupOrphanedTables() {
      if (!confirm('This will drop PostgreSQL tables that have no metadata entry (orphaned/unused) and remove stale metadata.\n\nContinue?')) return;
      try {
        const data = await apiFetch(`${API}/tables/cleanup`, { method: 'POST' });
        if (data.error) {
          toast('Cleanup failed: ' + data.error);
        } else {
          const dropped = (data.orphaned_tables_dropped || []).length;
          const stale = (data.stale_metadata_removed || []).length;
          if (dropped || stale) {
            const parts = [];
            if (dropped) parts.push(`${dropped} orphaned table${dropped > 1 ? 's' : ''} dropped`);
            if (stale) parts.push(`${stale} stale metadata entr${stale > 1 ? 'ies' : 'y'} removed`);
            toast('Cleanup complete: ' + parts.join(', '));
          } else {
            toast('No orphaned tables or stale metadata found â€” database is clean');
          }
          loadSchema();
        }
      } catch (e) {
        toast('Cleanup failed: ' + e.message);
      }
    }

    async function redescribeSchema() {
      toast('Generating column descriptions...');
      try {
        const data = await apiFetch(`${API}/schema/redescribe`, { method: 'POST' });
        if (data.error) {
          toast('Redescribe failed: ' + data.error);
        } else {
          toast(`Column descriptions updated for ${data.tables_updated} of ${data.total_tables} tables`);
          loadSchema();
        }
      } catch (e) {
        toast('Redescribe failed: ' + e.message);
      }
    }

    // Auto-load schema on tab click
    document.querySelector('[data-panel="schema"]').addEventListener('click', loadSchema);

    // ---------------------------------------------------------------------------
    // Feed â€” Proactive Insight Discovery
    // ---------------------------------------------------------------------------
    var feedInsights = [];

    async function loadFeed() {
      const body = document.getElementById('feed-body');
      const empty = document.getElementById('feed-empty');

      try {
        // Load discovery status
        const statusData = await apiFetch(`${API}/discovery/status`);
        const statsEl = document.getElementById('disc-stats');

        if (statusData.status !== 'no_runs') {
          const ago = statusData.completed_at
            ? _timeAgo(new Date(statusData.completed_at))
            : 'running...';
          statsEl.innerHTML = `
            <span>${statusData.tables_scanned || 0} tables scanned</span>
            <span>${statusData.insights_found || 0} insights</span>
            <span>Last run: ${ago}</span>
          `;
        }

        // Load discovery history (last 5 runs)
        try {
          const history = await apiFetch(`${API}/discovery/history?limit=5`);
          if (history.length > 1) {
            let histHtml = '<div style="font-size:0.65rem;color:var(--muted);margin-top:4px;display:flex;gap:0.5rem;flex-wrap:wrap;">';
            for (const run of history.slice(1)) {
              const t = run.completed_at ? _timeAgo(new Date(run.completed_at)) : '...';
              const icon = run.status === 'completed' ? '' : run.status === 'failed' ? ' !' : ' ~';
              histHtml += `<span>${t}: ${run.insights_found || 0} insights${icon}</span>`;
            }
            histHtml += '</div>';
            statsEl.insertAdjacentHTML('afterend', histHtml);
          }
        } catch (e) { /* History endpoint optional */ }

        // Load dashboard KPIs
        try { await loadDashboardKPIs(); } catch (e) { /* optional */ }

        // Load recommendations (non-blocking)
        loadRecommendations().catch(() => {});

        // Load feed
        const insights = await apiFetch(`${API}/feed`);
        feedInsights = insights;

        if (!insights.length) {
          body.innerHTML = '<div class="feed-empty">No insights discovered yet. Upload data and click "Scan Now" to discover insights.</div>';
          return;
        }

        body.innerHTML = insights.map((ins, i) => {
          const sevClass = ins.insight_type === 'story' ? 'type-story' : `severity-${ins.severity}`;
          const sevBadge = ins.severity === 'critical' ? 'badge-red'
            : ins.severity === 'warning' ? 'badge-yellow'
            : ins.insight_type === 'story' ? 'badge-accent'
            : 'badge-green';

          // Determine card type for feed filtering
          const cardType = ins.insight_type === 'anomaly' ? 'sanctity'
            : ins.severity === 'critical' ? 'alert'
            : ins.insight_type === 'story' ? 'insight'
            : ins.insight_type === 'correlation' ? 'insight'
            : ins.insight_type === 'composite' ? 'insight'
            : ins.insight_type === 'cross_event' ? 'insight'
            : ins.insight_type === 'trend' ? 'alert'
            : 'insight';
          let html = `<div class="feed-card ${sevClass}" data-type="${cardType}" data-status="${ins.status || 'new'}">`;
          html += `<div class="feed-card-title">${esc(ins.title)}</div>`;
          html += `<div class="feed-card-desc">${esc(ins.description)}</div>`;
          html += `<div class="feed-card-meta">`;
          html += `<span class="badge ${sevBadge}">${esc(ins.insight_type)}</span>`;
          html += `<span class="badge badge-accent">Score: ${ins.impact_score}</span>`;
          if (ins.source_tables?.length) {
            ins.source_tables.forEach(t => {
              html += `<span class="table-chip">${esc(t)}</span>`;
            });
          }
          if (ins.discovered_at) {
            html += `<span style="font-size:0.65rem;color:var(--muted);">${_timeAgo(new Date(ins.discovered_at))}</span>`;
          }
          html += `</div>`;

          // Narrative for stories
          if (ins.narrative && ins.insight_type === 'story') {
            html += `<div style="font-size:0.78rem;color:var(--text);line-height:1.5;margin:0.3rem 0;padding:0.5rem;background:rgba(108,92,231,0.05);border-radius:4px;">${esc(ins.narrative)}</div>`;
          }

          // Suggested actions
          if (ins.suggested_actions?.length) {
            html += `<div style="font-size:0.7rem;color:var(--muted);margin-top:0.3rem;">`;
            ins.suggested_actions.forEach(a => {
              html += `<div style="margin-bottom:0.15rem;">&#8226; ${esc(a)}</div>`;
            });
            html += `</div>`;
          }

          html += `<div class="feed-card-actions">`;
          html += `<button class="btn-sm" onclick="investigateInsight(${i})">Investigate</button>`;
          html += `<button class="btn-sm btn-secondary" onclick="showDeployModal('${ins.id}', '${esc(ins.title).replace(/'/g, "\\'")}')">Deploy as Report</button>`;
          html += `<button class="btn-sm btn-secondary" onclick="toggleCompare(${i}, this)">Compare</button>`;
          html += `<button class="btn-sm btn-secondary" onclick="dismissInsight('${ins.id}', this)">Dismiss</button>`;
          html += `</div>`;
          html += `</div>`;
          return html;
        }).join('');
      } catch (e) {
        body.innerHTML = `<div class="feed-empty" style="color:var(--red);">Failed to load feed: ${esc(e.message)}</div>`;
      }
    }

    async function investigateInsight(index) {
      const ins = feedInsights[index];
      if (!ins) return;

      // Mark as seen
      try {
        await fetch(`${API}/feed/${ins.id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'seen' }),
        });
      } catch(e) {}

      // Switch to analyze tab
      switchToPanel('analyze', document.querySelector('.tabs > .tab[data-panel="analyze"]'));

      // Set question and run analysis with insight as parent finding
      const q = `Investigate: ${ins.title} â€” ${ins.description}`;
      document.getElementById('question').value = q;
      runAnalysis({
        type: ins.insight_type,
        description: ins.description,
        business_impact: ins.suggested_actions?.[0] || '',
      });
    }

    async function dismissInsight(insightId, btn) {
      try {
        await fetch(`${API}/feed/${insightId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'dismissed' }),
        });
        // Remove card from DOM
        const card = btn.closest('.feed-card');
        if (card) card.remove();
        toast('Insight dismissed');
      } catch (e) {
        toast('Failed to dismiss: ' + e.message);
      }
    }

    async function dismissAllInsights() {
      const cards = document.querySelectorAll('.feed-card');
      if (!cards.length) { toast('No insights to dismiss'); return; }
      const btn = document.getElementById('dismiss-all-btn');
      btn.disabled = true;
      btn.textContent = 'Dismissing...';
      try {
        await apiFetch(`${API}/feed/dismiss-all`, { method: 'POST' });
        feedInsights = [];
        document.getElementById('feed-body').innerHTML =
          '<div class="feed-empty">All insights dismissed. Run a new scan to discover fresh insights.</div>';
        toast('All insights dismissed');
      } catch (e) {
        toast('Failed to dismiss all: ' + e.message);
      }
      btn.disabled = false;
      btn.textContent = 'Dismiss All';
    }

    // -----------------------------------------------------------------------
    // Insight Comparison Mode
    // -----------------------------------------------------------------------
    let compareSelection = [];

    function toggleCompare(index, btn) {
      const existing = compareSelection.indexOf(index);
      if (existing >= 0) {
        compareSelection.splice(existing, 1);
        btn.style.background = '';
        btn.textContent = 'Compare';
      } else {
        if (compareSelection.length >= 2) {
          toast('Already selected 2 insights. Click Compare on a selected one to deselect.');
          return;
        }
        compareSelection.push(index);
        btn.style.background = 'var(--accent)';
        btn.style.color = '#fff';
        btn.textContent = 'Selected';
      }

      if (compareSelection.length === 2) {
        showComparisonView(compareSelection[0], compareSelection[1]);
      }
    }

    function showComparisonView(idxA, idxB) {
      const a = feedInsights[idxA];
      const b = feedInsights[idxB];
      if (!a || !b) return;

      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = 'Insight Comparison';

      let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">';

      for (const ins of [a, b]) {
        const borderColor = ins.severity === 'critical' ? 'var(--red)' :
                            ins.severity === 'warning' ? 'var(--yellow)' : 'var(--green)';
        html += `<div class="feed-card" style="border-left:3px solid ${borderColor};">`;
        html += `<div style="font-size:0.65rem;text-transform:uppercase;color:${borderColor};font-weight:600;">${esc(ins.severity)} / ${esc(ins.insight_type)}</div>`;
        html += `<div style="font-weight:600;margin:0.3rem 0;">${esc(ins.title)}</div>`;
        html += `<div style="font-size:0.75rem;color:var(--muted);">${esc(ins.description)}</div>`;
        html += `<div style="margin-top:0.4rem;font-size:0.7rem;">`;
        html += `<strong>Impact:</strong> ${ins.impact_score}/100<br>`;
        html += `<strong>Tables:</strong> ${(ins.source_tables||[]).join(', ')}<br>`;
        html += `<strong>Columns:</strong> ${(ins.source_columns||[]).join(', ')}<br>`;
        if (ins.composite_template) html += `<strong>Template:</strong> ${esc(ins.composite_template)}<br>`;
        if (ins.suggested_actions?.length) {
          html += `<strong>Actions:</strong><br>`;
          ins.suggested_actions.forEach(a => { html += `&nbsp;&nbsp;- ${esc(a)}<br>`; });
        }
        html += `</div></div>`;
      }
      html += '</div>';

      // Differences summary
      html += '<div style="margin-top:1rem;padding:0.8rem;background:var(--surface);border-radius:8px;font-size:0.75rem;">';
      html += '<strong>Key Differences:</strong><br>';
      if (a.severity !== b.severity) html += `Severity: ${a.severity} vs ${b.severity}<br>`;
      if (a.impact_score !== b.impact_score) html += `Impact: ${a.impact_score} vs ${b.impact_score} (delta: ${Math.abs(a.impact_score - b.impact_score)})<br>`;
      if (a.insight_type !== b.insight_type) html += `Type: ${a.insight_type} vs ${b.insight_type}<br>`;
      const tablesA = new Set(a.source_tables || []);
      const tablesB = new Set(b.source_tables || []);
      const shared = [...tablesA].filter(t => tablesB.has(t));
      if (shared.length > 0) html += `Shared tables: ${shared.join(', ')}<br>`;
      else html += `No shared tables<br>`;
      html += '</div>';

      html += '<div style="margin-top:0.8rem;text-align:center;">';
      html += '<button onclick="clearComparison()" style="padding:6px 16px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Close</button>';
      html += '</div>';

      body.innerHTML = html;
      overlay.style.display = 'block';
    }

    function clearComparison() {
      compareSelection = [];
      document.getElementById('time-analysis-overlay').style.display = 'none';
      // Reset all compare buttons
      document.querySelectorAll('.feed-card-actions button').forEach(btn => {
        if (btn.textContent === 'Selected') {
          btn.style.background = '';
          btn.style.color = '';
          btn.textContent = 'Compare';
        }
      });
    }

    async function loadDashboardKPIs() {
      const container = document.getElementById('dashboard-kpis');
      const res = await fetch(`${API}/dashboard/summary`);
      const s = res.ok ? await res.json() : null;
      if (!s || s.total_tables === 0) { container.style.display = 'none'; return; }

      container.style.display = 'grid';
      container.style.gridTemplateColumns = 'repeat(auto-fit, minmax(140px, 1fr))';
      container.style.gap = '0.5rem';

      const kpis = [
        { label: 'Tables', value: s.total_tables, icon: '#' },
        { label: 'Rows', value: s.total_rows >= 1000 ? (s.total_rows / 1000).toFixed(1) + 'K' : s.total_rows, icon: '=' },
        { label: 'Columns', value: s.total_columns, icon: '|' },
        { label: 'Insights', value: s.total_insights, icon: '!' },
        { label: 'Reports', value: s.total_reports, icon: '>' },
        { label: 'Quality', value: s.avg_quality_score + '%', icon: 'Q' },
        { label: 'Freshness', value: s.data_freshness_pct + '%', icon: 'F' },
      ];

      container.innerHTML = kpis.map(k => `
        <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.7rem;text-align:center;">
          <div style="font-size:1.1rem;font-weight:700;color:var(--accent);">${k.value}</div>
          <div style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;">${k.label}</div>
        </div>
      `).join('');

      // Severity mini-bar if insights exist
      if (s.total_insights > 0 && s.severity_breakdown) {
        const sev = s.severity_breakdown;
        const total = s.total_insights;
        const critPct = ((sev.critical || 0) / total * 100).toFixed(0);
        const warnPct = ((sev.warning || 0) / total * 100).toFixed(0);
        const infoPct = ((sev.info || 0) / total * 100).toFixed(0);
        container.insertAdjacentHTML('afterend', `
          <div style="display:flex;height:4px;border-radius:2px;overflow:hidden;margin-bottom:0.5rem;">
            <div style="width:${critPct}%;background:#ef4444;" title="${sev.critical || 0} critical"></div>
            <div style="width:${warnPct}%;background:#f59e0b;" title="${sev.warning || 0} warning"></div>
            <div style="width:${infoPct}%;background:#10b981;" title="${sev.info || 0} info"></div>
          </div>
        `);
      }
    }

    async function loadRecommendations() {
      const container = document.getElementById('recommendations-bar');
      try {
        const data = await apiFetch(API + '/recommendations');
        if (!data.recommendations || data.recommendations.length === 0) {
          container.style.display = 'none';
          return;
        }

        container.style.display = 'block';
        let html = `<div style="font-size:0.7rem;font-weight:600;margin-bottom:4px;color:var(--accent);">Suggested Analyses (${data.coverage?.coverage_pct || 0}% coverage)</div>`;
        html += `<div style="display:flex;gap:0.4rem;overflow-x:auto;padding-bottom:4px;">`;
        for (const r of data.recommendations.slice(0, 5)) {
          const typeColor = r.analysis_type === 'anomaly' ? 'var(--red)' :
                           r.analysis_type === 'correlation' ? 'var(--accent)' :
                           r.analysis_type === 'benchmark' ? 'var(--green)' : 'var(--yellow)';
          html += `<div style="flex:0 0 auto;background:var(--surface);border:1px solid var(--border);border-top:3px solid ${typeColor};border-radius:6px;padding:6px 10px;min-width:160px;font-size:0.65rem;cursor:default;">`;
          html += `<div style="font-weight:600;margin-bottom:2px;">${esc(r.title)}</div>`;
          html += `<div style="color:var(--muted);">${esc(r.reason)}</div>`;
          html += `</div>`;
        }
        html += `</div>`;
        container.innerHTML = html;
      } catch (e) {
        container.style.display = 'none';
      }
    }

    async function triggerDiscovery() {
      const btn = document.getElementById('scan-btn');
      btn.disabled = true;
      btn.textContent = 'Scanning...';

      try {
        await fetch(`${API}/discovery/trigger`, { method: 'POST' });
        toast('Discovery scan started');

        // Poll for completion
        let attempts = 0;
        const poll = setInterval(async () => {
          attempts++;
          try {
            const data = await apiFetch(`${API}/discovery/status`);
            if (data.status === 'completed' || data.status === 'failed' || attempts > 60) {
              clearInterval(poll);
              btn.disabled = false;
              btn.textContent = 'Scan Now';
              if (data.status === 'completed') {
                toast(`Discovery complete: ${data.insights_found} insights found`);
              } else if (data.status === 'failed') {
                toast('Discovery failed: ' + (data.error || 'Unknown error'));
              }
              await loadFeed();
            }
          } catch(e) {
            clearInterval(poll);
            btn.disabled = false;
            btn.textContent = 'Scan Now';
          }
        }, 2000);
      } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Scan Now';
        toast('Failed to trigger discovery: ' + e.message);
      }
    }

    function _timeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    // Auto-load feed on page load and tab click
    // Dirty flag: reload feed when switching to it after data changes
    let feedDirty = false;
    function markFeedDirty() { feedDirty = true; }
    document.querySelector('[data-panel="feed"]').addEventListener('click', () => {
      if (feedDirty) { feedDirty = false; loadFeed(); }
      else { loadFeed(); }
    });
    loadFeed();

    // ---------------------------------------------------------------------------
    // Reports
    // ---------------------------------------------------------------------------
    let _deployInsightId = null;
    let _deployInsightData = null;

    function showDeployModal(insightId, title) {
      _deployInsightId = insightId;
      document.getElementById('deploy-name').value = title || '';

      // Populate Step 1: Review
      const ins = feedInsights.find(i => i.id === insightId);
      _deployInsightData = ins;
      const summaryEl = document.getElementById('deploy-summary');
      if (ins) {
        let summary = `<div style="font-weight:600;margin-bottom:0.3rem;">${esc(ins.title)}</div>`;
        summary += `<div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.3rem;">${esc(ins.description)}</div>`;
        summary += `<div style="display:flex;gap:0.5rem;flex-wrap:wrap;font-size:0.68rem;">`;
        summary += `<span class="badge badge-accent">${esc(ins.insight_type)}</span>`;
        summary += `<span class="badge badge-yellow">${esc(ins.severity)}</span>`;
        summary += `<span class="badge badge-green">Score: ${ins.impact_score}</span>`;
        if (ins.source_tables?.length) {
          ins.source_tables.forEach(t => { summary += `<span class="table-chip">${esc(t)}</span>`; });
        }
        summary += `</div>`;
        summaryEl.innerHTML = summary;
      } else {
        summaryEl.innerHTML = `<div style="font-weight:600;">${esc(title || 'Analysis Report')}</div><div style="font-size:0.72rem;color:var(--muted);">Deploying from analysis results.</div>`;
      }

      // Populate Step 2: Pipeline
      const pipelineDetails = document.getElementById('deploy-pipeline-details');
      const pipelineSource = document.getElementById('pipeline-source');
      if (ins?.source_tables?.length) {
        if (pipelineSource) pipelineSource.textContent = ins.source_tables[0];
        let details = 'This report will:<br>';
        details += `&#10003; Run the saved query on "${esc(ins.source_tables.join(', '))}" table(s)<br>`;
        details += `&#10003; Detect ${esc(ins.insight_type)} patterns<br>`;
        details += `&#10003; Generate trend analysis<br>`;
        details += `&#10003; Save results for ongoing tracking`;
        pipelineDetails.innerHTML = details;
      } else {
        if (pipelineSource) pipelineSource.textContent = 'Data Source';
        pipelineDetails.innerHTML = 'This report will:<br>&#10003; Run the analysis query<br>&#10003; Save and track results over time<br>&#10003; Auto-refresh based on your configured schedule';
      }

      // Show step 1
      goDeployStep(1);
      document.getElementById('deploy-modal').classList.add('active');
    }

    function goDeployStep(step) {
      ['deploy-review', 'deploy-pipeline', 'deploy-configure'].forEach((id, i) => {
        const el = document.getElementById(id);
        if (el) el.style.display = (i + 1) === step ? '' : 'none';
      });
      ['deploy-step-1', 'deploy-step-2', 'deploy-step-3'].forEach((id, i) => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('active', 'completed');
          if (i + 1 === step) el.classList.add('active');
          else if (i + 1 < step) el.classList.add('completed');
        }
      });
    }

    function closeDeployModal() {
      document.getElementById('deploy-modal').classList.remove('active');
      _deployInsightId = null;
      _deployInsightData = null;
    }

    document.getElementById('deploy-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('deploy-modal')) closeDeployModal();
    });

    async function confirmDeploy() {
      if (!_deployInsightId) return;
      const name = document.getElementById('deploy-name').value.trim();
      if (!name) { toast('Enter a report name'); return; }

      const freq = document.querySelector('input[name="deploy-freq"]:checked')?.value || 'manual';

      try {
        const data = await apiFetch(`${API}/feed/${_deployInsightId}/deploy`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, refresh_frequency: freq }),
        });
        if (data.error) {
          toast('Deploy failed: ' + data.error);
        } else {
          closeDeployModal();
          showDeploySuccess(name, data.report_id);
        }
      } catch (e) {
        toast('Deploy failed: ' + e.message);
      }
    }

    let _lastDeployedReportId = null;

    function showDeploySuccess(name, reportId) {
      _lastDeployedReportId = reportId;
      const el = document.getElementById('deploy-success');
      const nameEl = document.getElementById('deploy-success-name');
      if (nameEl) nameEl.textContent = `"${name}" is now live.`;
      if (el) { el.style.display = 'flex'; }
      // Auto-close after 5 seconds
      setTimeout(closeDeploySuccess, 5000);
    }

    function closeDeploySuccess() {
      const el = document.getElementById('deploy-success');
      if (el) el.style.display = 'none';
      switchToPanel('reports', document.querySelector('.tabs > .tab[data-panel="reports"]'));
      loadReports();
    }

    function viewDeployedReport() {
      closeDeploySuccess();
      if (_lastDeployedReportId) viewReport(_lastDeployedReportId);
    }

    async function loadReports() {
      const body = document.getElementById('reports-body');
      body.innerHTML = '<p style="color:var(--muted)"><span class="spinner"></span> Loading...</p>';

      try {
        const reports = await apiFetch(`${API}/reports`);

        if (!reports.length) {
          body.innerHTML = '<div class="feed-empty">No deployed reports yet. Deploy insights from the Feed tab.</div>';
          return;
        }

        body.innerHTML = reports.map(r => {
          let html = `<div class="report-card">`;
          html += `<div class="report-card-header">`;
          html += `<span class="report-card-title">${esc(r.name)}</span>`;
          html += `<span class="badge badge-green">Active</span>`;
          html += `</div>`;
          html += `<div class="report-card-meta">`;
          if (r.last_run_at) html += `Last updated: ${_timeAgo(new Date(r.last_run_at))}`;
          if (r.last_result && Array.isArray(r.last_result)) {
            html += ` | ${r.last_result.length} rows`;
          }
          html += `</div>`;
          html += `<div class="report-card-actions">`;
          html += `<button class="btn-sm" onclick="viewReport('${r.id}')">View Full Report</button>`;
          html += `<button class="btn-sm btn-secondary" onclick="refreshReport('${r.id}', this)">Refresh Now</button>`;
          html += `<button class="btn-sm btn-secondary" onclick="exportReport('${r.id}', 'json')">Export JSON</button>`;
          html += `<button class="btn-sm btn-secondary" onclick="exportReport('${r.id}', 'csv')">Export CSV</button>`;
          html += `<button class="btn-sm btn-secondary" style="color:var(--red);" onclick="removeReport('${r.id}', this)">Remove</button>`;
          html += `</div>`;
          html += `</div>`;
          return html;
        }).join('');
      } catch (e) {
        body.innerHTML = `<div class="feed-empty" style="color:var(--red);">Failed to load reports: ${esc(e.message)}</div>`;
      }
    }

    async function viewReport(reportId) {
      const modal = document.getElementById('data-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      title.textContent = 'Report';
      body.innerHTML = '<p><span class="spinner"></span> Loading...</p>';
      modal.classList.add('active');

      try {
        const report = await apiFetch(`${API}/reports/${reportId}`);

        if (report.error) {
          body.innerHTML = `<p style="color:var(--red);">${esc(report.error)}</p>`;
          return;
        }

        title.textContent = report.name;
        let html = '';

        // Chart if chart_spec available
        if (report.chart_spec && report.last_result && Array.isArray(report.last_result)) {
          html += `<div class="report-view-section"><h4>Chart</h4><div id="report-chart-area"></div></div>`;
        }

        // Data table
        if (report.last_result && Array.isArray(report.last_result) && report.last_result.length) {
          html += `<div class="report-view-section"><h4>Data (${report.last_result.length} rows)</h4>`;
          html += renderTable(report.last_result, 20);
          html += `</div>`;
        }

        // Query
        if (report.query) {
          html += `<div class="report-view-section"><h4>Query</h4><div class="sql-block">${esc(report.query)}</div></div>`;
        }

        // Timestamp
        html += `<div class="report-view-section"><h4>Last Updated</h4><p style="font-size:0.78rem;color:var(--muted);">${report.last_run_at || 'Never'}</p></div>`;

        body.innerHTML = html;

        // Render chart if spec exists
        if (report.chart_spec && report.last_result && Array.isArray(report.last_result)) {
          const area = document.getElementById('report-chart-area');
          if (area) {
            _renderChart(area, report.chart_spec, report.last_result);
          }
        }
      } catch (e) {
        body.innerHTML = `<p style="color:var(--red);">${esc(e.message)}</p>`;
      }
    }

    async function refreshReport(reportId, btn) {
      btn.disabled = true;
      btn.textContent = 'Refreshing...';
      try {
        const data = await apiFetch(`${API}/reports/${reportId}/refresh`, { method: 'POST' });
        if (data.error) {
          toast('Refresh failed: ' + data.error);
        } else {
          toast('Report refreshed');
          loadReports();
        }
      } catch (e) {
        toast('Refresh failed: ' + e.message);
      }
      btn.disabled = false;
      btn.textContent = 'Refresh Now';
    }

    async function removeReport(reportId, btn) {
      try {
        await fetch(`${API}/reports/${reportId}`, { method: 'DELETE' });
        const card = btn.closest('.report-card');
        if (card) card.remove();
        toast('Report removed');
      } catch (e) {
        toast('Remove failed: ' + e.message);
      }
    }

    async function exportReport(reportId, format) {
      try {
        const resp = await fetch(`${API}/reports/${reportId}/export?format=${format}`);
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${reportId.substring(0, 8)}.${format === 'csv' ? 'csv' : 'json'}`;
        a.click();
        URL.revokeObjectURL(url);
        toast(`Report exported as ${format.toUpperCase()}`);
      } catch (e) {
        toast('Export failed: ' + e.message);
      }
    }

    // Auto-load reports on tab click
    document.querySelector('[data-panel="reports"]').addEventListener('click', loadReports);

    // ---------------------------------------------------------------------------
    // Smart Question Suggestions
    // ---------------------------------------------------------------------------
    async function loadSuggestions() {
      try {
        const data = await apiFetch(`${API}/suggestions`);
        const pills = document.getElementById('suggestion-pills');

        if (data.suggestions?.length) {
          pills.innerHTML = data.suggestions.map(s =>
            `<button class="suggestion-pill" onclick="useSuggestion(this)">${esc(s)}</button>`
          ).join('');
        } else {
          pills.innerHTML = '';
        }
      } catch (e) {
        // Silently fail â€” suggestions are a nice-to-have
      }
    }

    function useSuggestion(btn) {
      document.getElementById('question').value = btn.textContent;
      runAnalysis();
    }

    // Load suggestions when Analyze tab is clicked
    document.querySelector('[data-panel="analyze"]').addEventListener('click', loadSuggestions);

    // ---------------------------------------------------------------------------
    // Export â€” PDF & CSV (Client-side)
    // ---------------------------------------------------------------------------
    function exportCSV() {
      if (!lastAnalysisData) { toast('No analysis data to export'); return; }

      const sqlResults = lastAnalysisData.sql_results || (lastAnalysisData.sql_result ? [lastAnalysisData.sql_result] : []);
      const allRows = sqlResults.flatMap(sr => sr.rows || []);

      if (!allRows.length) { toast('No data rows to export'); return; }

      const keys = Object.keys(allRows[0]);
      let csv = keys.join(',') + '\n';
      allRows.forEach(row => {
        csv += keys.map(k => {
          const val = String(row[k] ?? '');
          return val.includes(',') || val.includes('"') || val.includes('\n')
            ? '"' + val.replace(/"/g, '""') + '"'
            : val;
        }).join(',') + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'business_brain_export.csv';
      a.click();
      URL.revokeObjectURL(url);
      toast('CSV exported');
    }

    async function exportPDF() {
      if (!lastAnalysisData) { toast('No analysis data to export'); return; }

      // Use html2canvas + jsPDF for PDF generation
      try {
        // Dynamically load libraries if not present
        if (!window.html2canvas) {
          await _loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
        }
        if (!window.jspdf) {
          await _loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        }

        const element = document.getElementById('analyze-body');
        const canvas = await html2canvas(element, {
          backgroundColor: '#0a0a0f',
          scale: 2,
        });
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, Math.min(pdfHeight, pdf.internal.pageSize.getHeight()));
        pdf.save('business_brain_report.pdf');
        toast('PDF exported');
      } catch (e) {
        toast('PDF export failed: ' + e.message);
      }
    }

    function _loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function exportFeed(format) {
      format = format || 'json';
      try {
        if (format === 'csv') {
          // Client-side CSV generation from feedInsights
          if (!feedInsights || feedInsights.length === 0) {
            toast('No insights to export');
            return;
          }
          const headers = ['id','insight_type','severity','impact_score','title','description','source_tables','source_columns','status','discovered_at'];
          const rows = feedInsights.map(ins => headers.map(h => {
            let val = ins[h];
            if (Array.isArray(val)) val = val.join('; ');
            if (val === null || val === undefined) val = '';
            return '"' + String(val).replace(/"/g, '""') + '"';
          }).join(','));
          const csv = headers.join(',') + '\n' + rows.join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'insights_feed.csv';
          a.click();
          URL.revokeObjectURL(url);
          toast('Feed exported as CSV');
        } else {
          const resp = await fetch(API + '/feed/export');
          if (!resp.ok) throw new Error('Failed to fetch');
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'insights_feed.json';
          a.click();
          URL.revokeObjectURL(url);
          toast('Feed exported as JSON');
        }
      } catch (e) {
        toast('Feed export failed: ' + e.message);
      }
    }

    // -----------------------------------------------------------------------
    // v3: Feed Filters
    // -----------------------------------------------------------------------
    let currentFeedFilter = 'all';
    function filterFeed(filter, btn) {
      currentFeedFilter = filter;
      document.querySelectorAll('.feed-filter').forEach(f => f.classList.remove('active'));
      if (btn) btn.classList.add('active');
      // Re-render feed with filter
      const cards = document.querySelectorAll('.feed-card');
      cards.forEach(card => {
        const type = card.dataset.type || '';
        if (filter === 'all') { card.style.display = ''; }
        else if (filter === 'alert') { card.style.display = type === 'alert' ? '' : 'none'; }
        else if (filter === 'insight') { card.style.display = (type !== 'alert' && type !== 'sanctity') ? '' : 'none'; }
        else if (filter === 'sanctity') { card.style.display = type === 'sanctity' ? '' : 'none'; }
      });
    }

    function filterFeedByStatus(status, btn) {
      document.querySelectorAll('.feed-filter').forEach(f => f.classList.remove('active'));
      if (btn) btn.classList.add('active');
      const cards = document.querySelectorAll('.feed-card');
      cards.forEach(card => {
        const cardStatus = card.dataset.status || 'new';
        card.style.display = cardStatus === status ? '' : 'none';
      });
    }

    // -----------------------------------------------------------------------
    // Data Quality Tab
    // -----------------------------------------------------------------------
    async function loadDataQuality() {
      const body = document.getElementById('quality-body');
      body.innerHTML = '<div class="feed-empty">Loading quality scores...</div>';

      try {
        const scores = await apiFetch(API + '/data-quality');

        if (!scores.length || scores.error) {
          body.innerHTML = '<div class="feed-empty">No profiled tables found. Upload data and run a discovery scan first.</div>';
          return;
        }

        let html = '';
        for (const s of scores) {
          const scoreColor = s.score >= 80 ? 'var(--green)' : s.score >= 50 ? 'var(--yellow)' : 'var(--red)';
          html += `<div class="feed-card" style="border-left:3px solid ${scoreColor}">`;
          html += `<div style="display:flex;justify-content:space-between;align-items:center;">`;
          html += `<div><strong>${esc(s.table_name)}</strong>`;
          html += ` <span class="badge badge-blue">${esc(s.domain_hint || 'general')}</span>`;
          html += ` <span style="color:var(--muted);font-size:0.7rem;">${s.row_count} rows</span></div>`;
          html += `<div style="font-size:1.3rem;font-weight:700;color:${scoreColor};">${s.score}/100</div>`;
          html += `</div>`;

          // Breakdown bars
          html += `<div style="display:flex;gap:0.8rem;margin-top:0.6rem;font-size:0.7rem;">`;
          for (const [k, v] of Object.entries(s.breakdown || {})) {
            const barColor = v >= 80 ? 'var(--green)' : v >= 50 ? 'var(--yellow)' : 'var(--red)';
            html += `<div style="flex:1;">`;
            html += `<div style="color:var(--muted);margin-bottom:2px;">${k}</div>`;
            html += `<div style="background:var(--border);border-radius:3px;height:6px;overflow:hidden;">`;
            html += `<div style="width:${v}%;height:100%;background:${barColor};border-radius:3px;"></div>`;
            html += `</div>`;
            html += `<div style="text-align:right;color:var(--muted);font-size:0.6rem;">${v}</div>`;
            html += `</div>`;
          }
          html += `</div>`;

          // Issues
          if (s.issues && s.issues.length > 0) {
            html += `<div style="margin-top:0.5rem;font-size:0.7rem;">`;
            for (const issue of s.issues.slice(0, 3)) {
              html += `<div style="color:var(--red);margin-top:2px;">- ${esc(issue)}</div>`;
            }
            if (s.issues.length > 3) {
              html += `<div style="color:var(--muted);margin-top:2px;">...and ${s.issues.length - 3} more</div>`;
            }
            html += `</div>`;
          }

          // Action buttons
          html += `<div style="margin-top:0.6rem;display:flex;gap:0.4rem;">`;
          html += `<button onclick="loadTimeAnalysis('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Time Analysis</button>`;
          html += `<button onclick="loadColumnStats('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Column Stats</button>`;
          html += `<button onclick="loadForecast('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Forecast</button>`;
          html += `<button onclick="loadCorrelations('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Correlations</button>`;
          html += `<button onclick="loadDistribution('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Distribution</button>`;
          html += `<button onclick="loadAnomalyClassifier('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Anomalies</button>`;
          html += `<button onclick="loadProfileReport('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Report</button>`;
          html += `<button onclick="loadBenchmark('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Benchmark</button>`;
          html += `<button onclick="loadValidation('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Validate</button>`;
          html += `<button onclick="loadKPIs('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">KPIs</button>`;
          html += `<button onclick="loadPareto('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Pareto</button>`;
          html += `<button onclick="loadStatSummary('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Stats</button>`;
          html += `</div>`;
          html += `<div style="margin-top:0.3rem;display:flex;gap:0.4rem;flex-wrap:wrap;">`;
          html += `<button onclick="loadSegmentation('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Segment</button>`;
          html += `<button onclick="loadDecompose('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Decompose</button>`;
          html += `<button onclick="loadDataDictionary('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Dictionary</button>`;
          html += `<button onclick="loadQualityScore('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Quality Score</button>`;
          html += `<button onclick="loadABC('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">ABC</button>`;
          html += `<button onclick="loadRollingStats('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Rolling</button>`;
          html += `<button onclick="loadPivot('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Pivot</button>`;
          html += `</div>`;
          // Row 3: Manufacturing analytics
          html += `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">`;
          html += `<button onclick="loadCostBreakdown('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Costs</button>`;
          html += `<button onclick="loadDowntime('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Downtime</button>`;
          html += `<button onclick="loadCapacity('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Capacity</button>`;
          html += `<button onclick="loadOEE('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">OEE</button>`;
          html += `<button onclick="loadShiftPerf('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Shifts</button>`;
          html += `<button onclick="loadInventoryHealth('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Inventory</button>`;
          html += `</div>`;
          // Row 4: Steel / Plant analytics
          html += `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">`;
          html += `<button onclick="loadHeatAnalysis('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Heats</button>`;
          html += `<button onclick="loadChemistry('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Chemistry</button>`;
          html += `<button onclick="loadGateTraffic('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Gate</button>`;
          html += `<button onclick="loadWeighbridge('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Weighbridge</button>`;
          html += `<button onclick="loadEmissions('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Emissions</button>`;
          html += `<button onclick="loadMaintenanceHistory('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Maint.</button>`;
          html += `</div>`;
          // Row 5: Contract / Budget / Demand
          html += `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">`;
          html += `<button onclick="loadContracts('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Contracts</button>`;
          html += `<button onclick="loadBudgetVsActual('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Budget</button>`;
          html += `<button onclick="loadBurnRate('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Burn Rate</button>`;
          html += `<button onclick="loadDemandPattern('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Demand</button>`;
          html += `<button onclick="loadDemandSeasonality('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Seasonality</button>`;
          html += `</div>`;
          // Row 6: Procurement / Finance / Projects
          html += `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">`;
          html += `<button onclick="loadPurchaseOrders('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">POs</button>`;
          html += `<button onclick="loadPriceVariance('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Price Var.</button>`;
          html += `<button onclick="loadVendorPerf('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Vendor Perf</button>`;
          html += `<button onclick="loadProfitability('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Profitability</button>`;
          html += `<button onclick="loadProjectStatus('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Projects</button>`;
          html += `<button onclick="loadProjectHealth('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Proj Health</button>`;
          html += `</div>`;
          // Row 7: SCADA / Customers / Sales
          html += `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">`;
          html += `<button onclick="loadSensorReadings('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Sensors</button>`;
          html += `<button onclick="loadAlarms('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Alarms</button>`;
          html += `<button onclick="loadCustomerSegments('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Customers</button>`;
          html += `<button onclick="loadChurnRisk('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Churn</button>`;
          html += `<button onclick="loadSalesPerf('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Sales</button>`;
          html += `<button onclick="loadProductMix('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Prod Mix</button>`;
          html += `<button onclick="loadDiscounts('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Discounts</button>`;
          html += `</div>`;
          // Row 8: Cash Flow / Risk / Compliance / Assets / Pricing / HR
          html += `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">`;
          html += `<button onclick="loadCashFlow('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Cash Flow</button>`;
          html += `<button onclick="loadWorkingCapital('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Working Cap</button>`;
          html += `<button onclick="loadRiskAssessment('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Risks</button>`;
          html += `<button onclick="loadComplianceStatus('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Compliance</button>`;
          html += `<button onclick="loadAssetAge('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Assets</button>`;
          html += `<button onclick="loadPriceDistribution('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Pricing</button>`;
          html += `<button onclick="loadAttritionRate('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Attrition</button>`;
          html += `<button onclick="loadAttritionDrivers('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">HR Drivers</button>`;
          html += `</div>`;
          // Row 9: Revenue / Aging / Pipeline / Basket / SLA / Geo
          html += `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">`;
          html += `<button onclick="loadRevenueForecast('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Revenue</button>`;
          html += `<button onclick="loadReceivablesAging('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">AR Aging</button>`;
          html += `<button onclick="loadPipelineStages('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Pipeline</button>`;
          html += `<button onclick="loadWinRate('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Win Rate</button>`;
          html += `<button onclick="loadProductAssociations('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Basket</button>`;
          html += `<button onclick="loadSLACompliance('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">SLA</button>`;
          html += `<button onclick="loadRegionalDistribution('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Regions</button>`;
          html += `<button onclick="loadGeoGrowth('${esc(s.table_name)}')" style="font-size:0.65rem;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;">Geo Growth</button>`;
          html += `</div>`;

          html += `</div>`;
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error loading quality data: ${esc(err.message)}</div>`;
      }
    }

    document.querySelector('[data-panel="quality"]').addEventListener('click', loadDataQuality);

    async function loadTimeAnalysis(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Time Analysis: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Analyzing trends...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/time-analysis`, {method: 'POST'});

        if (!data.analysis || data.analysis.length === 0) {
          body.innerHTML = `<div class="feed-empty">${esc(data.message || 'No temporal+numeric column pairs found for time analysis.')}</div>`;
          return;
        }

        let html = `<div style="font-size:0.75rem;color:var(--muted);margin-bottom:0.8rem;">Temporal columns: ${(data.temporal_columns||[]).join(', ')}</div>`;

        for (const a of data.analysis) {
          const trendColor = a.trend.direction === 'increasing' ? 'var(--green)' :
                             a.trend.direction === 'decreasing' ? 'var(--red)' :
                             a.trend.direction === 'stable' ? 'var(--muted)' : 'var(--yellow)';
          const trendIcon = a.trend.direction === 'increasing' ? '&#9650;' :
                            a.trend.direction === 'decreasing' ? '&#9660;' :
                            a.trend.direction === 'stable' ? '&#8212;' : '&#8776;';

          html += `<div class="feed-card" style="border-left:3px solid ${trendColor};">`;
          html += `<div style="display:flex;justify-content:space-between;align-items:center;">`;
          html += `<strong>${esc(a.column)}</strong>`;
          html += `<span style="color:${trendColor};font-size:1.1rem;">${trendIcon} ${esc(a.trend.direction)}</span>`;
          html += `</div>`;
          html += `<div style="font-size:0.7rem;color:var(--muted);margin-top:0.3rem;">`;
          html += `Magnitude: ${a.trend.magnitude_pct_per_period}%/period | R&sup2;: ${a.trend.r_squared} | Samples: ${a.sample_count}`;
          html += `</div>`;

          if (a.latest_period_change) {
            const pc = a.latest_period_change;
            const changeColor = pc.pct_change > 0 ? 'var(--green)' : pc.pct_change < 0 ? 'var(--red)' : 'var(--muted)';
            html += `<div style="font-size:0.7rem;margin-top:0.3rem;">`;
            html += `Latest change: <span style="color:${changeColor};font-weight:600;">${pc.pct_change !== null ? pc.pct_change.toFixed(1) + '%' : 'N/A'}</span>`;
            html += ` (${pc.previous} &rarr; ${pc.current})`;
            html += `</div>`;
          }

          if (a.min_max) {
            html += `<div style="font-size:0.7rem;color:var(--muted);margin-top:0.2rem;">`;
            html += `Min: ${a.min_max.min_value} (period ${a.min_max.min_index}) | Max: ${a.min_max.max_value} (period ${a.min_max.max_index})`;
            html += `</div>`;
          }

          if (a.changepoints && a.changepoints.length > 0) {
            html += `<div style="font-size:0.7rem;color:var(--yellow);margin-top:0.2rem;">`;
            html += `Changepoints at indices: ${a.changepoints.join(', ')}`;
            html += `</div>`;
          }

          html += `</div>`;
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadColumnStats(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Column Stats: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Loading column details...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);

        if (!data.columns || data.columns.length === 0) {
          body.innerHTML = '<div class="feed-empty">No column data available.</div>';
          return;
        }

        let html = `<div style="font-size:0.75rem;color:var(--muted);margin-bottom:0.8rem;">${data.column_count} columns | ${data.row_count} rows | Domain: ${esc(data.domain_hint || 'general')}</div>`;

        html += `<table style="width:100%;font-size:0.7rem;border-collapse:collapse;">`;
        html += `<thead><tr style="border-bottom:1px solid var(--border);text-align:left;">`;
        html += `<th style="padding:4px;">Column</th><th style="padding:4px;">Type</th><th style="padding:4px;">Cardinality</th><th style="padding:4px;">Samples</th>`;
        html += `</tr></thead><tbody>`;

        for (const col of data.columns) {
          const typeColor = col.semantic_type === 'temporal' ? 'cornflowerblue' :
                            col.semantic_type?.startsWith('numeric') ? 'var(--green)' :
                            col.semantic_type === 'identifier' ? 'var(--yellow)' : 'var(--muted)';
          html += `<tr style="border-bottom:1px solid var(--border);">`;
          html += `<td style="padding:4px;font-weight:500;">${esc(col.name)}</td>`;
          html += `<td style="padding:4px;"><span style="color:${typeColor};">${esc(col.semantic_type || 'unknown')}</span></td>`;
          html += `<td style="padding:4px;">${col.cardinality || '-'}</td>`;
          html += `<td style="padding:4px;color:var(--muted);">${(col.sample_values || []).slice(0, 3).join(', ')}</td>`;
          html += `</tr>`;
        }

        html += `</tbody></table>`;
        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadForecast(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Forecast: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Computing forecasts...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/forecast`, {method: 'POST'});

        if (data.error || !data.forecasts || data.forecasts.length === 0) {
          body.innerHTML = `<div class="feed-empty">${esc(data.error || 'No forecast data available.')}</div>`;
          return;
        }

        let html = '';
        for (const f of data.forecasts) {
          const confColor = f.linear.confidence === 'high' ? 'var(--green)' :
                            f.linear.confidence === 'medium' ? 'var(--yellow)' : 'var(--red)';
          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.6rem;">`;
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.4rem;">${esc(f.column)} <span style="font-size:0.65rem;color:var(--muted);">(${f.data_points} data points)</span></div>`;

          // Linear forecast
          html += `<div style="font-size:0.72rem;margin-bottom:0.3rem;">`;
          html += `<span style="font-weight:500;">Linear:</span> `;
          html += f.linear.predicted.map((v, i) => `<span style="color:var(--accent);">+${i+1}: ${v.toLocaleString()}</span>`).join(' | ');
          html += ` <span style="color:${confColor};font-size:0.65rem;">(${f.linear.confidence})</span>`;
          html += `</div>`;

          // Exponential forecast
          html += `<div style="font-size:0.72rem;">`;
          html += `<span style="font-weight:500;">Exp. Smooth:</span> `;
          html += `<span style="color:var(--green);">${f.exponential.predicted[0]?.toLocaleString() || '-'}</span>`;
          html += ` <span style="font-size:0.65rem;color:var(--muted);">(${f.exponential.confidence})</span>`;
          html += `</div>`;

          html += `</div>`;
        }
        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadCorrelations(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Correlations: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Computing correlations...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/correlations`, {method: 'POST'});

        if (data.error) {
          body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`;
          return;
        }

        let html = '';

        // Summary
        if (data.summary) {
          const s = data.summary;
          html += `<div style="font-size:0.75rem;color:var(--muted);margin-bottom:0.8rem;">`;
          html += `${s.total_pairs} pairs analyzed | Strong: ${s.strong} | Moderate: ${s.moderate} | Weak: ${s.weak}`;
          html += `</div>`;
        }

        // Strong correlations
        if (data.strong_correlations && data.strong_correlations.length > 0) {
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.4rem;">Strong Correlations</div>`;
          for (const c of data.strong_correlations) {
            const color = c.direction === 'positive' ? 'var(--green)' : 'var(--red)';
            const arrow = c.direction === 'positive' ? '&uarr;' : '&darr;';
            html += `<div style="font-size:0.72rem;padding:4px 0;">`;
            html += `${esc(c.columns[0])} &harr; ${esc(c.columns[1])}: <span style="color:${color};font-weight:600;">${arrow} ${c.correlation.toFixed(3)}</span>`;
            html += `</div>`;
          }
        }

        // Surprising (negative) correlations
        if (data.surprising_correlations && data.surprising_correlations.length > 0) {
          html += `<div style="font-weight:600;font-size:0.8rem;margin:0.6rem 0 0.4rem;">Surprising Inverse Correlations</div>`;
          for (const c of data.surprising_correlations) {
            html += `<div style="font-size:0.72rem;padding:4px 0;color:var(--yellow);">`;
            html += `${esc(c.columns[0])} &harr; ${esc(c.columns[1])}: ${c.correlation.toFixed(3)}`;
            html += `</div>`;
          }
        }

        // Full matrix
        if (data.all_pairs && data.all_pairs.length > 0) {
          html += `<div style="font-weight:600;font-size:0.8rem;margin:0.6rem 0 0.4rem;">All Pairs</div>`;
          html += `<table style="width:100%;font-size:0.68rem;border-collapse:collapse;">`;
          html += `<thead><tr style="border-bottom:1px solid var(--border);"><th style="padding:3px;">A</th><th style="padding:3px;">B</th><th style="padding:3px;">r</th><th style="padding:3px;">Strength</th><th style="padding:3px;">N</th></tr></thead><tbody>`;
          for (const p of data.all_pairs) {
            const rColor = Math.abs(p.correlation) >= 0.7 ? 'var(--green)' : Math.abs(p.correlation) >= 0.4 ? 'var(--yellow)' : 'var(--muted)';
            html += `<tr style="border-bottom:1px solid var(--border);">`;
            html += `<td style="padding:3px;">${esc(p.columns[0])}</td>`;
            html += `<td style="padding:3px;">${esc(p.columns[1])}</td>`;
            html += `<td style="padding:3px;color:${rColor};font-weight:500;">${p.correlation.toFixed(3)}</td>`;
            html += `<td style="padding:3px;">${esc(p.strength)}</td>`;
            html += `<td style="padding:3px;">${p.sample_size}</td>`;
            html += `</tr>`;
          }
          html += `</tbody></table>`;
        }

        if (!html) html = '<div class="feed-empty">No correlation data.</div>';
        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadDistribution(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Distribution: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Analyzing distributions...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/distribution`, {method: 'POST'});

        if (data.error || !data.distributions || data.distributions.length === 0) {
          body.innerHTML = `<div class="feed-empty">${esc(data.error || 'No distribution data.')}</div>`;
          return;
        }

        let html = '';
        for (const d of data.distributions) {
          const shapeColor = d.shape === 'normal' ? 'var(--green)' :
                             d.shape === 'bimodal' ? 'var(--red)' :
                             d.shape.includes('skew') ? 'var(--yellow)' : 'var(--muted)';

          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.6rem;">`;
          html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem;">`;
          html += `<span style="font-weight:600;font-size:0.8rem;">${esc(d.column)}</span>`;
          html += `<span style="font-size:0.65rem;padding:2px 8px;border-radius:4px;background:${shapeColor}20;color:${shapeColor};">${esc(d.shape)}</span>`;
          html += `</div>`;

          // Stats row
          html += `<div style="display:flex;gap:1rem;font-size:0.7rem;color:var(--muted);flex-wrap:wrap;">`;
          html += `<span>Mean: ${d.mean.toLocaleString()}</span>`;
          html += `<span>Median: ${d.median.toLocaleString()}</span>`;
          html += `<span>Std: ${d.stdev.toLocaleString()}</span>`;
          html += `<span>Skew: ${d.skewness.toFixed(2)}</span>`;
          html += `<span>Kurt: ${d.kurtosis.toFixed(2)}</span>`;
          html += `</div>`;

          // Quartile bar
          if (d.max > d.min) {
            const range = d.max - d.min;
            const q1Pct = ((d.q1 - d.min) / range * 100);
            const medPct = ((d.median - d.min) / range * 100);
            const q3Pct = ((d.q3 - d.min) / range * 100);

            html += `<div style="margin-top:0.4rem;position:relative;height:16px;background:var(--border);border-radius:4px;">`;
            html += `<div style="position:absolute;left:${q1Pct}%;width:${q3Pct-q1Pct}%;height:100%;background:var(--accent)40;border-radius:4px;"></div>`;
            html += `<div style="position:absolute;left:${medPct}%;width:2px;height:100%;background:var(--accent);"></div>`;
            html += `</div>`;
            html += `<div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--muted);margin-top:2px;">`;
            html += `<span>${d.min.toLocaleString()}</span>`;
            html += `<span>Q1: ${d.q1.toLocaleString()}</span>`;
            html += `<span>Med: ${d.median.toLocaleString()}</span>`;
            html += `<span>Q3: ${d.q3.toLocaleString()}</span>`;
            html += `<span>${d.max.toLocaleString()}</span>`;
            html += `</div>`;
          }

          // Mini histogram
          if (d.histogram && d.histogram.length > 0) {
            const maxCount = Math.max(...d.histogram.map(h => h.count));
            html += `<div style="display:flex;gap:1px;margin-top:0.5rem;height:40px;align-items:flex-end;">`;
            for (const bin of d.histogram) {
              const pct = maxCount > 0 ? (bin.count / maxCount * 100) : 0;
              html += `<div style="flex:1;background:var(--accent);height:${pct}%;border-radius:2px 2px 0 0;" title="${bin.count} values (${bin.bin_start.toFixed(1)} - ${bin.bin_end.toFixed(1)})"></div>`;
            }
            html += `</div>`;
          }

          html += `</div>`;
        }
        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadAnomalyClassifier(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Anomaly Classification: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Classifying anomalies...</div>';
      overlay.style.display = 'block';

      try {
        // First get columns to find numeric ones
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const numericCols = (colData.columns || []).filter(c =>
          c.semantic_type && (c.semantic_type.startsWith('numeric') || c.semantic_type === 'identifier')
        ).map(c => c.name);

        if (numericCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">No numeric columns found for anomaly classification.</div>';
          return;
        }

        let html = '';
        for (const col of numericCols.slice(0, 5)) {
          const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/classify-anomalies`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({column: col, threshold_std: 2.0}),
          });

          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.6rem;">`;
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.3rem;">${esc(col)}</div>`;

          if (!data.classifications || data.classifications.length === 0) {
            html += `<div style="font-size:0.7rem;color:var(--muted);">No anomalies detected</div>`;
          } else {
            const s = data.summary;
            html += `<div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.4rem;">${esc(s.summary)}</div>`;

            // Pattern breakdown
            if (s.patterns) {
              html += `<div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.4rem;">`;
              for (const [pat, cnt] of Object.entries(s.patterns)) {
                const color = pat === 'spike' || pat === 'dip' ? 'var(--red)' :
                              pat === 'step_change' ? 'var(--yellow)' : 'var(--muted)';
                html += `<span style="font-size:0.65rem;padding:2px 6px;border-radius:4px;background:${color}20;color:${color};">${pat}: ${cnt}</span>`;
              }
              html += `</div>`;
            }

            // Top anomalies
            for (const c of data.classifications.slice(0, 3)) {
              const sevColor = c.severity === 'critical' ? 'var(--red)' :
                               c.severity === 'warning' ? 'var(--yellow)' : 'var(--muted)';
              html += `<div style="font-size:0.7rem;padding:4px 8px;border-left:3px solid ${sevColor};margin-bottom:4px;background:var(--card);">`;
              html += `<strong>${esc(c.pattern)}</strong> (score: ${c.score.toFixed(0)}) â€” ${esc(c.description)}`;
              html += `</div>`;
            }
          }
          html += `</div>`;
        }
        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadProfileReport(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Profile Report: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Generating report...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/profile-report`);
        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.6rem;">`;
        html += `<div>`;
        html += `<span style="font-size:0.75rem;font-weight:600;">Quality: ${data.quality_score}/100</span>`;
        html += `<span style="font-size:0.7rem;color:var(--muted);margin-left:0.5rem;">Priority: ${data.priority}/100</span>`;
        html += `</div>`;
        html += `<span style="font-size:0.7rem;color:var(--muted);">${data.row_count.toLocaleString()} rows, ${data.column_count} columns, ${data.domain}</span>`;
        html += `</div>`;

        // Sections
        for (const s of data.sections) {
          const borderColor = s.severity === 'critical' ? 'var(--red)' : s.severity === 'warning' ? 'var(--yellow)' : 'var(--border)';
          html += `<div style="background:var(--surface);border:1px solid var(--border);border-left:4px solid ${borderColor};border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.3rem;">${esc(s.title)}</div>`;
          html += `<pre style="font-size:0.7rem;color:var(--muted);white-space:pre-wrap;margin:0;">${esc(s.content)}</pre>`;
          html += `</div>`;
        }

        // Recommendations
        if (data.recommendations && data.recommendations.length > 0) {
          html += `<div style="background:var(--surface);border:1px solid var(--accent);border-radius:8px;padding:0.6rem 0.8rem;margin-top:0.5rem;">`;
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.3rem;color:var(--accent);">Recommendations</div>`;
          for (const rec of data.recommendations) {
            html += `<div style="font-size:0.7rem;padding:3px 0;color:var(--text);">â€¢ ${esc(rec)}</div>`;
          }
          html += `</div>`;
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadBenchmark(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Benchmark: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Analyzing benchmarks...</div>';
      overlay.style.display = 'block';

      try {
        // Get columns to find categorical + numeric pairs
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const catCols = (colData.columns || []).filter(c => c.semantic_type === 'categorical').map(c => c.name);
        const numCols = (colData.columns || []).filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (catCols.length === 0 || numCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">Need at least one categorical and one numeric column for benchmarking.</div>';
          return;
        }

        // Run benchmark for first cat Ã— first num pair
        const groupCol = catCols[0];
        const metricCol = numCols[0];
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/benchmark`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({group_column: groupCol, metric_column: metricCol}),
        });

        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        let html = `<div style="font-size:0.75rem;color:var(--muted);margin-bottom:0.6rem;">${esc(data.summary)}</div>`;

        // Ranking table
        html += `<table style="width:100%;font-size:0.7rem;border-collapse:collapse;margin-bottom:0.8rem;">`;
        html += `<thead><tr style="border-bottom:1px solid var(--border);">`;
        html += `<th style="padding:4px;text-align:left;">Rank</th><th style="padding:4px;text-align:left;">${esc(groupCol)}</th>`;
        html += `<th style="padding:4px;">Mean</th><th style="padding:4px;">Count</th><th style="padding:4px;">% of Best</th></tr></thead><tbody>`;

        for (const r of data.ranking) {
          const barW = r.pct_of_best;
          html += `<tr style="border-bottom:1px solid var(--border);">`;
          html += `<td style="padding:4px;font-weight:600;">#${r.rank}</td>`;
          html += `<td style="padding:4px;">${esc(r.group)}</td>`;
          html += `<td style="padding:4px;text-align:center;">${r.value.toLocaleString()}</td>`;
          html += `<td style="padding:4px;text-align:center;">${r.count}</td>`;
          html += `<td style="padding:4px;"><div style="display:flex;align-items:center;gap:4px;"><div style="width:${barW}%;height:8px;background:var(--accent);border-radius:4px;min-width:2px;"></div><span>${barW}%</span></div></td>`;
          html += `</tr>`;
        }
        html += `</tbody></table>`;

        // Significant gaps
        if (data.significant_gaps && data.significant_gaps.length > 0) {
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.3rem;color:var(--yellow);">Significant Gaps (>20%)</div>`;
          for (const gap of data.significant_gaps) {
            html += `<div style="font-size:0.7rem;padding:3px 0;">${esc(gap.group_a)} vs ${esc(gap.group_b)}: Î”${gap.diff.toLocaleString()} (${gap.diff_pct}%)</div>`;
          }
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadValidation(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Data Validation: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Running validation rules...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/validate`, {method: 'POST'});
        if (data.error || data.message) {
          body.innerHTML = `<div class="feed-empty">${esc(data.error || data.message)}</div>`;
          return;
        }

        const passColor = data.pass_rate >= 90 ? 'var(--green)' : data.pass_rate >= 70 ? 'var(--yellow)' : 'var(--red)';
        let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.6rem;">`;
        html += `<span style="font-size:0.8rem;font-weight:600;color:${passColor};">${data.pass_rate}% Pass Rate</span>`;
        html += `<span style="font-size:0.7rem;color:var(--muted);">${data.total_rules} rules, ${data.total_rows} rows, ${data.total_violations} violations</span>`;
        html += `</div>`;

        // Rule results
        for (const r of data.rule_results) {
          const icon = r.passed ? '<span style="color:var(--green);">PASS</span>' : '<span style="color:var(--red);">FAIL</span>';
          html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 8px;border-bottom:1px solid var(--border);font-size:0.7rem;">`;
          html += `<span>${esc(r.rule)} (${esc(r.column)}, ${esc(r.type)})</span>`;
          html += `<div>${icon}${!r.passed ? ` <span style="color:var(--muted);">${r.violation_count} issues</span>` : ''}</div>`;
          html += `</div>`;
        }

        // Sample violations
        if (data.violations && data.violations.length > 0) {
          html += `<div style="margin-top:0.6rem;font-weight:600;font-size:0.8rem;">Sample Violations</div>`;
          for (const v of data.violations.slice(0, 10)) {
            const sevColor = v.severity === 'critical' ? 'var(--red)' : v.severity === 'warning' ? 'var(--yellow)' : 'var(--muted)';
            html += `<div style="font-size:0.7rem;padding:3px 8px;border-left:3px solid ${sevColor};margin:3px 0;background:var(--card);">`;
            html += `Row ${v.row}: ${esc(v.message)}`;
            html += `</div>`;
          }
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function loadKPIs(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `KPIs: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Computing KPIs...</div>';
      overlay.style.display = 'block';

      try {
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const numCols = (colData.columns || []).filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (numCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">No numeric columns for KPI computation.</div>';
          return;
        }

        let html = '';
        for (const col of numCols.slice(0, 4)) {
          const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/kpis`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({column: col}),
          });
          if (data.error) continue;

          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.3rem;">${esc(col)} <span style="font-size:0.65rem;color:var(--muted);">(${data.total_values} values)</span></div>`;

          if (data.kpis && data.kpis.length > 0) {
            html += `<div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.3rem;">`;
            for (const k of data.kpis) {
              const statusColor = k.status === 'good' ? 'var(--green)' : k.status === 'bad' ? 'var(--red)' : 'var(--muted)';
              const trendIcon = k.trend === 'up' ? 'â†‘' : k.trend === 'down' ? 'â†“' : 'â†’';
              html += `<div style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:4px 8px;text-align:center;min-width:80px;">`;
              html += `<div style="font-size:0.9rem;font-weight:700;color:${statusColor};">${k.value}${k.unit} ${trendIcon}</div>`;
              html += `<div style="font-size:0.6rem;color:var(--muted);">${esc(k.name)}</div>`;
              html += `</div>`;
            }
            html += `</div>`;
            html += `<div style="font-size:0.65rem;color:var(--muted);">${esc(data.kpis[0].interpretation)}</div>`;
          }
          html += `</div>`;
        }
        body.innerHTML = html || '<div class="feed-empty">No KPI data.</div>';
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Pareto Analysis
    // -----------------------------------------------------------------------
    async function loadPareto(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Pareto Analysis: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Loading columns...</div>';
      overlay.style.display = 'block';

      try {
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const cols = colData.columns || [];
        const catCols = cols.filter(c => c.semantic_type && (c.semantic_type.startsWith('categorical') || c.semantic_type === 'identifier')).map(c => c.name);
        const numCols = cols.filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (catCols.length === 0 || numCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">Need at least one categorical and one numeric column for Pareto analysis.</div>';
          return;
        }

        // Pick first cat + first num as default
        const groupCol = catCols[0];
        const metricCol = numCols[0];

        body.innerHTML = '<div class="feed-empty">Computing Pareto...</div>';
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/pareto`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({group_column: groupCol, metric_column: metricCol}),
        });
        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        let html = '';
        // Summary bar
        const paretoClass = data.is_pareto ? 'color:var(--red);font-weight:700' : 'color:var(--green)';
        html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
        html += `<div style="font-size:0.75rem;margin-bottom:0.3rem;">${esc(data.summary)}</div>`;
        html += `<div style="display:flex;gap:1rem;font-size:0.7rem;">`;
        html += `<span>Total: <b>${Number(data.total).toLocaleString('en-IN')}</b></span>`;
        html += `<span style="${paretoClass}">Pareto: ${data.is_pareto ? 'Yes (80/20)' : 'No (distributed)'}</span>`;
        html += `<span>Pareto ratio: ${data.pareto_ratio?.toFixed(3) ?? '-'}</span>`;
        html += `<span>Vital few: ${data.vital_few_count} items = ${data.vital_few_contribution?.toFixed(1) ?? '-'}%</span>`;
        html += `</div></div>`;

        // Items table
        html += `<table class="result-table" style="width:100%;font-size:0.72rem;">`;
        html += `<thead><tr><th>#</th><th>${esc(groupCol)}</th><th>Value</th><th>%</th><th>Cumul %</th><th>Vital?</th></tr></thead><tbody>`;
        for (const item of data.items || []) {
          const vitalStyle = item.is_vital ? 'font-weight:700;color:var(--red);' : '';
          html += `<tr style="${vitalStyle}">`;
          html += `<td>${item.rank}</td>`;
          html += `<td>${esc(String(item.name))}</td>`;
          html += `<td>${Number(item.value).toLocaleString('en-IN')}</td>`;
          html += `<td>${item.pct.toFixed(1)}%</td>`;
          html += `<td>${item.cumulative_pct.toFixed(1)}%</td>`;
          html += `<td>${item.is_vital ? 'VITAL' : ''}</td>`;
          html += `</tr>`;

          // Cumulative bar
          html += `<tr><td colspan="6" style="padding:0;">`;
          html += `<div style="height:4px;background:var(--border);"><div style="height:100%;width:${item.cumulative_pct}%;background:${item.is_vital ? 'var(--red)' : 'var(--accent)'};"></div></div>`;
          html += `</td></tr>`;
        }
        html += `</tbody></table>`;

        // Concentration risks
        if (data.concentration_risks && data.concentration_risks.length > 0) {
          html += `<div style="margin-top:0.5rem;padding:0.5rem;background:var(--surface);border:1px solid var(--red);border-radius:6px;font-size:0.7rem;">`;
          html += `<div style="font-weight:700;color:var(--red);margin-bottom:0.3rem;">Concentration Risks</div>`;
          for (const r of data.concentration_risks) {
            html += `<div>${esc(r.name)}: ${r.pct?.toFixed(1) ?? '-'}% â€” Risk: ${r.risk_level}</div>`;
          }
          html += `</div>`;
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Statistical Summary
    // -----------------------------------------------------------------------
    async function loadStatSummary(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Statistical Summary: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Loading columns...</div>';
      overlay.style.display = 'block';

      try {
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const numCols = (colData.columns || []).filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (numCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">No numeric columns found.</div>';
          return;
        }

        let html = '';
        for (const col of numCols.slice(0, 5)) {
          body.innerHTML = `<div class="feed-empty">Computing stats for ${col}...</div>` + html;
          const s = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/stats`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({column: col}),
          });
          if (s.error) continue;

          const normalityColor = s.normality === 'normal' ? 'var(--green)' : s.normality === 'approximately_normal' ? 'var(--yellow)' : 'var(--red)';

          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.3rem;">${esc(col)}</div>`;

          // Key metrics grid
          html += `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.4rem;margin-bottom:0.3rem;font-size:0.7rem;">`;
          html += `<div><span style="color:var(--muted)">Count:</span> <b>${s.count}</b></div>`;
          html += `<div><span style="color:var(--muted)">Mean:</span> <b>${Number(s.mean).toLocaleString('en-IN', {maximumFractionDigits:2})}</b></div>`;
          html += `<div><span style="color:var(--muted)">Median:</span> <b>${Number(s.median).toLocaleString('en-IN', {maximumFractionDigits:2})}</b></div>`;
          html += `<div><span style="color:var(--muted)">Std:</span> <b>${Number(s.std).toLocaleString('en-IN', {maximumFractionDigits:2})}</b></div>`;
          html += `<div><span style="color:var(--muted)">Min:</span> <b>${Number(s.min).toLocaleString('en-IN', {maximumFractionDigits:2})}</b></div>`;
          html += `<div><span style="color:var(--muted)">Max:</span> <b>${Number(s.max).toLocaleString('en-IN', {maximumFractionDigits:2})}</b></div>`;
          html += `<div><span style="color:var(--muted)">Range:</span> <b>${Number(s.range).toLocaleString('en-IN', {maximumFractionDigits:2})}</b></div>`;
          html += `<div><span style="color:var(--muted)">CV:</span> <b>${s.cv}%</b></div>`;
          html += `<div><span style="color:var(--muted)">Q1:</span> ${Number(s.q1).toLocaleString('en-IN', {maximumFractionDigits:2})}</div>`;
          html += `<div><span style="color:var(--muted)">Q3:</span> ${Number(s.q3).toLocaleString('en-IN', {maximumFractionDigits:2})}</div>`;
          html += `<div><span style="color:var(--muted)">IQR:</span> ${Number(s.iqr).toLocaleString('en-IN', {maximumFractionDigits:2})}</div>`;
          html += `<div><span style="color:var(--muted)">Mode:</span> ${s.mode != null ? Number(s.mode).toLocaleString('en-IN', {maximumFractionDigits:2}) : '-'}</div>`;
          html += `</div>`;

          // Normality + CI
          html += `<div style="font-size:0.65rem;display:flex;gap:1rem;margin-bottom:0.2rem;">`;
          html += `<span>Normality: <b style="color:${normalityColor}">${s.normality}</b></span>`;
          html += `<span>Skew: ${s.skewness}</span>`;
          html += `<span>Kurtosis: ${s.kurtosis}</span>`;
          html += `<span>Outliers: <b>${s.outlier_count}</b></span>`;
          html += `<span>95% CI: [${Number(s.ci_95_lower).toFixed(2)}, ${Number(s.ci_95_upper).toFixed(2)}]</span>`;
          html += `</div>`;

          // Interpretation
          html += `<div style="font-size:0.65rem;color:var(--muted);border-top:1px solid var(--border);padding-top:0.3rem;margin-top:0.2rem;">${esc(s.interpretation)}</div>`;
          html += `</div>`;
        }
        body.innerHTML = html || '<div class="feed-empty">No stats computed.</div>';
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // What-If Visual Builder
    // -----------------------------------------------------------------------
    let whatIfVars = [];
    let whatIfScenarios = [];

    function addWhatIfVar(name, value, unit) {
      whatIfVars.push({ name: name || '', value: value || '', unit: unit || '' });
      renderWhatIfVars();
    }

    function removeWhatIfVar(index) {
      whatIfVars.splice(index, 1);
      renderWhatIfVars();
      renderWhatIfScenarios();
    }

    function renderWhatIfVars() {
      const tbody = document.getElementById('whatif-vars-body');
      if (!tbody) return;
      if (whatIfVars.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding:6px;color:var(--muted);font-size:0.7rem;">No variables yet. Click "+ Add Variable" to start.</td></tr>';
        return;
      }
      tbody.innerHTML = whatIfVars.map((v, i) => `
        <tr style="border-bottom:1px solid var(--border);">
          <td style="padding:3px;"><input type="text" value="${esc(v.name)}" onchange="whatIfVars[${i}].name=this.value" placeholder="variable_name" style="width:100%;padding:3px;font-size:0.72rem;background:var(--card);border:1px solid var(--border);border-radius:3px;color:var(--text);"></td>
          <td style="padding:3px;"><input type="text" value="${esc(String(v.value))}" onchange="whatIfVars[${i}].value=this.value" placeholder="0" style="width:100%;padding:3px;font-size:0.72rem;background:var(--card);border:1px solid var(--border);border-radius:3px;color:var(--text);"></td>
          <td style="padding:3px;"><input type="text" value="${esc(v.unit)}" onchange="whatIfVars[${i}].unit=this.value" placeholder="unit" style="width:60px;padding:3px;font-size:0.72rem;background:var(--card);border:1px solid var(--border);border-radius:3px;color:var(--text);"></td>
          <td style="padding:3px;"><button onclick="removeWhatIfVar(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:0.8rem;">&times;</button></td>
        </tr>
      `).join('');
    }

    function addWhatIfScenario(name) {
      const overrides = {};
      whatIfVars.forEach(v => { overrides[v.name] = ''; });
      whatIfScenarios.push({ name: name || `Scenario ${whatIfScenarios.length + 1}`, overrides });
      renderWhatIfScenarios();
    }

    function removeWhatIfScenario(index) {
      whatIfScenarios.splice(index, 1);
      renderWhatIfScenarios();
    }

    function renderWhatIfScenarios() {
      const container = document.getElementById('whatif-scenarios-visual');
      if (!container) return;
      if (whatIfScenarios.length === 0) {
        container.innerHTML = '<div style="font-size:0.7rem;color:var(--muted);padding:0.3rem 0;">No scenarios yet. Click "+ Add Scenario" to create one.</div>';
        return;
      }
      container.innerHTML = whatIfScenarios.map((s, si) => {
        let html = `<div style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:0.5rem;margin-bottom:0.4rem;">`;
        html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">`;
        html += `<input type="text" value="${esc(s.name)}" onchange="whatIfScenarios[${si}].name=this.value" style="font-size:0.72rem;font-weight:500;background:transparent;border:none;color:var(--text);outline:none;flex:1;">`;
        html += `<button onclick="removeWhatIfScenario(${si})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:0.8rem;">&times;</button>`;
        html += `</div>`;
        whatIfVars.forEach((v, vi) => {
          const overrideVal = s.overrides[v.name] || '';
          const baseVal = v.value;
          let pctChange = '';
          if (overrideVal && baseVal && parseFloat(baseVal) !== 0) {
            const pct = ((parseFloat(overrideVal) - parseFloat(baseVal)) / parseFloat(baseVal) * 100).toFixed(1);
            if (!isNaN(pct)) pctChange = `<span style="font-size:0.6rem;color:${parseFloat(pct) >= 0 ? 'var(--green)' : 'var(--red)'};">(${parseFloat(pct) >= 0 ? '+' : ''}${pct}%)</span>`;
          }
          html += `<div style="display:flex;align-items:center;gap:0.3rem;font-size:0.7rem;padding:2px 0;">`;
          html += `<span style="color:var(--muted);min-width:100px;">${esc(v.name)}:</span>`;
          html += `<span style="color:var(--muted);font-size:0.65rem;">${esc(String(baseVal))} â†’</span>`;
          html += `<input type="text" value="${esc(overrideVal)}" placeholder="unchanged"
            onchange="whatIfScenarios[${si}].overrides['${esc(v.name)}']=this.value;renderWhatIfScenarios();"
            style="width:80px;padding:2px 4px;font-size:0.7rem;background:var(--surface);border:1px solid var(--border);border-radius:3px;color:var(--text);">`;
          html += pctChange;
          if (v.unit) html += `<span style="font-size:0.6rem;color:var(--muted);">${esc(v.unit)}</span>`;
          html += `</div>`;
        });
        html += `</div>`;
        return html;
      }).join('');
    }

    function syncVisualToHidden() {
      // Sync visual builder to hidden fields for backward compat
      const base = {};
      whatIfVars.forEach(v => {
        if (v.name) base[v.name] = parseFloat(v.value) || 0;
      });
      document.getElementById('whatif-base').value = JSON.stringify(base);

      const scenarioLines = whatIfScenarios.map(s => {
        const overrides = {};
        for (const [k, v] of Object.entries(s.overrides)) {
          if (v !== '' && v !== undefined) overrides[k] = parseFloat(v) || 0;
        }
        return s.name + '=' + JSON.stringify(overrides);
      });
      document.getElementById('whatif-scenarios').value = scenarioLines.join('\n');
    }

    function syncWhatIfAndRun() { syncVisualToHidden(); runWhatIf(); }
    function syncWhatIfAndBreakeven() { syncVisualToHidden(); runBreakeven(); }
    function syncWhatIfAndSensitivity() { syncVisualToHidden(); runSensitivity(); }

    async function loadWhatIfTemplate(templateName) {
      if (templateName === 'custom') {
        whatIfVars = [];
        whatIfScenarios = [];
        document.getElementById('whatif-formula').value = '';
        addWhatIfVar();
        renderWhatIfVars();
        renderWhatIfScenarios();
        return;
      }

      // Template is an object with name, formula, base_values, scenarios
      const tpl = templateName;
      document.getElementById('whatif-formula').value = tpl.formula || '';
      whatIfVars = Object.entries(tpl.base_values || {}).map(([k, v]) => ({
        name: k,
        value: String(v),
        unit: tpl.units?.[k] || '',
      }));
      whatIfScenarios = (tpl.scenarios || []).map(s => ({
        name: s.name || 'Scenario',
        overrides: Object.fromEntries(
          Object.entries(s.parameters || {}).map(([k, v]) => [k, String(v)])
        ),
      }));
      renderWhatIfVars();
      renderWhatIfScenarios();
    }

    async function loadWhatIfTemplatesFromAPI() {
      try {
        const templates = await apiFetch(API + '/whatif/templates');
        const container = document.getElementById('whatif-templates');
        if (!container || !templates.length) return;

        // Keep existing buttons (Custom, Try Example)
        const existing = container.innerHTML;
        let html = '';
        templates.forEach(tpl => {
          html += `<button class="btn-sm btn-secondary" onclick='loadWhatIfTemplate(${JSON.stringify(tpl).replace(/'/g, "&#39;")})' style="font-size:0.68rem;">${esc(tpl.name)}</button>`;
        });
        // Insert template buttons before the existing Custom and Try Example
        container.innerHTML = html + existing;
      } catch (e) { /* templates are optional */ }
    }

    function tryWhatIfExample() {
      document.getElementById('whatif-formula').value = 'scrap_price * monthly_tonnage';
      whatIfVars = [
        { name: 'scrap_price', value: '38000', unit: 'â‚¹/ton' },
        { name: 'monthly_tonnage', value: '500', unit: 'tons' },
      ];
      whatIfScenarios = [
        { name: 'Price +5%', overrides: { scrap_price: '39900', monthly_tonnage: '' } },
        { name: 'Price +10%', overrides: { scrap_price: '41800', monthly_tonnage: '' } },
        { name: 'Price -5%', overrides: { scrap_price: '36100', monthly_tonnage: '' } },
      ];
      renderWhatIfVars();
      renderWhatIfScenarios();
      // Auto-run
      syncWhatIfAndRun();
    }

    // Load templates on whatif tab click
    document.querySelector('[data-panel="whatif"]')?.addEventListener('click', () => {
      loadWhatIfTemplatesFromAPI();
      if (whatIfVars.length === 0) renderWhatIfVars();
      if (whatIfScenarios.length === 0) renderWhatIfScenarios();
    });

    // -----------------------------------------------------------------------
    // What-If Scenario Engine
    // -----------------------------------------------------------------------
    function _parseWhatIfInputs() {
      const formula = document.getElementById('whatif-formula').value.trim();
      let base = {};
      try { base = JSON.parse(document.getElementById('whatif-base').value.trim() || '{}'); } catch { }
      const scenarioLines = document.getElementById('whatif-scenarios').value.trim().split('\n').filter(l => l.trim());
      const scenarios = [];
      for (const line of scenarioLines) {
        const eq = line.indexOf('=');
        if (eq < 1) continue;
        const name = line.slice(0, eq).trim();
        try {
          const params = JSON.parse(line.slice(eq + 1).trim());
          scenarios.push({name, parameters: params});
        } catch { continue; }
      }
      return {formula, base, scenarios};
    }

    async function runWhatIf() {
      const body = document.getElementById('whatif-body');
      const {formula, base, scenarios} = _parseWhatIfInputs();
      if (!formula) { body.innerHTML = '<div class="feed-empty">Enter a formula first.</div>'; return; }
      if (scenarios.length === 0) { body.innerHTML = '<div class="feed-empty">Add at least one scenario (name={"param": value}).</div>'; return; }

      body.innerHTML = '<div class="feed-empty">Evaluating scenarios...</div>';

      try {
        const data = await apiFetch(API + '/scenarios/evaluate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({scenarios, formula, base_values: Object.keys(base).length > 0 ? base : null}),
        });

        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        let html = '';

        // Single scenario result
        if (data.scenario_name) {
          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;">`;
          html += `<div style="font-weight:700;font-size:0.9rem;">${esc(data.scenario_name)}: <span style="color:var(--accent)">${Number(data.result).toLocaleString('en-IN')}</span></div>`;
          html += `<div style="font-size:0.7rem;color:var(--muted);margin-top:0.2rem;">${esc(data.interpretation)}</div>`;
          html += `</div>`;
        }

        // Multi-scenario comparison
        if (data.outcomes) {
          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
          html += `<div style="font-size:0.75rem;margin-bottom:0.3rem;">${esc(data.summary)}</div>`;
          html += `<div style="display:flex;gap:1rem;font-size:0.7rem;">`;
          html += `<span style="color:var(--green)">Best: <b>${esc(data.best_scenario)}</b> (${Number(data.range_max).toLocaleString('en-IN')})</span>`;
          html += `<span style="color:var(--red)">Worst: <b>${esc(data.worst_scenario)}</b> (${Number(data.range_min).toLocaleString('en-IN')})</span>`;
          html += `</div></div>`;

          // Outcomes table
          html += `<table class="result-table" style="width:100%;font-size:0.72rem;">`;
          html += `<thead><tr><th>Scenario</th><th>Result</th><th>Parameters</th></tr></thead><tbody>`;
          const maxResult = Math.max(...data.outcomes.map(o => Math.abs(o.result)));
          for (const o of data.outcomes) {
            const barWidth = maxResult > 0 ? Math.abs(o.result) / maxResult * 100 : 0;
            const color = o.scenario_name === data.best_scenario ? 'var(--green)' : o.scenario_name === data.worst_scenario ? 'var(--red)' : 'var(--accent)';
            html += `<tr>`;
            html += `<td style="font-weight:600;">${esc(o.scenario_name)}</td>`;
            html += `<td><div style="display:flex;align-items:center;gap:4px;"><div style="height:8px;width:${barWidth}%;background:${color};border-radius:3px;min-width:2px;"></div> ${Number(o.result).toLocaleString('en-IN')}</div></td>`;
            html += `<td style="font-size:0.65rem;color:var(--muted);">${esc(JSON.stringify(o.parameters))}</td>`;
            html += `</tr>`;
          }
          html += `</tbody></table>`;

          // Sensitivity
          if (data.sensitivity && Object.keys(data.sensitivity).length > 0) {
            html += `<div style="margin-top:0.5rem;font-size:0.7rem;"><b>Sensitivity (impact of 10% change):</b></div>`;
            html += `<div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.2rem;">`;
            for (const [param, impact] of Object.entries(data.sensitivity)) {
              html += `<span style="background:var(--card);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:0.65rem;">${esc(param)}: <b>${impact}%</b></span>`;
            }
            html += `</div>`;
          }
        }

        body.innerHTML = html || '<div class="feed-empty">No results.</div>';
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function runBreakeven() {
      const body = document.getElementById('whatif-body');
      const {formula, base} = _parseWhatIfInputs();
      if (!formula || Object.keys(base).length === 0) {
        body.innerHTML = '<div class="feed-empty">Enter a formula and base values first. Breakeven finds what value of a variable makes the formula equal a target.</div>';
        return;
      }

      // Use first variable as the breakeven variable
      const variable = Object.keys(base)[0];
      body.innerHTML = `<div class="feed-empty">Finding breakeven for ${variable}...</div>`;

      try {
        const data = await apiFetch(API + '/scenarios/breakeven', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({formula, variable, base_values: base, target: 0, search_range: [-10000, 10000]}),
        });

        let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;">`;
        html += `<div style="font-weight:700;font-size:0.85rem;margin-bottom:0.3rem;">Breakeven Analysis</div>`;
        html += `<div style="font-size:0.75rem;">Variable: <b>${esc(data.variable)}</b></div>`;
        html += `<div style="font-size:0.75rem;">Breakeven value: <b style="color:var(--accent)">${Number(data.breakeven_value).toLocaleString('en-IN')}</b></div>`;
        html += `<div style="font-size:0.75rem;">Target: ${data.target} &rarr; Achieved: ${Number(data.achieved_result).toLocaleString('en-IN')}</div>`;
        html += `<div style="font-size:0.65rem;color:var(--muted);margin-top:0.2rem;">Precision: &plusmn;${data.precision}</div>`;
        html += `</div>`;

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    async function runSensitivity() {
      const body = document.getElementById('whatif-body');
      const {formula, base} = _parseWhatIfInputs();
      if (!formula || Object.keys(base).length === 0) {
        body.innerHTML = '<div class="feed-empty">Enter a formula and base values to run sensitivity analysis.</div>';
        return;
      }

      const variable = Object.keys(base)[0];
      body.innerHTML = `<div class="feed-empty">Computing sensitivity for ${variable}...</div>`;

      try {
        const data = await apiFetch(API + '/scenarios/sensitivity', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({formula, variable, base_values: base}),
        });

        let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
        html += `<div style="font-weight:700;font-size:0.85rem;margin-bottom:0.3rem;">Sensitivity: ${esc(data.variable)}</div>`;
        html += `<div style="font-size:0.7rem;color:var(--muted);">Base value: ${Number(data.base_value).toLocaleString('en-IN')}</div>`;
        html += `</div>`;

        html += `<table class="result-table" style="width:100%;font-size:0.72rem;">`;
        html += `<thead><tr><th>Multiplier</th><th>${esc(data.variable)} Value</th><th>Result</th><th>Change %</th><th>Bar</th></tr></thead><tbody>`;
        const maxChange = Math.max(...(data.rows || []).map(r => Math.abs(r.change_pct || 0)), 1);
        for (const r of data.rows || []) {
          const isBase = r.multiplier === 1.0;
          const color = r.change_pct > 0 ? 'var(--green)' : r.change_pct < 0 ? 'var(--red)' : 'var(--muted)';
          const barW = Math.abs(r.change_pct) / maxChange * 100;
          html += `<tr style="${isBase ? 'font-weight:700;background:var(--surface);' : ''}">`;
          html += `<td>${r.multiplier}x</td>`;
          html += `<td>${Number(r.variable_value).toLocaleString('en-IN')}</td>`;
          html += `<td>${Number(r.result).toLocaleString('en-IN')}</td>`;
          html += `<td style="color:${color}">${r.change_pct > 0 ? '+' : ''}${r.change_pct}%</td>`;
          html += `<td><div style="height:8px;width:${barW}%;background:${color};border-radius:3px;"></div></td>`;
          html += `</tr>`;
        }
        html += `</tbody></table>`;

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    document.querySelector('[data-panel="whatif"]').addEventListener('click', () => {});

    // -----------------------------------------------------------------------
    // Segmentation Engine
    // -----------------------------------------------------------------------
    async function loadSegmentation(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Segmentation: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Loading columns...</div>';
      overlay.style.display = 'block';

      try {
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const numCols = (colData.columns || []).filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (numCols.length < 1) {
          body.innerHTML = '<div class="feed-empty">Need at least 1 numeric column for segmentation.</div>';
          return;
        }

        body.innerHTML = '<div class="feed-empty">Clustering rows...</div>';
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/segment`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({features: numCols.slice(0, 5), n_segments: 3}),
        });
        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
        html += `<div style="font-size:0.75rem;margin-bottom:0.3rem;">${esc(data.summary)}</div>`;
        html += `<div style="font-size:0.7rem;color:var(--muted);">Quality: ${(data.quality_score * 100).toFixed(0)}% | ${data.n_segments} segments | ${data.total_rows} rows</div>`;
        html += `</div>`;

        for (const seg of data.segments || []) {
          const pct = data.total_rows > 0 ? (seg.size / data.total_rows * 100).toFixed(1) : 0;
          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.5rem 0.7rem;margin-bottom:0.4rem;">`;
          html += `<div style="font-weight:700;font-size:0.8rem;">${esc(seg.label)} <span style="color:var(--muted);font-weight:400;">(${seg.size} rows, ${pct}%)</span></div>`;
          html += `<div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.2rem;font-size:0.65rem;">`;
          for (const [feat, val] of Object.entries(seg.center)) {
            html += `<span style="background:var(--card);border:1px solid var(--border);border-radius:4px;padding:2px 6px;">${esc(feat)}: <b>${Number(val).toLocaleString('en-IN', {maximumFractionDigits:1})}</b></span>`;
          }
          html += `</div></div>`;
        }

        if (data.drivers && data.drivers.length > 0) {
          html += `<div style="margin-top:0.5rem;font-size:0.7rem;"><b>Key Drivers:</b></div>`;
          html += `<div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.2rem;">`;
          for (const d of data.drivers) {
            html += `<span style="font-size:0.65rem;background:var(--card);border:1px solid var(--border);border-radius:4px;padding:2px 6px;">${esc(d.feature)}: importance ${(d.importance * 100).toFixed(0)}%</span>`;
          }
          html += `</div>`;
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Trend Decomposition
    // -----------------------------------------------------------------------
    async function loadDecompose(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Trend Decomposition: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Loading columns...</div>';
      overlay.style.display = 'block';

      try {
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const numCols = (colData.columns || []).filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (numCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">No numeric columns found.</div>';
          return;
        }

        let html = '';
        for (const col of numCols.slice(0, 3)) {
          body.innerHTML = `<div class="feed-empty">Decomposing ${col}...</div>` + html;
          const d = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/decompose`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({column: col}),
          });
          if (d.error) continue;

          const dirColor = d.trend_direction === 'increasing' ? 'var(--green)' : d.trend_direction === 'decreasing' ? 'var(--red)' : 'var(--muted)';
          const dirIcon = d.trend_direction === 'increasing' ? 'â†‘' : d.trend_direction === 'decreasing' ? 'â†“' : 'â†’';

          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
          html += `<div style="font-weight:600;font-size:0.8rem;margin-bottom:0.3rem;">${esc(col)}</div>`;
          html += `<div style="display:flex;gap:1rem;font-size:0.7rem;margin-bottom:0.3rem;">`;
          html += `<span>Trend: <b style="color:${dirColor}">${d.trend_direction} ${dirIcon}</b> (strength: ${(d.trend_strength * 100).toFixed(0)}%)</span>`;
          html += `<span>Seasonal: strength ${(d.seasonal_strength * 100).toFixed(0)}%</span>`;
          html += `<span>Period: ${d.period}</span>`;
          html += `</div>`;
          html += `<div style="font-size:0.65rem;color:var(--muted);">${esc(d.summary)}</div>`;
          if (d.anomalous_residuals && d.anomalous_residuals.length > 0) {
            html += `<div style="font-size:0.65rem;color:var(--red);margin-top:0.2rem;">${d.anomalous_residuals.length} anomalous residuals detected</div>`;
          }
          html += `</div>`;
        }
        body.innerHTML = html || '<div class="feed-empty">No decomposition results.</div>';
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Data Dictionary
    // -----------------------------------------------------------------------
    async function loadDataDictionary(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Data Dictionary: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Generating dictionary...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/dictionary`);
        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
        html += `<div style="font-size:0.75rem;margin-bottom:0.3rem;">${esc(data.summary)}</div>`;
        html += `<div style="font-size:0.7rem;color:var(--muted);">${data.row_count} rows, ${data.column_count} columns</div>`;
        html += `</div>`;

        html += `<table class="result-table" style="width:100%;font-size:0.7rem;">`;
        html += `<thead><tr><th>Column</th><th>Type</th><th>Description</th><th>Nulls</th><th>Unique</th><th>Tags</th></tr></thead><tbody>`;
        for (const c of data.columns || []) {
          const tagBadges = (c.tags || []).map(t => `<span style="background:var(--accent);color:white;padding:1px 4px;border-radius:3px;font-size:0.55rem;margin-right:2px;">${esc(t)}</span>`).join('');
          html += `<tr>`;
          html += `<td style="font-weight:600;">${esc(c.name)}</td>`;
          html += `<td>${esc(c.type)}</td>`;
          html += `<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(c.description)}</td>`;
          html += `<td>${c.null_pct}%</td>`;
          html += `<td>${c.unique_pct}%</td>`;
          html += `<td>${tagBadges || '-'}</td>`;
          html += `</tr>`;
        }
        html += `</tbody></table>`;

        if (data.relationships && data.relationships.length > 0) {
          html += `<div style="margin-top:0.5rem;font-size:0.7rem;"><b>Relationship Hints:</b></div>`;
          for (const r of data.relationships) {
            html += `<div style="font-size:0.65rem;color:var(--muted);margin-left:0.5rem;">- ${esc(r)}</div>`;
          }
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Quality Score
    // -----------------------------------------------------------------------
    async function loadQualityScore(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Quality Score: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Computing quality score...</div>';
      overlay.style.display = 'block';

      try {
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/quality-score`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: '{}',
        });
        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        const gradeColor = {'A': 'var(--green)', 'B': '#4caf50', 'C': 'var(--yellow)', 'D': '#ff9800', 'F': 'var(--red)'}[data.grade] || 'var(--muted)';

        let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-bottom:0.5rem;text-align:center;">`;
        html += `<div style="font-size:2rem;font-weight:700;color:${gradeColor};">${data.grade}</div>`;
        html += `<div style="font-size:1.2rem;font-weight:600;">${data.overall_score.toFixed(0)}/100</div>`;
        html += `<div style="font-size:0.7rem;color:var(--muted);margin-top:0.3rem;">${esc(data.summary)}</div>`;
        html += `</div>`;

        // Dimension bars
        html += `<div style="display:grid;gap:0.4rem;">`;
        for (const dim of data.dimensions || []) {
          const barColor = dim.score >= 80 ? 'var(--green)' : dim.score >= 60 ? 'var(--yellow)' : 'var(--red)';
          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:0.4rem 0.6rem;">`;
          html += `<div style="display:flex;justify-content:space-between;font-size:0.72rem;margin-bottom:0.2rem;">`;
          html += `<span style="font-weight:600;text-transform:capitalize;">${esc(dim.dimension)}</span>`;
          html += `<span style="font-weight:700;">${dim.score.toFixed(0)}</span>`;
          html += `</div>`;
          html += `<div style="height:6px;background:var(--border);border-radius:3px;"><div style="height:100%;width:${dim.score}%;background:${barColor};border-radius:3px;"></div></div>`;
          if (dim.issues && dim.issues.length > 0) {
            html += `<div style="font-size:0.6rem;color:var(--muted);margin-top:0.15rem;">${dim.issues.slice(0, 2).map(i => esc(i)).join('; ')}</div>`;
          }
          html += `</div>`;
        }
        html += `</div>`;

        // Critical issues
        if (data.critical_issues && data.critical_issues.length > 0) {
          html += `<div style="margin-top:0.5rem;background:var(--surface);border:1px solid var(--red);border-radius:6px;padding:0.5rem;font-size:0.7rem;">`;
          html += `<div style="font-weight:700;color:var(--red);margin-bottom:0.2rem;">Critical Issues</div>`;
          for (const issue of data.critical_issues) {
            html += `<div>- ${esc(issue)}</div>`;
          }
          html += `</div>`;
        }

        // Recommendations
        if (data.recommendations && data.recommendations.length > 0) {
          html += `<div style="margin-top:0.5rem;font-size:0.7rem;"><b>Recommendations:</b></div>`;
          for (const rec of data.recommendations.slice(0, 5)) {
            html += `<div style="font-size:0.65rem;color:var(--muted);margin-left:0.5rem;">- ${esc(rec)}</div>`;
          }
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // ABC Analysis
    // -----------------------------------------------------------------------
    async function loadABC(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `ABC Analysis: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Loading columns...</div>';
      overlay.style.display = 'block';

      try {
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const cols = colData.columns || [];
        const catCols = cols.filter(c => c.semantic_type && (c.semantic_type.startsWith('categorical') || c.semantic_type === 'identifier')).map(c => c.name);
        const numCols = cols.filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (catCols.length === 0 || numCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">Need at least one categorical and one numeric column.</div>';
          return;
        }

        body.innerHTML = '<div class="feed-empty">Computing ABC classification...</div>';
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/abc`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name_column: catCols[0], value_column: numCols[0]}),
        });
        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        const catColors = {'A': 'var(--red)', 'B': 'var(--yellow)', 'C': 'var(--green)'};

        let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
        html += `<div style="font-size:0.75rem;">${esc(data.summary)}</div>`;
        html += `<div style="display:flex;gap:1rem;margin-top:0.3rem;">`;
        for (const cat of ['A', 'B', 'C']) {
          const count = data[`${cat.toLowerCase()}_count`];
          const pct = data[`${cat.toLowerCase()}_value_pct`];
          html += `<div style="text-align:center;padding:6px 12px;border:2px solid ${catColors[cat]};border-radius:8px;">`;
          html += `<div style="font-size:1.2rem;font-weight:700;color:${catColors[cat]}">${cat}</div>`;
          html += `<div style="font-size:0.65rem;">${count} items</div>`;
          html += `<div style="font-size:0.65rem;">${pct}% value</div>`;
          html += `</div>`;
        }
        html += `</div></div>`;

        html += `<table class="result-table" style="width:100%;font-size:0.72rem;">`;
        html += `<thead><tr><th>#</th><th>Item</th><th>Value</th><th>%</th><th>Cumul %</th><th>Class</th></tr></thead><tbody>`;
        for (const item of (data.items || []).slice(0, 30)) {
          const color = catColors[item.category] || 'var(--text)';
          html += `<tr><td>${item.rank}</td><td>${esc(String(item.name))}</td>`;
          html += `<td>${Number(item.value).toLocaleString('en-IN')}</td>`;
          html += `<td>${item.pct}%</td><td>${item.cumulative_pct}%</td>`;
          html += `<td style="font-weight:700;color:${color}">${item.category}</td></tr>`;
        }
        html += `</tbody></table>`;

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Rolling Statistics
    // -----------------------------------------------------------------------
    async function loadRollingStats(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Rolling Statistics: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Loading columns...</div>';
      overlay.style.display = 'block';

      try {
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const numCols = (colData.columns || []).filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (numCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">No numeric columns found.</div>';
          return;
        }

        let html = '';
        for (const col of numCols.slice(0, 3)) {
          body.innerHTML = `<div class="feed-empty">Computing rolling stats for ${col}...</div>` + html;
          const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/rolling`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({column: col, window: 5}),
          });
          if (data.error) continue;

          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
          html += `<div style="font-weight:600;font-size:0.8rem;">${esc(col)} <span style="font-size:0.65rem;color:var(--muted);">(window=${data.window}, ${data.total_values} values)</span></div>`;
          html += `<div style="font-size:0.65rem;color:var(--muted);">${esc(data.summary)}</div>`;

          if (data.regime_changes && data.regime_changes.length > 0) {
            html += `<div style="font-size:0.65rem;color:var(--red);margin-top:0.2rem;">`;
            html += `${data.regime_changes.length} regime change(s) detected`;
            for (const rc of data.regime_changes.slice(0, 3)) {
              html += `<div style="margin-left:0.5rem;">- Index ${rc.index}: ${rc.direction} (z=${rc.z_score})</div>`;
            }
            html += `</div>`;
          }
          html += `</div>`;
        }
        body.innerHTML = html || '<div class="feed-empty">No rolling statistics.</div>';
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Pivot Table
    // -----------------------------------------------------------------------
    async function loadPivot(tableName) {
      const overlay = document.getElementById('time-analysis-overlay');
      const title = document.getElementById('time-analysis-title');
      const body = document.getElementById('time-analysis-body');
      title.textContent = `Pivot Table: ${tableName}`;
      body.innerHTML = '<div class="feed-empty">Loading columns...</div>';
      overlay.style.display = 'block';

      try {
        const colData = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/columns`);
        const cols = colData.columns || [];
        const catCols = cols.filter(c => c.semantic_type && (c.semantic_type.startsWith('categorical') || c.semantic_type === 'identifier')).map(c => c.name);
        const numCols = cols.filter(c => c.semantic_type && c.semantic_type.startsWith('numeric')).map(c => c.name);

        if (catCols.length < 2 || numCols.length === 0) {
          body.innerHTML = '<div class="feed-empty">Need at least 2 categorical columns and 1 numeric column for pivot.</div>';
          return;
        }

        body.innerHTML = '<div class="feed-empty">Building pivot table...</div>';
        const data = await apiFetch(API + `/tables/${encodeURIComponent(tableName)}/pivot`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({row_field: catCols[0], col_field: catCols[1], value_field: numCols[0], agg_func: 'sum'}),
        });
        if (data.error) { body.innerHTML = `<div class="feed-empty">${esc(data.error)}</div>`; return; }

        let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
        html += `<div style="font-size:0.75rem;">${esc(data.summary)}</div>`;
        html += `<div style="font-size:0.7rem;color:var(--muted);">Grand total: ${Number(data.grand_total).toLocaleString('en-IN')}</div>`;
        html += `</div>`;

        // Pivot table
        const rKeys = (data.row_keys || []).slice(0, 15);
        const cKeys = (data.col_keys || []).slice(0, 10);
        html += `<div style="overflow-x:auto;"><table class="result-table" style="font-size:0.68rem;">`;
        html += `<thead><tr><th></th>`;
        for (const ck of cKeys) { html += `<th>${esc(String(ck))}</th>`; }
        html += `<th style="font-weight:700;">Total</th></tr></thead><tbody>`;
        for (const rk of rKeys) {
          html += `<tr><td style="font-weight:600;">${esc(String(rk))}</td>`;
          for (const ck of cKeys) {
            const val = data.cells?.[rk]?.[ck] ?? 0;
            html += `<td>${Number(val).toLocaleString('en-IN')}</td>`;
          }
          const rowTotal = data.row_totals?.[rk] ?? 0;
          html += `<td style="font-weight:700;">${Number(rowTotal).toLocaleString('en-IN')}</td>`;
          html += `</tr>`;
        }
        // Column totals
        html += `<tr style="font-weight:700;border-top:2px solid var(--border);"><td>Total</td>`;
        for (const ck of cKeys) {
          const colTotal = data.col_totals?.[ck] ?? 0;
          html += `<td>${Number(colTotal).toLocaleString('en-IN')}</td>`;
        }
        html += `<td>${Number(data.grand_total).toLocaleString('en-IN')}</td></tr>`;
        html += `</tbody></table></div>`;

        if (data.outliers && data.outliers.length > 0) {
          html += `<div style="margin-top:0.5rem;font-size:0.65rem;color:var(--red);">${data.outliers.length} outlier cell(s) detected</div>`;
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Audit Log Tab
    // -----------------------------------------------------------------------
    async function loadAuditLog() {
      const body = document.getElementById('changelog-body');
      body.innerHTML = '<div class="feed-empty">Loading audit log...</div>';

      try {
        const changes = await apiFetch(API + '/changes');

        if (!changes.length || changes.error) {
          body.innerHTML = '<div class="feed-empty">No data changes recorded yet.</div>';
          return;
        }

        let html = '<table class="result-table" style="width:100%;font-size:0.75rem;">';
        html += '<thead><tr><th>Time</th><th>Table</th><th>Type</th><th>Column</th><th>Old</th><th>New</th></tr></thead>';
        html += '<tbody>';

        for (const c of changes) {
          const time = c.detected_at ? new Date(c.detected_at).toLocaleString() : '-';
          const typeClass = c.change_type === 'row_added' ? 'color:var(--green)' : c.change_type === 'row_modified' ? 'color:var(--yellow)' : '';
          html += `<tr>`;
          html += `<td>${esc(time)}</td>`;
          html += `<td>${esc(c.table_name || '')}</td>`;
          html += `<td style="${typeClass}">${esc(c.change_type || '')}</td>`;
          html += `<td>${esc(c.column_name || '-')}</td>`;
          html += `<td>${esc(c.old_value || '-')}</td>`;
          html += `<td>${esc(c.new_value || '-')}</td>`;
          html += `</tr>`;
        }

        html += '</tbody></table>';
        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error loading audit log: ${esc(err.message)}</div>`;
      }
    }

    document.querySelector('[data-panel="changelog"]').addEventListener('click', loadAuditLog);

    // -----------------------------------------------------------------------
    // Relationships Tab
    // -----------------------------------------------------------------------
    async function loadRelationships() {
      const body = document.getElementById('relationships-body');
      body.innerHTML = '<div class="feed-empty">Loading relationships...</div>';

      try {
        const rels = await apiFetch(API + '/relationships');

        if (!rels.length) {
          body.innerHTML = '<div class="feed-empty">No cross-table relationships discovered yet. Run a discovery scan first.</div>';
          return;
        }

        let html = '<div style="display:flex;flex-direction:column;gap:0.75rem;">';
        for (const r of rels) {
          const conf = Math.round((r.confidence || 0) * 100);
          const confColor = conf >= 80 ? 'var(--green)' : conf >= 50 ? 'var(--yellow)' : 'var(--red)';
          const typeLabel = (r.relationship_type || 'unknown').replace(/_/g, ' ');
          const time = r.discovered_at ? new Date(r.discovered_at).toLocaleString() : '';

          html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;">`;
          html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">`;
          html += `<span style="font-weight:600;font-size:0.85rem;">${esc(r.table_a)}.${esc(r.column_a)} &harr; ${esc(r.table_b)}.${esc(r.column_b)}</span>`;
          html += `<span style="font-size:0.7rem;padding:2px 8px;border-radius:4px;background:${confColor}20;color:${confColor};">${conf}% confidence</span>`;
          html += `</div>`;

          // Confidence bar
          html += `<div style="background:var(--border);border-radius:4px;height:6px;margin-bottom:0.5rem;">`;
          html += `<div style="background:${confColor};width:${conf}%;height:100%;border-radius:4px;transition:width 0.3s;"></div>`;
          html += `</div>`;

          html += `<div style="display:flex;gap:1rem;font-size:0.72rem;color:var(--muted);">`;
          html += `<span>Type: ${esc(typeLabel)}</span>`;
          if (r.overlap_count) html += `<span>Overlap: ${r.overlap_count.toLocaleString()}</span>`;
          if (time) html += `<span>Found: ${esc(time)}</span>`;
          html += `</div>`;
          html += `</div>`;
        }
        html += '</div>';
        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error loading relationships: ${esc(err.message)}</div>`;
      }
    }

    document.querySelector('[data-panel="relationships"]').addEventListener('click', loadRelationships);

    async function loadLineage() {
      const body = document.getElementById('lineage-body');
      body.innerHTML = '<div class="feed-empty">Loading lineage data...</div>';

      try {
        const data = await apiFetch(API + '/lineage');

        let html = `<div style="font-size:0.75rem;color:var(--muted);margin-bottom:0.6rem;">`;
        html += `${data.table_count || 0} tables | ${data.insight_count || 0} insights | ${data.report_count || 0} reports | ${data.edge_count || 0} edges`;
        html += `</div>`;

        // Impact ranking
        if (data.impact_ranking && data.impact_ranking.length > 0) {
          html += `<div style="font-weight:600;font-size:0.82rem;margin-bottom:0.4rem;">Impact Ranking</div>`;
          html += `<table style="width:100%;font-size:0.7rem;border-collapse:collapse;margin-bottom:0.8rem;">`;
          html += `<thead><tr style="border-bottom:1px solid var(--border);"><th style="padding:4px;text-align:left;">Table</th><th style="padding:4px;">Insights</th><th style="padding:4px;">Reports</th><th style="padding:4px;">Relations</th><th style="padding:4px;">Impact</th></tr></thead><tbody>`;

          for (const r of data.impact_ranking) {
            const barWidth = r.impact > 0 ? Math.min(r.impact * 15, 100) : 0;
            html += `<tr style="border-bottom:1px solid var(--border);">`;
            html += `<td style="padding:4px;font-weight:500;">${esc(r.table)}</td>`;
            html += `<td style="padding:4px;text-align:center;">${r.insight_count}</td>`;
            html += `<td style="padding:4px;text-align:center;">${r.report_count}</td>`;
            html += `<td style="padding:4px;text-align:center;">${r.relationship_count}</td>`;
            html += `<td style="padding:4px;">`;
            html += `<div style="display:flex;align-items:center;gap:4px;">`;
            html += `<div style="background:var(--accent);height:8px;width:${barWidth}%;border-radius:3px;"></div>`;
            html += `<span>${r.impact}</span></div></td>`;
            html += `</tr>`;
          }
          html += `</tbody></table>`;
        }

        // Orphaned tables
        if (data.orphaned_tables && data.orphaned_tables.length > 0) {
          html += `<div style="font-weight:600;font-size:0.82rem;margin-bottom:0.4rem;color:var(--yellow);">Orphaned Tables (no dependencies)</div>`;
          html += `<div style="display:flex;flex-wrap:wrap;gap:0.4rem;">`;
          for (const t of data.orphaned_tables) {
            html += `<span style="font-size:0.7rem;padding:3px 8px;border-radius:4px;background:var(--border);color:var(--yellow);">${esc(t)}</span>`;
          }
          html += `</div>`;
        }

        if (!data.impact_ranking || data.impact_ranking.length === 0) {
          html += '<div class="feed-empty">No lineage data available. Run a discovery scan first.</div>';
        }

        body.innerHTML = html;
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error loading lineage: ${esc(err.message)}</div>`;
      }
    }

    // -----------------------------------------------------------------------
    // Goals Tab
    // -----------------------------------------------------------------------
    let savedGoals = JSON.parse(localStorage.getItem('bb_goals') || '[]');

    function showAddGoalForm() {
      document.getElementById('goal-form').style.display = 'block';
    }

    function addGoal() {
      const metric = document.getElementById('goal-metric').value.trim();
      const target = parseFloat(document.getElementById('goal-target').value);
      const direction = document.getElementById('goal-direction').value;
      const baseline = document.getElementById('goal-baseline').value ? parseFloat(document.getElementById('goal-baseline').value) : null;

      if (!metric || isNaN(target)) return;

      savedGoals.push({ metric_name: metric, target_value: target, direction, baseline });
      localStorage.setItem('bb_goals', JSON.stringify(savedGoals));

      document.getElementById('goal-form').style.display = 'none';
      document.getElementById('goal-metric').value = '';
      document.getElementById('goal-target').value = '';
      document.getElementById('goal-baseline').value = '';

      loadGoals();
    }

    function removeGoal(idx) {
      savedGoals.splice(idx, 1);
      localStorage.setItem('bb_goals', JSON.stringify(savedGoals));
      loadGoals();
    }

    async function loadGoals() {
      const body = document.getElementById('goals-body');
      const healthEl = document.getElementById('goals-health');

      if (savedGoals.length === 0) {
        body.innerHTML = '<div class="feed-empty">No goals set yet. Click "+ Add Goal" to define metric targets.</div>';
        healthEl.innerHTML = '';
        return;
      }

      // Try to get current values from the data quality endpoint
      let currentValues = {};
      try {
        const qData = await apiFetch(API + '/data-quality');
        if (qData.tables) {
          for (const t of qData.tables) {
            if (t.stats) {
              for (const [col, st] of Object.entries(t.stats)) {
                if (st && st.mean !== undefined) {
                  currentValues[col] = st.mean;
                  currentValues[`${t.table_name}.${col}`] = st.mean;
                }
              }
            }
          }
        }
      } catch (e) { /* optional */ }

      try {
        const data = await apiFetch(API + '/goals/evaluate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ goals: savedGoals, current_values: currentValues }),
        });

        // Health bar
        if (data.health) {
          const h = data.health;
          const hColor = h.health_score >= 70 ? 'var(--green)' : h.health_score >= 40 ? 'var(--yellow)' : 'var(--red)';
          healthEl.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.8rem;">
              <span style="font-size:0.8rem;font-weight:600;">Health Score: <span style="color:${hColor};">${h.health_score}</span>/100</span>
              <span style="font-size:0.7rem;color:var(--muted);">${h.total} goals | ${h.achieved_pct}% achieved</span>
            </div>
          `;
        }

        // Goal cards
        let html = '';
        (data.goals || []).forEach((g, i) => {
          const statusColor = g.status === 'achieved' || g.status === 'exceeded' ? 'var(--green)'
            : g.status === 'on_track' ? 'var(--accent)' : g.status === 'at_risk' ? 'var(--yellow)' : 'var(--red)';
          const statusIcon = g.status === 'achieved' ? 'OK' : g.status === 'exceeded' ? '++' :
            g.status === 'on_track' ? '->' : g.status === 'at_risk' ? '!' : 'X';

          html += `<div style="background:var(--surface);border:1px solid var(--border);border-left:4px solid ${statusColor};border-radius:8px;padding:0.6rem 0.8rem;margin-bottom:0.5rem;">`;
          html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">`;
          html += `<span style="font-weight:600;font-size:0.82rem;">${esc(g.metric_name)}</span>`;
          html += `<div style="display:flex;gap:0.3rem;align-items:center;">`;
          html += `<span style="font-size:0.65rem;padding:2px 6px;border-radius:4px;background:${statusColor}20;color:${statusColor};">[${statusIcon}] ${g.status}</span>`;
          html += `<button onclick="removeGoal(${i})" style="font-size:0.6rem;padding:1px 5px;border-radius:3px;border:1px solid var(--border);background:none;color:var(--muted);cursor:pointer;">x</button>`;
          html += `</div></div>`;

          // Progress bar
          const pct = Math.min(Math.max(g.progress_pct, 0), 120);
          html += `<div style="height:6px;background:var(--border);border-radius:3px;margin-bottom:0.3rem;">`;
          html += `<div style="height:100%;width:${Math.min(pct, 100)}%;background:${statusColor};border-radius:3px;transition:width 0.3s;"></div>`;
          html += `</div>`;

          html += `<div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);">`;
          html += `<span>Current: ${g.current_value.toLocaleString()} | Target: ${g.target_value.toLocaleString()} (${g.direction})</span>`;
          html += `<span>${g.progress_pct.toFixed(0)}%</span>`;
          html += `</div>`;
          html += `<div style="font-size:0.65rem;color:var(--muted);margin-top:2px;">${esc(g.summary)}</div>`;
          html += `</div>`;
        });
        body.innerHTML = html || '<div class="feed-empty">No goal results.</div>';
      } catch (err) {
        body.innerHTML = `<div class="feed-empty">Error evaluating goals: ${esc(err.message)}</div>`;
      }
    }

    document.querySelector('[data-panel="goals"]').addEventListener('click', loadGoals);

    // -----------------------------------------------------------------------
    // Manufacturing Analytics Functions
    // -----------------------------------------------------------------------

    async function loadCostBreakdown(tableName) {
      const cols = await _getColumns(tableName);
      const cat = cols.find(c => /categ|dept|type|group|name/i.test(c)) || cols[0];
      const amt = cols.find(c => /cost|amount|spend|value|total/i.test(c)) || cols[1];
      if (!cat || !amt) return toast('Need category + amount columns');
      try {
        const data = await apiFetch(API + '/tables/' + tableName + '/cost-breakdown', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({category_column: cat, amount_column: amt})
        });
        if (data.error) return toast(data.error);
        let html = `<h3>Cost Breakdown â€” ${esc(tableName)}</h3>`;
        html += `<p>${esc(data.summary)}</p>`;
        html += `<table><thead><tr><th>Rank</th><th>Category</th><th>Amount</th><th>Share %</th><th>Cumulative %</th></tr></thead><tbody>`;
        for (const c of data.categories) {
          html += `<tr><td>${c.rank}</td><td>${esc(c.name)}</td><td>${Number(c.amount).toLocaleString('en-IN')}</td><td>${c.share_pct.toFixed(1)}%</td><td>${c.cumulative_pct.toFixed(1)}%</td></tr>`;
        }
        html += `</tbody></table>`;
        _showOverlay(html);
      } catch (e) { toast('Cost breakdown failed'); }
    }

    async function loadDowntime(tableName) {
      const cols = await _getColumns(tableName);
      const machine = cols.find(c => /machine|equip|asset|unit/i.test(c)) || cols[0];
      const duration = cols.find(c => /duration|hours|time|downtime|minutes/i.test(c)) || cols[1];
      const reason = cols.find(c => /reason|cause|fault|failure/i.test(c));
      if (!machine || !duration) return toast('Need machine + duration columns');
      try {
        const data = await apiFetch(API + '/tables/' + tableName + '/downtime', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({machine_column: machine, duration_column: duration, reason_column: reason})
        });
        if (data.error) return toast(data.error);
        let html = `<h3>Downtime Analysis â€” ${esc(tableName)}</h3>`;
        html += `<p>${esc(data.summary)}</p>`;
        html += `<pre style="white-space:pre-wrap;">${esc(data.report)}</pre>`;
        _showOverlay(html);
      } catch (e) { toast('Downtime analysis failed'); }
    }

    async function loadCapacity(tableName) {
      const cols = await _getColumns(tableName);
      const entity = cols.find(c => /machine|entity|unit|line/i.test(c)) || cols[0];
      const actual = cols.find(c => /actual|output|production|qty/i.test(c)) || cols[1];
      const capacity = cols.find(c => /capacity|max|target|limit/i.test(c)) || cols[2];
      if (!entity || !actual || !capacity) return toast('Need entity + actual + capacity columns');
      try {
        const data = await apiFetch(API + '/tables/' + tableName + '/capacity', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({entity_column: entity, actual_column: actual, capacity_column: capacity})
        });
        if (data.error) return toast(data.error);
        let html = `<h3>Capacity Utilization â€” ${esc(tableName)}</h3>`;
        html += `<p>${esc(data.summary)}</p>`;
        html += `<table><thead><tr><th>Entity</th><th>Actual</th><th>Capacity</th><th>Utilization</th><th>Status</th></tr></thead><tbody>`;
        for (const e of data.entities) {
          const color = e.utilization_pct > 95 ? 'color:var(--danger)' : e.utilization_pct < 50 ? 'color:var(--warning)' : '';
          html += `<tr><td>${esc(e.entity)}</td><td>${Number(e.actual).toLocaleString('en-IN')}</td><td>${Number(e.capacity).toLocaleString('en-IN')}</td><td style="${color}">${e.utilization_pct.toFixed(1)}%</td><td>${esc(e.status)}</td></tr>`;
        }
        html += `</tbody></table>`;
        _showOverlay(html);
      } catch (e) { toast('Capacity analysis failed'); }
    }

    async function loadOEE(tableName) {
      const cols = await _getColumns(tableName);
      const entity = cols.find(c => /machine|entity|unit|line/i.test(c)) || cols[0];
      const avail = cols.find(c => /avail/i.test(c));
      const perf = cols.find(c => /perf/i.test(c));
      const qual = cols.find(c => /qual/i.test(c));
      if (!entity || !avail || !perf || !qual) return toast('Need entity + availability + performance + quality columns');
      try {
        const data = await apiFetch(API + '/tables/' + tableName + '/oee', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({entity_column: entity, availability_column: avail, performance_column: perf, quality_column: qual})
        });
        if (data.error) return toast(data.error);
        let html = `<h3>OEE Analysis â€” ${esc(tableName)}</h3>`;
        html += `<p>${esc(data.summary)}</p>`;
        html += `<table><thead><tr><th>Entity</th><th>Availability</th><th>Performance</th><th>Quality</th><th>OEE</th><th>Grade</th><th>Limiting Factor</th></tr></thead><tbody>`;
        for (const e of data.entities) {
          html += `<tr><td>${esc(e.entity)}</td><td>${(e.availability*100).toFixed(1)}%</td><td>${(e.performance*100).toFixed(1)}%</td><td>${(e.quality*100).toFixed(1)}%</td><td><strong>${(e.oee*100).toFixed(1)}%</strong></td><td>${esc(e.oee_grade)}</td><td>${esc(e.limiting_factor)}</td></tr>`;
        }
        html += `</tbody></table>`;
        _showOverlay(html);
      } catch (e) { toast('OEE analysis failed'); }
    }

    async function loadShiftPerf(tableName) {
      const cols = await _getColumns(tableName);
      const shift = cols.find(c => /shift/i.test(c));
      const output = cols.find(c => /output|production|qty|tons/i.test(c)) || cols[1];
      const target = cols.find(c => /target|plan/i.test(c));
      if (!shift || !output) return toast('Need shift + output columns');
      try {
        const data = await apiFetch(API + '/tables/' + tableName + '/shift-performance', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({shift_column: shift, output_column: output, target_column: target})
        });
        if (data.error) return toast(data.error);
        let html = `<h3>Shift Performance â€” ${esc(tableName)}</h3>`;
        html += `<p>${esc(data.summary)}</p>`;
        html += `<table><thead><tr><th>Shift</th><th>Total Output</th><th>Avg Output</th><th>Events</th><th>Achievement</th><th>Consistency</th></tr></thead><tbody>`;
        for (const s of data.shifts) {
          html += `<tr><td>${esc(s.shift)}</td><td>${Number(s.total_output).toLocaleString('en-IN')}</td><td>${Number(s.avg_output).toLocaleString('en-IN')}</td><td>${s.event_count}</td><td>${s.achievement_pct != null ? s.achievement_pct.toFixed(1) + '%' : 'â€”'}</td><td>${esc(s.consistency_grade)}</td></tr>`;
        }
        html += `</tbody></table>`;
        _showOverlay(html);
      } catch (e) { toast('Shift analysis failed'); }
    }

    async function loadInventoryHealth(tableName) {
      const cols = await _getColumns(tableName);
      const item = cols.find(c => /item|product|sku|material|name/i.test(c)) || cols[0];
      const qty = cols.find(c => /qty|quantity|stock|balance|on.hand/i.test(c)) || cols[1];
      const min_c = cols.find(c => /min/i.test(c));
      const max_c = cols.find(c => /max/i.test(c));
      const rop = cols.find(c => /reorder|rop/i.test(c));
      if (!item || !qty) return toast('Need item + quantity columns');
      try {
        const data = await apiFetch(API + '/tables/' + tableName + '/inventory-health', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({item_column: item, quantity_column: qty, min_column: min_c, max_column: max_c, reorder_column: rop})
        });
        if (data.error) return toast(data.error);
        let html = `<h3>Inventory Health â€” ${esc(tableName)}</h3>`;
        html += `<p>${esc(data.summary)}</p>`;
        html += `<div style="display:flex;gap:12px;margin:12px 0;">`;
        html += `<div class="metric-card"><div class="metric-value" style="color:green">${data.healthy_count}</div><div class="metric-label">Healthy</div></div>`;
        html += `<div class="metric-card"><div class="metric-value" style="color:orange">${data.at_reorder_count}</div><div class="metric-label">At Reorder</div></div>`;
        html += `<div class="metric-card"><div class="metric-value" style="color:red">${data.understocked_count}</div><div class="metric-label">Understocked</div></div>`;
        html += `<div class="metric-card"><div class="metric-value" style="color:blue">${data.overstocked_count}</div><div class="metric-label">Overstocked</div></div>`;
        html += `</div>`;
        html += `<table><thead><tr><th>Item</th><th>Qty</th><th>Min</th><th>Max</th><th>Reorder</th><th>Status</th></tr></thead><tbody>`;
        for (const i of data.items) {
          const color = i.status === 'understocked' ? 'color:red' : i.status === 'overstocked' ? 'color:blue' : i.status === 'reorder' ? 'color:orange' : '';
          html += `<tr><td>${esc(i.item)}</td><td>${Number(i.current_qty).toLocaleString('en-IN')}</td><td>${i.min_qty != null ? Number(i.min_qty).toLocaleString('en-IN') : 'â€”'}</td><td>${i.max_qty != null ? Number(i.max_qty).toLocaleString('en-IN') : 'â€”'}</td><td>${i.reorder_point != null ? Number(i.reorder_point).toLocaleString('en-IN') : 'â€”'}</td><td style="${color};font-weight:600">${esc(i.status)}</td></tr>`;
        }
        html += `</tbody></table>`;
        _showOverlay(html);
      } catch (e) { toast('Inventory health failed'); }
    }

    async function _getColumns(tableName) {
      try {
        const data = await apiFetch(API + '/tables/' + tableName + '/columns');
        return data.columns || [];
      } catch { return []; }
    }

    // -----------------------------------------------------------------------
    // v3: Alerts Tab
    // -----------------------------------------------------------------------
    let pendingAlertRule = null;

    async function loadAlerts() {
      try {
        const rules = await apiFetch(API + '/alerts');
        const body = document.getElementById('alerts-body');

        if (!rules.length || rules.error) {
          body.innerHTML = '<div class="feed-empty">No alert rules deployed yet. Use natural language above to create one.</div>';
          return;
        }

        let html = '';
        for (const r of rules) {
          const statusClass = r.active ? 'active' : 'paused';
          html += `<div class="alert-card ${statusClass}">`;
          html += `<div class="alert-card-header">`;
          html += `<span class="alert-card-name">${esc(r.name)}</span>`;
          html += `<span class="badge ${r.active ? 'badge-green' : 'badge-yellow'}">${r.active ? 'Active' : 'Paused'}</span>`;
          html += `</div>`;
          if (r.description) html += `<div class="alert-card-desc">${esc(r.description)}</div>`;
          html += `<div class="alert-card-stats">`;
          html += `<span>Type: ${r.rule_type}</span>`;
          html += `<span>Channel: ${r.notification_channel}</span>`;
          html += `<span>Triggered: ${r.trigger_count || 0}x</span>`;
          if (r.last_triggered_at) html += `<span>Last: ${_timeAgo(r.last_triggered_at)}</span>`;
          html += `</div>`;
          html += `<div class="alert-card-actions">`;
          if (r.active) {
            html += `<button class="btn-sm btn-secondary" onclick="pauseAlert('${r.id}')">Pause</button>`;
          } else {
            html += `<button class="btn-sm" onclick="resumeAlert('${r.id}')">Resume</button>`;
          }
          html += `<button class="btn-sm" onclick="previewAlert('${r.id}')">Preview</button>`;
          html += `<button class="btn-sm btn-secondary" onclick="deleteAlert('${r.id}')">Delete</button>`;
          html += `</div></div>`;
        }
        body.innerHTML = html;
      } catch (e) { console.error('loadAlerts:', e); }
    }

    async function deployAlert() {
      const text = document.getElementById('alert-text').value.trim();
      if (!text) return toast('Enter an alert description');

      // Step 1: Parse the alert (don't deploy yet)
      try {
        const data = await apiFetch(API + '/alerts/parse', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text }),
        });
        if (data.error) return toast('Error: ' + data.error);

        // Store parsed rule for confirmation step
        pendingAlertRule = { text, parsed_rule: data.parsed_rule };

        // Show confirmation message
        const confirmEl = document.getElementById('alert-confirmation');
        document.getElementById('alert-confirm-text').textContent = data.confirmation || 'Deploy this alert rule?';
        confirmEl.style.display = 'block';
      } catch (e) { toast('Failed to parse alert'); }
    }

    async function confirmAlertDeploy() {
      if (!pendingAlertRule) return;

      try {
        const data = await apiFetch(API + '/alerts/deploy', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(pendingAlertRule),
        });
        if (data.error) return toast('Error: ' + data.error);

        toast('Alert deployed: ' + (data.parsed_rule?.name || ''));
        document.getElementById('alert-text').value = '';
        pendingAlertRule = null;
        document.getElementById('alert-confirmation').style.display = 'none';
        loadAlerts();
      } catch (e) { toast('Failed to deploy alert'); }
    }

    function cancelAlertDeploy() {
      pendingAlertRule = null;
      document.getElementById('alert-confirmation').style.display = 'none';
    }

    async function pauseAlert(id) {
      await fetch(API + '/alerts/' + id + '/pause', { method: 'POST' });
      toast('Alert paused');
      loadAlerts();
    }

    async function resumeAlert(id) {
      await fetch(API + '/alerts/' + id + '/resume', { method: 'POST' });
      toast('Alert resumed');
      loadAlerts();
    }

    async function deleteAlert(id) {
      await fetch(API + '/alerts/' + id, { method: 'DELETE' });
      toast('Alert deleted');
      loadAlerts();
    }

    async function previewAlert(id) {
      try {
        const preview = await apiFetch(API + '/alerts/' + id + '/preview');
        if (preview.error) { toast(preview.error); return; }

        const trigger = preview.would_trigger ? 'YES - would trigger' : 'No - would not trigger';
        const triggerColor = preview.would_trigger ? 'var(--red)' : 'var(--green)';
        let msg = `Alert: ${esc(preview.alert_name)}\n`;
        msg += `Would Trigger: ${trigger}\n`;
        msg += `Source: ${preview.source}\n`;
        msg += `Matching rows: ${preview.matching_rows}\n`;
        msg += `Current stats: avg=${preview.current_stats?.avg}, min=${preview.current_stats?.min}, max=${preview.current_stats?.max}\n`;
        msg += `Threshold: ${preview.condition} ${preview.threshold}`;

        // Show as a modal-like toast
        const toastEl = document.createElement('div');
        toastEl.className = 'feed-card';
        toastEl.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;max-width:500px;padding:1.5rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.5);';
        toastEl.innerHTML = `
          <div style="font-weight:600;margin-bottom:0.8rem;">Alert Preview: ${esc(preview.alert_name)}</div>
          <div style="font-size:1.2rem;font-weight:700;color:${triggerColor};margin-bottom:0.8rem;">${trigger}</div>
          <div style="font-size:0.75rem;color:var(--muted);">
            <div>Source: ${esc(preview.source)}</div>
            <div>Condition: ${esc(preview.condition)} ${preview.threshold}</div>
            <div>Matching rows: ${preview.matching_rows} of ${preview.current_stats?.row_count}</div>
            <div style="margin-top:0.4rem;">Stats - Avg: ${preview.current_stats?.avg != null ? Number(preview.current_stats.avg).toFixed(2) : '-'}, Min: ${preview.current_stats?.min ?? '-'}, Max: ${preview.current_stats?.max ?? '-'}</div>
          </div>
          <button class="btn-sm" style="margin-top:0.8rem;" onclick="this.parentElement.remove()">Close</button>
        `;
        document.body.appendChild(toastEl);
      } catch (err) {
        toast('Preview failed: ' + err.message);
      }
    }

    // -----------------------------------------------------------------------
    // v3: Sources Tab
    // -----------------------------------------------------------------------
    async function loadSources() {
      try {
        const sources = await apiFetch(API + '/sources');
        const body = document.getElementById('sources-body');

        if (!sources.length || sources.error) {
          body.innerHTML = '<div class="feed-empty">No data sources connected yet. Add a Google Sheet or API endpoint to get started.</div>';
          return;
        }

        let html = '';
        for (const s of sources) {
          const typeMap = { google_sheet: 'sheet', api: 'api', recurring_upload: 'upload', manual_upload: 'upload' };
          const typeLabel = typeMap[s.source_type] || 'upload';
          const statusClass = s.last_sync_status || 'unknown';

          html += `<div class="source-card">`;
          html += `<div class="source-card-info">`;
          html += `<div class="source-card-name">${esc(s.name)} <span class="source-type-badge ${typeLabel}">${typeLabel}</span>`;
          html += ` <span class="sync-status ${statusClass}">${s.active ? (statusClass === 'error' ? 'â— Error' : 'â— Synced') : 'â— Paused'}</span></div>`;
          html += `<div class="source-card-meta">`;
          html += `Table: ${esc(s.table_name)} Â· ${s.rows_total || 0} rows`;
          if (s.sync_frequency_minutes > 0) html += ` Â· Every ${s.sync_frequency_minutes}min`;
          if (s.last_sync_at) html += ` Â· Last: ${_timeAgo(s.last_sync_at)}`;
          html += `</div></div>`;
          html += `<div class="source-card-actions">`;
          html += `<button class="btn-sm" onclick="syncSource('${s.id}')">Sync</button>`;
          if (s.active) {
            html += `<button class="btn-sm btn-secondary" onclick="pauseSource('${s.id}')">Pause</button>`;
          } else {
            html += `<button class="btn-sm" onclick="resumeSource('${s.id}')">Resume</button>`;
          }
          html += `<button class="btn-sm btn-secondary" onclick="deleteSource('${s.id}')">Remove</button>`;
          html += `</div></div>`;
        }
        body.innerHTML = html;
      } catch (e) { console.error('loadSources:', e); }
    }

    function showAddSourceModal(type) {
      const modal = document.getElementById('source-modal');
      modal.classList.add('active');
      if (type === 'sheet') {
        document.getElementById('source-modal-title').textContent = 'Add Google Sheet';
        document.getElementById('source-sheet-form').style.display = '';
        document.getElementById('source-api-form').style.display = 'none';
      } else {
        document.getElementById('source-modal-title').textContent = 'Add API Source';
        document.getElementById('source-sheet-form').style.display = 'none';
        document.getElementById('source-api-form').style.display = '';
      }
    }

    function closeSourceModal() {
      document.getElementById('source-modal').classList.remove('active');
    }

    document.getElementById('source-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('source-modal')) closeSourceModal();
    });

    async function submitGoogleSheet() {
      const url = document.getElementById('src-sheet-url').value.trim();
      if (!url) return toast('Enter a Google Sheets URL');

      try {
        const data = await apiFetch(API + '/sources/google-sheet', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            sheet_url: url,
            name: document.getElementById('src-sheet-name').value.trim() || null,
            tab_name: document.getElementById('src-sheet-tab').value.trim() || null,
            table_name: document.getElementById('src-table-name').value.trim() || null,
            sync_frequency_minutes: parseInt(document.getElementById('src-freq').value) || 5,
          }),
        });
        if (data.error) return toast('Error: ' + data.error);
        toast('Sheet connected: ' + (data.table_name || ''));
        closeSourceModal();
        loadSources();
      } catch (e) { toast('Failed to connect sheet: ' + e.message); }
    }

    async function submitApiSource() {
      const url = document.getElementById('src-api-url').value.trim();
      const name = document.getElementById('src-api-name').value.trim();
      const table = document.getElementById('src-api-table').value.trim();
      if (!url || !name || !table) return toast('Fill in all fields');

      try {
        const data = await apiFetch(API + '/sources/api', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name, api_url: url, table_name: table,
            sync_frequency_minutes: parseInt(document.getElementById('src-api-freq').value) || 0,
          }),
        });
        if (data.error) return toast('Error: ' + data.error);
        toast('API source connected');
        closeSourceModal();
        loadSources();
      } catch (e) { toast('Failed to connect API'); }
    }

    async function syncSource(id) {
      toast('Syncing...');
      const data = await apiFetch(API + '/sources/' + id + '/sync', { method: 'POST' });
      toast(data.error ? 'Sync error: ' + data.error : 'Synced successfully');
      loadSources();
    }

    async function pauseSource(id) {
      await fetch(API + '/sources/' + id + '/pause', { method: 'POST' });
      toast('Source paused');
      loadSources();
    }

    async function resumeSource(id) {
      await fetch(API + '/sources/' + id + '/resume', { method: 'POST' });
      toast('Source resumed');
      loadSources();
    }

    async function deleteSource(id) {
      await fetch(API + '/sources/' + id, { method: 'DELETE' });
      toast('Source removed');
      loadSources();
    }

    // -----------------------------------------------------------------------
    // v3: Setup (Onboarding) Tab
    // -----------------------------------------------------------------------
    async function loadOnboarding() {
      try {
        const data = await apiFetch(API + '/company');

        if (data.exists) {
          document.getElementById('ob-name').value = data.name || '';
          document.getElementById('ob-industry').value = data.industry || '';
          document.getElementById('ob-products').value = (data.products || []).join(', ');
          document.getElementById('ob-process').value = data.process_flow || '';
          if (data.systems) {
            document.getElementById('ob-systems').value = data.systems
              .map(s => `${s.name}${s.description ? ' - ' + s.description : ''}`)
              .join('\n');
          }
        }
      } catch (e) { console.error('loadOnboarding:', e); }

      // Load all setup sub-panel data
      loadThresholds();
      loadProcessSteps();
      loadProcessIO();
      loadContextEntries();

      // Update checklist after a short delay to allow data to load
      setTimeout(updateSetupChecklist, 500);
    }

    async function saveOnboarding() {
      const systems = document.getElementById('ob-systems').value.trim().split('\n')
        .filter(l => l.trim())
        .map(l => {
          const parts = l.split(' - ');
          return { name: parts[0].trim(), description: (parts[1] || '').trim() };
        });

      const products = document.getElementById('ob-products').value.trim()
        .split(',').map(p => p.trim()).filter(Boolean);

      try {
        const data = await apiFetch(API + '/company/onboard', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name: document.getElementById('ob-name').value.trim(),
            industry: document.getElementById('ob-industry').value,
            products,
            process_flow: document.getElementById('ob-process').value.trim(),
            systems,
          }),
        });
        if (data.error) return toast('Error: ' + data.error);
        const pct = data.completeness || 0;
        document.getElementById('setup-completeness').textContent = pct + '% complete';
        document.getElementById('setup-progress').style.width = pct + '%';
        toast('Company profile saved');
        markFeedDirty();
      } catch (e) { toast('Failed to save profile'); }
    }

    async function loadThresholds() {
      try {
        const thresholds = await apiFetch(API + '/thresholds');
        const body = document.getElementById('thresholds-body');

        if (!thresholds.length || thresholds.error) {
          body.innerHTML = '<div class="feed-empty" style="padding:1rem;">No thresholds configured yet.</div>';
          return;
        }

        let html = '';
        for (const t of thresholds) {
          html += `<div class="threshold-card">`;
          html += `<div><strong>${esc(t.metric_name)}</strong>`;
          if (t.table_name) html += ` <span style="color:var(--muted);font-size:0.7rem;">(${esc(t.table_name)}.${esc(t.column_name || '')})</span>`;
          html += `</div>`;
          html += `<div class="threshold-range">`;
          html += `Normal: ${t.normal_min ?? 'â€”'}â€“${t.normal_max ?? 'â€”'}`;
          if (t.unit) html += ` ${esc(t.unit)}`;
          html += `</div>`;
          html += `<button class="btn-sm btn-secondary" onclick="deleteThreshold(${t.id})">Remove</button>`;
          html += `</div>`;
        }
        body.innerHTML = html;
        updateSetupChecklist();
      } catch (e) { console.error('loadThresholds:', e); }
    }

    function showAddThresholdModal() {
      document.getElementById('threshold-modal').classList.add('active');
    }

    document.getElementById('threshold-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('threshold-modal'))
        document.getElementById('threshold-modal').classList.remove('active');
    });

    async function submitThreshold() {
      const metric = document.getElementById('th-metric').value.trim();
      if (!metric) return toast('Enter a metric name');

      const getNum = id => { const v = document.getElementById(id).value; return v ? parseFloat(v) : null; };

      try {
        const data = await apiFetch(API + '/thresholds', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            metric_name: metric,
            table_name: document.getElementById('th-table').value.trim() || null,
            column_name: document.getElementById('th-column').value.trim() || null,
            unit: document.getElementById('th-unit').value.trim() || null,
            normal_min: getNum('th-normal-min'),
            normal_max: getNum('th-normal-max'),
            warning_min: getNum('th-warning-min'),
            warning_max: getNum('th-warning-max'),
            critical_min: getNum('th-critical-min'),
            critical_max: getNum('th-critical-max'),
          }),
        });
        if (data.error) return toast('Error: ' + data.error);
        toast('Threshold saved');
        markFeedDirty();
        document.getElementById('threshold-modal').classList.remove('active');
        loadThresholds();
      } catch (e) { toast('Failed to save threshold'); }
    }

    async function deleteThreshold(id) {
      await fetch(API + '/thresholds/' + id, { method: 'DELETE' });
      toast('Threshold removed');
      markFeedDirty();
      loadThresholds();
    }

    // -----------------------------------------------------------------------
    // v3: Global Data Health Indicator
    // -----------------------------------------------------------------------
    async function loadDataHealth() {
      const el = document.getElementById('data-health-global');
      try {
        const data = await apiFetch(API + '/sanctity/summary');
        const sev = data.by_severity || {};
        const critical = sev.critical || 0;
        const warning = sev.warning || 0;
        const info = sev.info || 0;
        const total = critical + warning + info;

        if (total === 0) {
          el.className = 'data-health-global healthy';
          el.textContent = 'Data Health: OK';
          el.title = 'No data quality issues detected';
        } else if (critical > 0) {
          el.className = 'data-health-global critical';
          el.textContent = `${critical} critical issue${critical > 1 ? 's' : ''}`;
          el.title = `${critical} critical, ${warning} warning, ${info} info issues`;
        } else if (warning > 0) {
          el.className = 'data-health-global warning';
          el.textContent = `${warning} warning${warning > 1 ? 's' : ''}`;
          el.title = `${warning} warning, ${info} info issues`;
        } else {
          el.className = 'data-health-global healthy';
          el.textContent = `${info} info`;
          el.title = `${info} informational issues`;
        }

        // Click to go to feed filtered by data issues
        el.onclick = () => {
          document.querySelector('[data-panel="feed"]').click();
          setTimeout(() => filterFeed('sanctity'), 200);
        };
      } catch {
        el.className = 'data-health-global';
        el.textContent = '';
      }
    }

    // Load data health on page load and periodically
    loadDataHealth();
    setInterval(loadDataHealth, 120000); // Refresh every 2 minutes

    // -----------------------------------------------------------------------
    // v3: Tab auto-load hooks
    // -----------------------------------------------------------------------
    const originalTabListener = document.querySelectorAll('.tab');
    originalTabListener.forEach(tab => {
      tab.addEventListener('click', () => {
        const panel = tab.dataset.panel;
        if (panel === 'alerts') loadAlerts();
        if (panel === 'sources') loadSources();
        if (panel === 'setup') loadOnboarding();
      });
    });

    // -----------------------------------------------------------------------
    // Heat Analysis
    // -----------------------------------------------------------------------
    async function loadHeatAnalysis(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const heatCol = cols.find(c => /heat|batch|lot/i.test(c)) || cols[0];
        const weightCol = cols.find(c => /weight|wt|qty|quantity|tonnage/i.test(c)) || cols[1];
        const gradeCol = cols.find(c => /grade|quality|type/i.test(c)) || null;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/heat-analysis`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({heat_column: heatCol, weight_column: weightCol, grade_column: gradeCol})
        });
        if (res.error) { _showOverlay(`<h3>Heat Analysis</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Heat Analysis â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Heats:</b> ${res.total_heats} | <b>Total Weight:</b> ${fmt(res.total_weight)} | <b>Avg:</b> ${fmt(res.avg_weight)}</p>`;
        if (res.grade_distribution) {
          html += `<table class="ov-table"><tr><th>Grade</th><th>Count</th></tr>`;
          for (const [g,c] of Object.entries(res.grade_distribution)) html += `<tr><td>${esc(g)}</td><td>${c}</td></tr>`;
          html += `</table>`;
        }
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadChemistry(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const heatCol = cols.find(c => /heat|batch|lot/i.test(c)) || cols[0];
        const elemCols = cols.filter(c => /^(C|Mn|Si|S|P|Cr|Ni|Mo|V|Ti|Al|Cu|Nb|Fe|Mg)$/i.test(c));
        if (elemCols.length === 0) { _showOverlay(`<h3>Chemistry</h3><p>No element columns found</p>`); return; }
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/chemistry-analysis`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({heat_column: heatCol, element_columns: elemCols})
        });
        if (res.error) { _showOverlay(`<h3>Chemistry</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Chemistry Analysis â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Heats Analyzed:</b> ${res.total_heats}</p>`;
        html += `<table class="ov-table"><tr><th>Element</th><th>Mean</th><th>Std</th><th>Min</th><th>Max</th><th>In-Spec %</th></tr>`;
        for (const e of res.elements) {
          html += `<tr><td>${esc(e.element)}</td><td>${e.mean?.toFixed(4)||'-'}</td><td>${e.std?.toFixed(4)||'-'}</td><td>${e.min?.toFixed(4)||'-'}</td><td>${e.max?.toFixed(4)||'-'}</td><td>${e.in_spec_pct != null ? e.in_spec_pct+'%' : '-'}</td></tr>`;
        }
        html += `</table>`;
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // Dispatch Gate
    // -----------------------------------------------------------------------
    async function loadGateTraffic(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const timeCol = cols.find(c => /time|hour|shift|date|period/i.test(c)) || cols[0];
        const vehicleCol = cols.find(c => /vehicle|truck|lorry|reg/i.test(c)) || null;
        const dirCol = cols.find(c => /direction|dir|in.?out|type/i.test(c)) || null;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/gate-traffic`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({time_column: timeCol, vehicle_column: vehicleCol, direction_column: dirCol})
        });
        if (res.error) { _showOverlay(`<h3>Gate Traffic</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Gate Traffic â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Vehicles:</b> ${res.total_vehicles} | <b>Peak:</b> ${esc(res.peak_period)} | <b>Off-peak:</b> ${esc(res.off_peak_period)}</p>`;
        html += `<table class="ov-table"><tr><th>Period</th><th>Vehicles</th><th>%</th></tr>`;
        for (const p of res.periods) html += `<tr><td>${esc(p.period)}</td><td>${p.vehicle_count}</td><td>${p.pct_of_total}%</td></tr>`;
        html += `</table>`;
        if (res.direction_split) {
          html += `<p><b>Direction:</b> ${Object.entries(res.direction_split).map(([k,v])=>`${esc(k)}=${v}`).join(', ')}</p>`;
        }
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadWeighbridge(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const vehicleCol = cols.find(c => /vehicle|truck|lorry|reg/i.test(c)) || cols[0];
        const grossCol = cols.find(c => /gross/i.test(c)) || cols[1];
        const tareCol = cols.find(c => /tare/i.test(c)) || cols[2];
        const matCol = cols.find(c => /material|product|item|commodity/i.test(c)) || null;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/weighbridge`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({vehicle_column: vehicleCol, gross_column: grossCol, tare_column: tareCol, material_column: matCol})
        });
        if (res.error) { _showOverlay(`<h3>Weighbridge</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Weighbridge â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Vehicles:</b> ${res.total_vehicles} | <b>Total Net:</b> ${fmt(res.total_net_weight)} | <b>Avg Net:</b> ${fmt(res.avg_net_weight)}</p>`;
        if (res.by_material) {
          html += `<table class="ov-table"><tr><th>Material</th><th>Net Weight</th></tr>`;
          for (const [m,w] of Object.entries(res.by_material)) html += `<tr><td>${esc(m)}</td><td>${fmt(w)}</td></tr>`;
          html += `</table>`;
        }
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // Environmental Monitor
    // -----------------------------------------------------------------------
    async function loadEmissions(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const srcCol = cols.find(c => /source|stack|chimney|unit/i.test(c)) || cols[0];
        const pollCol = cols.find(c => /pollutant|parameter|emission|gas/i.test(c)) || cols[1];
        const valCol = cols.find(c => /value|reading|concentration|level/i.test(c)) || cols[2];
        const limCol = cols.find(c => /limit|standard|threshold/i.test(c)) || null;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/emissions`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({source_column: srcCol, pollutant_column: pollCol, value_column: valCol, limit_column: limCol})
        });
        if (res.error) { _showOverlay(`<h3>Emissions</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Emissions Analysis â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Readings:</b> ${res.total_readings} | <b>Compliance:</b> ${res.overall_compliance_pct != null ? res.overall_compliance_pct+'%' : 'N/A'}</p>`;
        html += `<table class="ov-table"><tr><th>Source</th><th>Pollutant</th><th>Avg</th><th>Max</th><th>Compliance%</th><th>Trend</th></tr>`;
        for (const s of res.sources) html += `<tr><td>${esc(s.source)}</td><td>${esc(s.pollutant)}</td><td>${fmt(s.average)}</td><td>${fmt(s.max_value)}</td><td>${s.compliance_pct != null ? s.compliance_pct+'%' : '-'}</td><td>${esc(s.trend||'-')}</td></tr>`;
        html += `</table>`;
        if (res.exceedances && res.exceedances.length > 0) {
          html += `<h4 style="margin-top:0.5rem;color:#ef4444;">Exceedances (${res.exceedances.length})</h4>`;
          html += `<table class="ov-table"><tr><th>Source</th><th>Pollutant</th><th>Value</th><th>Limit</th><th>Excess%</th></tr>`;
          for (const e of res.exceedances.slice(0,20)) html += `<tr><td>${esc(e.source)}</td><td>${esc(e.pollutant)}</td><td>${fmt(e.value)}</td><td>${fmt(e.limit)}</td><td>${e.excess_pct}%</td></tr>`;
          html += `</table>`;
        }
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // Maintenance Scheduler
    // -----------------------------------------------------------------------
    async function loadMaintenanceHistory(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const equipCol = cols.find(c => /equipment|machine|asset|unit/i.test(c)) || cols[0];
        const dateCol = cols.find(c => /date|time|when/i.test(c)) || cols[1];
        const typeCol = cols.find(c => /type|category|kind|maint/i.test(c)) || cols[2];
        const durCol = cols.find(c => /duration|hours|time_taken|downtime/i.test(c)) || null;
        const costCol = cols.find(c => /cost|expense|amount/i.test(c)) || null;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/maintenance-history`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({equipment_column: equipCol, date_column: dateCol, type_column: typeCol, duration_column: durCol, cost_column: costCol})
        });
        if (res.error) { _showOverlay(`<h3>Maintenance</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Maintenance History â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Events:</b> ${res.total_events} | <b>Corrective Ratio:</b> ${(res.overall_corrective_ratio*100).toFixed(1)}%</p>`;
        html += `<table class="ov-table"><tr><th>Equipment</th><th>Events</th><th>Corrective%</th><th>Downtime</th><th>Cost</th></tr>`;
        for (const e of res.equipment) html += `<tr><td>${esc(e.equipment)}</td><td>${e.event_count}</td><td>${(e.corrective_ratio*100).toFixed(1)}%</td><td>${e.total_downtime != null ? fmt(e.total_downtime) : '-'}</td><td>${e.total_cost != null ? fmt(e.total_cost) : '-'}</td></tr>`;
        html += `</table>`;
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // Contract Analyzer
    // -----------------------------------------------------------------------
    async function loadContracts(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const contractCol = cols.find(c => /contract|agreement|po|order/i.test(c)) || cols[0];
        const vendorCol = cols.find(c => /vendor|supplier|party|company/i.test(c)) || cols[1];
        const valueCol = cols.find(c => /value|amount|cost|price/i.test(c)) || cols[2];
        const startCol = cols.find(c => /start|begin|from/i.test(c)) || null;
        const endCol = cols.find(c => /end|expir|to|till/i.test(c)) || null;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/contracts`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({contract_column: contractCol, vendor_column: vendorCol, value_column: valueCol, start_column: startCol, end_column: endCol})
        });
        if (res.error) { _showOverlay(`<h3>Contracts</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Contract Analysis â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Contracts:</b> ${res.total_contracts} | <b>Total Value:</b> ${fmt(res.total_value)} | <b>Vendors:</b> ${res.vendor_count}</p>`;
        html += `<table class="ov-table"><tr><th>Vendor</th><th>Contracts</th><th>Total Value</th><th>Avg Value</th></tr>`;
        for (const v of res.vendors) html += `<tr><td>${esc(v.vendor)}</td><td>${v.contract_count}</td><td>${fmt(v.total_value)}</td><td>${fmt(v.avg_value)}</td></tr>`;
        html += `</table>`;
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // Budget Tracker
    // -----------------------------------------------------------------------
    async function loadBudgetVsActual(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const catCol = cols.find(c => /category|department|head|item|type/i.test(c)) || cols[0];
        const budCol = cols.find(c => /budget|planned|estimate/i.test(c)) || cols[1];
        const actCol = cols.find(c => /actual|spent|real/i.test(c)) || cols[2];
        const perCol = cols.find(c => /period|month|quarter|date/i.test(c)) || null;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/budget-vs-actual`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({category_column: catCol, budget_column: budCol, actual_column: actCol, period_column: perCol})
        });
        if (res.error) { _showOverlay(`<h3>Budget</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Budget vs Actual â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Budget:</b> ${fmt(res.total_budget)} | <b>Actual:</b> ${fmt(res.total_actual)} | <b>Variance:</b> ${res.overall_variance_pct}%</p>`;
        html += `<table class="ov-table"><tr><th>Category</th><th>Budget</th><th>Actual</th><th>Variance%</th><th>Over?</th></tr>`;
        for (const c of res.categories) html += `<tr><td>${esc(c.category)}</td><td>${fmt(c.budget)}</td><td>${fmt(c.actual)}</td><td style="color:${c.over_budget?'#ef4444':'#22c55e'}">${c.variance_pct}%</td><td>${c.over_budget?'YES':''}</td></tr>`;
        html += `</table>`;
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadBurnRate(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const amtCol = cols.find(c => /amount|spend|cost|expense|value/i.test(c)) || cols[0];
        const dateCol = cols.find(c => /date|time|period|month/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/burn-rate`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({amount_column: amtCol, date_column: dateCol})
        });
        if (res.error) { _showOverlay(`<h3>Burn Rate</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Burn Rate â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Spent:</b> ${fmt(res.total_spent)} | <b>Days:</b> ${res.days_elapsed}</p>`;
        html += `<p><b>Daily Burn:</b> ${fmt(res.daily_burn)} | <b>Monthly Burn:</b> ${fmt(res.monthly_burn)}</p>`;
        if (res.remaining_budget != null) html += `<p><b>Remaining:</b> ${fmt(res.remaining_budget)} | <b>Days Until Exhaustion:</b> ${res.days_until_exhaustion || 'N/A'}</p>`;
        html += `<p><b>Trend:</b> ${esc(res.trend)}</p>`;
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // Demand Forecaster
    // -----------------------------------------------------------------------
    async function loadDemandPattern(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const prodCol = cols.find(c => /product|item|sku|material|name/i.test(c)) || cols[0];
        const qtyCol = cols.find(c => /quantity|qty|demand|units|volume/i.test(c)) || cols[1];
        const dateCol = cols.find(c => /date|period|month|time/i.test(c)) || cols[2];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/demand-pattern`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({product_column: prodCol, quantity_column: qtyCol, date_column: dateCol})
        });
        if (res.error) { _showOverlay(`<h3>Demand</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Demand Pattern â€” ${esc(tableName)}</h3>`;
        html += `<table class="ov-table"><tr><th>Product</th><th>Total</th><th>Avg</th><th>CV</th><th>Pattern</th><th>Trend</th></tr>`;
        for (const p of res.products) html += `<tr><td>${esc(p.product)}</td><td>${fmt(p.total_demand)}</td><td>${fmt(p.avg_demand)}</td><td>${p.cv?.toFixed(2)||'-'}</td><td>${esc(p.pattern)}</td><td>${esc(p.trend)}</td></tr>`;
        html += `</table>`;
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadDemandSeasonality(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const qtyCol = cols.find(c => /quantity|qty|demand|units|volume/i.test(c)) || cols[0];
        const dateCol = cols.find(c => /date|period|month|time/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/demand-seasonality`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({quantity_column: qtyCol, date_column: dateCol})
        });
        if (res.error) { _showOverlay(`<h3>Seasonality</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Demand Seasonality â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Seasonal:</b> ${res.is_seasonal ? 'Yes' : 'No'} | <b>Peak:</b> ${(res.peak_seasons||[]).join(', ')||'None'} | <b>Low:</b> ${(res.low_seasons||[]).join(', ')||'None'}</p>`;
        html += `<table class="ov-table"><tr><th>Period</th><th>Avg Demand</th><th>Seasonal Index</th></tr>`;
        for (const p of res.periods) html += `<tr><td>${esc(p.period)}</td><td>${fmt(p.avg_demand)}</td><td>${p.seasonal_index?.toFixed(2)||'-'}</td></tr>`;
        html += `</table>`;
        html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // Procurement / Finance / Projects
    // -----------------------------------------------------------------------
    async function loadPurchaseOrders(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const poCol = cols.find(c => /po|order|purchase/i.test(c)) || cols[0];
        const vendorCol = cols.find(c => /vendor|supplier|party/i.test(c)) || cols[1];
        const amtCol = cols.find(c => /amount|value|total|cost|price/i.test(c)) || cols[2];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/purchase-orders`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({po_column: poCol, vendor_column: vendorCol, amount_column: amtCol})
        });
        if (res.error) { _showOverlay(`<h3>Purchase Orders</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Purchase Orders â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total POs:</b> ${fmt(res.total_pos)} | <b>Total Value:</b> ${fmt(res.total_value)} | <b>Avg PO Value:</b> ${fmt(res.avg_po_value)}</p>`;
        if (res.vendors && res.vendors.length) {
          html += `<table class="ov-table"><tr><th>Vendor</th><th>POs</th><th>Total Value</th><th>Avg Value</th></tr>`;
          for (const v of res.vendors) html += `<tr><td>${esc(v.vendor)}</td><td>${v.po_count}</td><td>${fmt(v.total_value)}</td><td>${fmt(v.avg_value)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadPriceVariance(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const itemCol = cols.find(c => /item|material|product|sku/i.test(c)) || cols[0];
        const qtyCol = cols.find(c => /qty|quantity|units/i.test(c)) || cols[1];
        const actualCol = cols.find(c => /actual|price|rate|cost/i.test(c)) || cols[2];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/purchase-price-variance`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({item_column: itemCol, quantity_column: qtyCol, actual_price_column: actualCol})
        });
        if (res.error) { _showOverlay(`<h3>Price Variance</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Purchase Price Variance â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Variance:</b> ${fmt(res.total_variance)}</p>`;
        if (res.items && res.items.length) {
          html += `<table class="ov-table"><tr><th>Item</th><th>Avg Price</th><th>Std Price</th><th>Variance</th><th>Variance %</th></tr>`;
          for (const it of res.items) html += `<tr><td>${esc(it.item)}</td><td>${fmt(it.avg_price)}</td><td>${it.std_price?.toFixed(2)||'-'}</td><td>${fmt(it.variance)}</td><td>${it.variance_pct != null ? it.variance_pct+'%' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadVendorPerf(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const vendorCol = cols.find(c => /vendor|supplier/i.test(c)) || cols[0];
        const deliveryCol = cols.find(c => /delivery|received|actual/i.test(c)) || cols[1];
        const promisedCol = cols.find(c => /promised|due|expected|planned/i.test(c)) || cols[2];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/vendor-performance`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({vendor_column: vendorCol, delivery_date_column: deliveryCol, promised_date_column: promisedCol})
        });
        if (res.error) { _showOverlay(`<h3>Vendor Performance</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Vendor Performance â€” ${esc(tableName)}</h3>`;
        html += `<p><b>On-Time Rate:</b> ${res.on_time_rate != null ? res.on_time_rate+'%' : '-'} | <b>Avg Delay:</b> ${res.avg_delay != null ? res.avg_delay+' days' : '-'}</p>`;
        if (res.vendors && res.vendors.length) {
          html += `<table class="ov-table"><tr><th>Vendor</th><th>Deliveries</th><th>On-Time %</th><th>Avg Delay</th></tr>`;
          for (const v of res.vendors) html += `<tr><td>${esc(v.vendor)}</td><td>${v.deliveries}</td><td>${v.on_time_pct != null ? v.on_time_pct+'%' : '-'}</td><td>${v.avg_delay != null ? v.avg_delay+' days' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadProfitability(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const revCol = cols.find(c => /revenue|sales|income/i.test(c)) || cols[0];
        const costCol = cols.find(c => /cost|expense|cogs/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/profitability-ratios`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({revenue_column: revCol, cost_column: costCol})
        });
        if (res.error) { _showOverlay(`<h3>Profitability</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Profitability â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Overall Margin:</b> ${res.overall_margin != null ? res.overall_margin+'%' : '-'}</p>`;
        if (res.entities && res.entities.length) {
          html += `<table class="ov-table"><tr><th>Entity</th><th>Revenue</th><th>Cost</th><th>Profit</th><th>Margin %</th></tr>`;
          for (const e of res.entities) html += `<tr><td>${esc(e.entity)}</td><td>${fmt(e.revenue)}</td><td>${fmt(e.cost)}</td><td>${fmt(e.profit)}</td><td style="color:${e.margin>=0?'#22c55e':'#ef4444'}">${e.margin != null ? e.margin+'%' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadProjectStatus(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const projCol = cols.find(c => /project|name|title/i.test(c)) || cols[0];
        const statusCol = cols.find(c => /status|state|phase/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/project-status`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({project_column: projCol, status_column: statusCol})
        });
        if (res.error) { _showOverlay(`<h3>Project Status</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Project Status â€” ${esc(tableName)}</h3>`;
        if (res.status_breakdown) {
          html += `<p><b>Status Breakdown:</b></p>`;
          html += `<table class="ov-table"><tr><th>Status</th><th>Count</th></tr>`;
          for (const [s,c] of Object.entries(res.status_breakdown)) html += `<tr><td>${esc(s)}</td><td>${c}</td></tr>`;
          html += `</table>`;
        }
        if (res.projects && res.projects.length) {
          html += `<table class="ov-table" style="margin-top:8px;"><tr><th>Project</th><th>Status</th></tr>`;
          for (const p of res.projects) html += `<tr><td>${esc(p.project)}</td><td>${esc(p.status)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadProjectHealth(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const projCol = cols.find(c => /project|name|title/i.test(c)) || cols[0];
        const plannedCol = cols.find(c => /planned|budget|estimate/i.test(c)) || cols[1];
        const actualCol = cols.find(c => /actual|spent|real/i.test(c)) || cols[2];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/project-health`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({project_column: projCol, planned_column: plannedCol, actual_column: actualCol})
        });
        if (res.error) { _showOverlay(`<h3>Project Health</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Project Health â€” ${esc(tableName)}</h3>`;
        html += `<p><b>On-Track:</b> ${res.on_track_count ?? '-'} | <b>At-Risk:</b> ${res.at_risk_count ?? '-'} | <b>Over-Budget:</b> ${res.over_budget_count ?? '-'}</p>`;
        if (res.projects && res.projects.length) {
          html += `<table class="ov-table"><tr><th>Project</th><th>Planned</th><th>Actual</th><th>CPI</th><th>SPI</th><th>Health</th></tr>`;
          for (const p of res.projects) html += `<tr><td>${esc(p.project)}</td><td>${fmt(p.planned)}</td><td>${fmt(p.actual)}</td><td>${p.cpi?.toFixed(2)||'-'}</td><td>${p.spi?.toFixed(2)||'-'}</td><td>${esc(p.health||'-')}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // SCADA / Customers / Sales
    // -----------------------------------------------------------------------
    async function loadSensorReadings(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const sensorCol = cols.find(c => /sensor|tag|instrument|device/i.test(c)) || cols[0];
        const valueCol = cols.find(c => /value|reading|measurement|temp|pressure/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/sensor-readings`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({sensor_column: sensorCol, value_column: valueCol})
        });
        if (res.error) { _showOverlay(`<h3>Sensor Readings</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Sensor Readings â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Sensors:</b> ${res.sensor_count ?? '-'} | <b>Total Readings:</b> ${fmt(res.total_readings)}</p>`;
        if (res.sensors && res.sensors.length) {
          html += `<table class="ov-table"><tr><th>Sensor</th><th>Min</th><th>Max</th><th>Mean</th><th>Std</th></tr>`;
          for (const s of res.sensors) html += `<tr><td>${esc(s.sensor)}</td><td>${s.min?.toFixed(2)||'-'}</td><td>${s.max?.toFixed(2)||'-'}</td><td>${s.mean?.toFixed(2)||'-'}</td><td>${s.std?.toFixed(2)||'-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadAlarms(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const alarmCol = cols.find(c => /alarm|alert|event|fault/i.test(c)) || cols[0];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/alarm-frequency`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({alarm_column: alarmCol})
        });
        if (res.error) { _showOverlay(`<h3>Alarms</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Alarm Frequency â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Alarms:</b> ${fmt(res.total_alarms)}</p>`;
        if (res.alarms && res.alarms.length) {
          html += `<table class="ov-table"><tr><th>Alarm</th><th>Count</th><th>% of Total</th></tr>`;
          for (const a of res.alarms) html += `<tr><td>${esc(a.alarm)}</td><td>${a.count}</td><td>${a.pct != null ? a.pct+'%' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadCustomerSegments(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const custCol = cols.find(c => /customer|client|buyer|account/i.test(c)) || cols[0];
        const revCol = cols.find(c => /revenue|amount|sales|value|spend/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/customer-segments`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({customer_column: custCol, revenue_column: revCol})
        });
        if (res.error) { _showOverlay(`<h3>Customer Segments</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Customer Segments â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Customers:</b> ${res.total_customers ?? '-'} | <b>Total Revenue:</b> ${fmt(res.total_revenue)}</p>`;
        if (res.tiers && res.tiers.length) {
          html += `<table class="ov-table"><tr><th>Tier</th><th>Customers</th><th>Revenue</th><th>% of Revenue</th></tr>`;
          for (const t of res.tiers) html += `<tr><td>${esc(t.tier)}</td><td>${t.customer_count}</td><td>${fmt(t.revenue)}</td><td>${t.revenue_pct != null ? t.revenue_pct+'%' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadChurnRisk(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const custCol = cols.find(c => /customer|client|buyer|account/i.test(c)) || cols[0];
        const dateCol = cols.find(c => /date|timestamp|time|last/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/churn-risk`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({customer_column: custCol, date_column: dateCol})
        });
        if (res.error) { _showOverlay(`<h3>Churn Risk</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Churn Risk â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Churn Rate:</b> ${res.churn_rate != null ? res.churn_rate+'%' : '-'} | <b>At-Risk Rate:</b> ${res.at_risk_rate != null ? res.at_risk_rate+'%' : '-'}</p>`;
        if (res.status_breakdown) {
          html += `<table class="ov-table"><tr><th>Status</th><th>Count</th><th>%</th></tr>`;
          for (const [s,v] of Object.entries(res.status_breakdown)) html += `<tr><td>${esc(s)}</td><td>${v.count ?? v}</td><td>${v.pct != null ? v.pct+'%' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadSalesPerf(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const amtCol = cols.find(c => /amount|revenue|sales|value|total/i.test(c)) || cols[0];
        const dateCol = cols.find(c => /date|period|month|quarter|year/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/sales-performance`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({amount_column: amtCol, date_column: dateCol})
        });
        if (res.error) { _showOverlay(`<h3>Sales Performance</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Sales Performance â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Sales:</b> ${fmt(res.total_sales)} | <b>Growth Rate:</b> ${res.growth_rate != null ? res.growth_rate+'%' : '-'}</p>`;
        if (res.periods && res.periods.length) {
          html += `<table class="ov-table"><tr><th>Period</th><th>Sales</th><th>Growth %</th></tr>`;
          for (const p of res.periods) html += `<tr><td>${esc(p.period)}</td><td>${fmt(p.sales)}</td><td style="color:${p.growth>=0?'#22c55e':'#ef4444'}">${p.growth != null ? p.growth+'%' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadProductMix(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const prodCol = cols.find(c => /product|item|sku|service/i.test(c)) || cols[0];
        const amtCol = cols.find(c => /amount|revenue|sales|value|total/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/product-mix`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({product_column: prodCol, amount_column: amtCol})
        });
        if (res.error) { _showOverlay(`<h3>Product Mix</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Product Mix â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Products:</b> ${res.product_count ?? '-'} | <b>Concentration Risk:</b> ${res.concentration_risk ?? '-'}</p>`;
        if (res.products && res.products.length) {
          html += `<table class="ov-table"><tr><th>Product</th><th>Revenue</th><th>% of Total</th><th>Cumulative %</th></tr>`;
          for (const p of res.products) html += `<tr><td>${esc(p.product)}</td><td>${fmt(p.revenue)}</td><td>${p.pct != null ? p.pct+'%' : '-'}</td><td>${p.cumulative_pct != null ? p.cumulative_pct+'%' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadDiscounts(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const amtCol = cols.find(c => /amount|revenue|sales|value|total/i.test(c)) || cols[0];
        const discCol = cols.find(c => /discount|disc|rebate|reduction/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/discount-impact`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({amount_column: amtCol, discount_column: discCol})
        });
        if (res.error) { _showOverlay(`<h3>Discount Impact</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Discount Impact â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Avg Discount:</b> ${res.avg_discount != null ? res.avg_discount+'%' : '-'} | <b>Revenue Impact:</b> ${fmt(res.revenue_impact)}</p>`;
        if (res.distribution && res.distribution.length) {
          html += `<table class="ov-table"><tr><th>Range</th><th>Count</th><th>Avg Discount</th><th>Revenue</th></tr>`;
          for (const d of res.distribution) html += `<tr><td>${esc(d.range)}</td><td>${d.count}</td><td>${d.avg_discount != null ? d.avg_discount+'%' : '-'}</td><td>${fmt(d.revenue)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadCashFlow(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const inflowCol = cols.find(c => /inflow|income|receipt|credit|received/i.test(c)) || cols[0];
        const outflowCol = cols.find(c => /outflow|expense|payment|debit|paid/i.test(c)) || cols[1];
        const dateCol = cols.find(c => /date|period|month|year/i.test(c));
        const body = {inflow_column: inflowCol, outflow_column: outflowCol};
        if (dateCol) body.date_column = dateCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/cash-flow`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Cash Flow</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Cash Flow â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Net:</b> ${fmt(res.net_cash_flow)} | <b>Inflow:</b> ${fmt(res.total_inflow)} | <b>Outflow:</b> ${fmt(res.total_outflow)}</p>`;
        if (res.periods && res.periods.length) {
          html += `<table class="ov-table"><tr><th>Period</th><th>Inflow</th><th>Outflow</th><th>Net</th></tr>`;
          for (const p of res.periods) html += `<tr><td>${esc(String(p.period))}</td><td>${fmt(p.inflow)}</td><td>${fmt(p.outflow)}</td><td>${fmt(p.net)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadWorkingCapital(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const recCol = cols.find(c => /receivable|ar|debtors/i.test(c)) || cols[0];
        const payCol = cols.find(c => /payable|ap|creditors/i.test(c)) || cols[1];
        const invCol = cols.find(c => /inventory|stock/i.test(c));
        const body = {receivables_column: recCol, payables_column: payCol};
        if (invCol) body.inventory_column = invCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/working-capital`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Working Capital</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Working Capital â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Working Capital:</b> ${fmt(res.working_capital)} | <b>Current Ratio:</b> ${res.current_ratio} | <b>Receivables:</b> ${fmt(res.receivables_total)} | <b>Payables:</b> ${fmt(res.payables_total)}</p>`;
        if (res.periods && res.periods.length) {
          html += `<table class="ov-table"><tr><th>Period</th><th>Receivables</th><th>Payables</th><th>Working Capital</th></tr>`;
          for (const p of res.periods) html += `<tr><td>${esc(String(p.period))}</td><td>${fmt(p.receivables)}</td><td>${fmt(p.payables)}</td><td>${fmt(p.working_capital)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadRiskAssessment(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const riskCol = cols.find(c => /risk|threat|hazard|issue/i.test(c)) || cols[0];
        const likCol = cols.find(c => /likelihood|probability|prob|chance/i.test(c)) || cols[1];
        const impCol = cols.find(c => /impact|severity|consequence/i.test(c)) || cols[2];
        const catCol = cols.find(c => /category|type|area/i.test(c));
        const body = {risk_column: riskCol, likelihood_column: likCol, impact_column: impCol};
        if (catCol) body.category_column = catCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/risk-assessment`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Risk Assessment</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Risk Assessment â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total:</b> ${res.total_risks} | <b>Critical:</b> ${res.critical_count} | <b>High:</b> ${res.high_count} | <b>Medium:</b> ${res.medium_count} | <b>Low:</b> ${res.low_count}</p>`;
        if (res.risks && res.risks.length) {
          html += `<table class="ov-table"><tr><th>Risk</th><th>Likelihood</th><th>Impact</th><th>Score</th><th>Level</th></tr>`;
          for (const r of res.risks.slice(0,20)) html += `<tr><td>${esc(String(r.risk))}</td><td>${r.likelihood}</td><td>${r.impact}</td><td>${r.score}</td><td>${esc(r.level)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadComplianceStatus(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const reqCol = cols.find(c => /requirement|regulation|rule|control|standard/i.test(c)) || cols[0];
        const statCol = cols.find(c => /status|compliant|compliance|result/i.test(c)) || cols[1];
        const catCol = cols.find(c => /category|area|domain|type/i.test(c));
        const body = {requirement_column: reqCol, status_column: statCol};
        if (catCol) body.category_column = catCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/compliance-status`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Compliance</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Compliance Status â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total:</b> ${res.total_requirements} | <b>Compliant:</b> ${res.compliant_count} | <b>Non-Compliant:</b> ${res.non_compliant_count} | <b>Rate:</b> ${res.compliance_rate}%</p>`;
        if (res.by_category && res.by_category.length) {
          html += `<table class="ov-table"><tr><th>Category</th><th>Total</th><th>Compliant</th><th>Rate</th></tr>`;
          for (const c of res.by_category) html += `<tr><td>${esc(String(c.category))}</td><td>${c.total}</td><td>${c.compliant}</td><td>${c.rate}%</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadAssetAge(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const assetCol = cols.find(c => /asset|equipment|machine|item/i.test(c)) || cols[0];
        const dateCol = cols.find(c => /purchase|acquisition|install|date/i.test(c)) || cols[1];
        const catCol = cols.find(c => /category|type|class/i.test(c));
        const costCol = cols.find(c => /cost|value|price/i.test(c));
        const body = {asset_column: assetCol, purchase_date_column: dateCol};
        if (catCol) body.category_column = catCol;
        if (costCol) body.cost_column = costCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/asset-age`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Asset Age</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Asset Age Analysis â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Assets:</b> ${res.total_assets} | <b>Avg Age:</b> ${res.avg_age_years} yrs | <b>Oldest:</b> ${res.oldest_age} yrs</p>`;
        if (res.aging_distribution && res.aging_distribution.length) {
          html += `<table class="ov-table"><tr><th>Age Bracket</th><th>Count</th></tr>`;
          for (const d of res.aging_distribution) html += `<tr><td>${esc(String(d.bracket))}</td><td>${d.count}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadPriceDistribution(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const priceCol = cols.find(c => /price|rate|cost|amount|value/i.test(c)) || cols[0];
        const prodCol = cols.find(c => /product|item|sku|name/i.test(c));
        const catCol = cols.find(c => /category|type|group/i.test(c));
        const body = {price_column: priceCol};
        if (prodCol) body.product_column = prodCol;
        if (catCol) body.category_column = catCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/price-distribution`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Price Distribution</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Price Distribution â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Mean:</b> ${fmt(res.mean_price)} | <b>Median:</b> ${fmt(res.median_price)} | <b>Std Dev:</b> ${fmt(res.std_dev)} | <b>Range:</b> ${fmt(res.min_price)} â€“ ${fmt(res.max_price)}</p>`;
        if (res.by_category && res.by_category.length) {
          html += `<table class="ov-table"><tr><th>Category</th><th>Mean</th><th>Median</th><th>Count</th></tr>`;
          for (const c of res.by_category) html += `<tr><td>${esc(String(c.category))}</td><td>${fmt(c.mean)}</td><td>${fmt(c.median)}</td><td>${c.count}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadAttritionRate(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const empCol = cols.find(c => /employee|emp|staff|worker|name|id/i.test(c)) || cols[0];
        const statCol = cols.find(c => /status|active|left|terminated|resigned/i.test(c)) || cols[1];
        const dateCol = cols.find(c => /date|period|month|year/i.test(c));
        const deptCol = cols.find(c => /department|dept|team|division/i.test(c));
        const body = {employee_column: empCol, status_column: statCol};
        if (dateCol) body.date_column = dateCol;
        if (deptCol) body.department_column = deptCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/attrition-rate`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Attrition Rate</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Attrition Rate â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total:</b> ${res.total_employees} | <b>Active:</b> ${res.active_count} | <b>Left:</b> ${res.left_count} | <b>Rate:</b> ${res.attrition_rate}%</p>`;
        if (res.by_department && res.by_department.length) {
          html += `<table class="ov-table"><tr><th>Department</th><th>Total</th><th>Left</th><th>Rate</th></tr>`;
          for (const d of res.by_department) html += `<tr><td>${esc(String(d.department))}</td><td>${d.total}</td><td>${d.left}</td><td>${d.rate}%</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadAttritionDrivers(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const empCol = cols.find(c => /employee|emp|staff|worker|name|id/i.test(c)) || cols[0];
        const statCol = cols.find(c => /status|active|left|terminated|resigned/i.test(c)) || cols[1];
        // Use remaining columns as factor columns
        const factorCols = cols.filter(c => c !== empCol && c !== statCol);
        if (!factorCols.length) { _showOverlay(`<h3>Attrition Drivers</h3><p>Need more columns to analyze drivers</p>`); return; }
        const body = {employee_column: empCol, status_column: statCol, factor_columns: factorCols};
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/attrition-drivers`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Attrition Drivers</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Attrition Drivers â€” ${esc(tableName)}</h3>`;
        if (res.top_driver) html += `<p><b>Top Driver:</b> ${esc(res.top_driver)}</p>`;
        if (res.factors && res.factors.length) {
          html += `<table class="ov-table"><tr><th>Factor</th><th>Type</th><th>Leaver</th><th>Stayer</th><th>Impact</th><th>Direction</th></tr>`;
          for (const f of res.factors) html += `<tr><td>${esc(f.factor_name)}</td><td>${esc(f.factor_type)}</td><td>${esc(String(f.leaver_value))}</td><td>${esc(String(f.stayer_value))}</td><td>${f.impact}%</td><td>${esc(f.direction)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadRevenueForecast(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const revCol = cols.find(c => /revenue|sales|income|amount/i.test(c)) || cols[0];
        const dateCol = cols.find(c => /date|period|month|year/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/revenue-forecast`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({revenue_column: revCol, date_column: dateCol})
        });
        if (res.error) { _showOverlay(`<h3>Revenue Forecast</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Revenue Forecast â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Trend:</b> ${esc(res.trend || '-')} | <b>Avg Growth:</b> ${res.avg_growth_rate != null ? res.avg_growth_rate+'%' : '-'} | <b>Total Historical:</b> ${fmt(res.total_historical)}</p>`;
        if (res.periods && res.periods.length) {
          html += `<table class="ov-table"><tr><th>Period</th><th>Revenue</th><th>Growth</th></tr>`;
          for (const p of res.periods) html += `<tr><td>${esc(String(p.period))}</td><td>${fmt(p.revenue)}</td><td>${p.growth_rate != null ? p.growth_rate+'%' : '-'}</td></tr>`;
          html += `</table>`;
        }
        if (res.forecasts && res.forecasts.length) {
          html += `<h4>Forecast</h4><table class="ov-table"><tr><th>Period</th><th>Projected</th></tr>`;
          for (const f of res.forecasts) html += `<tr><td>${esc(String(f.period))}</td><td>${fmt(f.revenue)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadReceivablesAging(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const custCol = cols.find(c => /customer|client|party|buyer|name/i.test(c)) || cols[0];
        const amtCol = cols.find(c => /amount|value|balance|outstanding/i.test(c)) || cols[1];
        const dateCol = cols.find(c => /invoice.*date|date|created/i.test(c)) || cols[2];
        const dueCol = cols.find(c => /due.*date|payment.*date|maturity/i.test(c));
        const body = {customer_column: custCol, amount_column: amtCol, invoice_date_column: dateCol};
        if (dueCol) body.due_date_column = dueCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/receivables-aging`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>AR Aging</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Receivables Aging â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Outstanding:</b> ${fmt(res.total_outstanding)} | <b>Total Overdue:</b> ${fmt(res.total_overdue)} | <b>Avg Days:</b> ${res.avg_days_outstanding}</p>`;
        if (res.buckets && res.buckets.length) {
          html += `<table class="ov-table"><tr><th>Bucket</th><th>Count</th><th>Amount</th><th>% of Total</th></tr>`;
          for (const b of res.buckets) html += `<tr><td>${esc(b.label)}</td><td>${b.count}</td><td>${fmt(b.amount)}</td><td>${b.pct_of_total}%</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadPipelineStages(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const dealCol = cols.find(c => /deal|opportunity|lead|name/i.test(c)) || cols[0];
        const stageCol = cols.find(c => /stage|status|phase|step/i.test(c)) || cols[1];
        const valCol = cols.find(c => /value|amount|revenue|price/i.test(c)) || cols[2];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/pipeline-stages`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({deal_column: dealCol, stage_column: stageCol, value_column: valCol})
        });
        if (res.error) { _showOverlay(`<h3>Pipeline</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Pipeline Stages â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total Deals:</b> ${res.total_deals} | <b>Total Value:</b> ${fmt(res.total_value)} | <b>Weighted:</b> ${fmt(res.weighted_value)}</p>`;
        if (res.stages && res.stages.length) {
          html += `<table class="ov-table"><tr><th>Stage</th><th>Deals</th><th>Value</th><th>Avg Value</th><th>% Deals</th></tr>`;
          for (const s of res.stages) html += `<tr><td>${esc(s.stage)}</td><td>${s.deal_count}</td><td>${fmt(s.total_value)}</td><td>${fmt(s.avg_value)}</td><td>${s.pct_of_deals}%</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadWinRate(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const dealCol = cols.find(c => /deal|opportunity|lead|name/i.test(c)) || cols[0];
        const stageCol = cols.find(c => /stage|status|phase|outcome/i.test(c)) || cols[1];
        const valCol = cols.find(c => /value|amount|revenue/i.test(c));
        const ownerCol = cols.find(c => /owner|rep|sales.*person|agent/i.test(c));
        const body = {deal_column: dealCol, stage_column: stageCol};
        if (valCol) body.value_column = valCol;
        if (ownerCol) body.owner_column = ownerCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/win-rate`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>Win Rate</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Win Rate â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Win Rate:</b> ${res.overall_win_rate}% | <b>Won:</b> ${res.total_won} | <b>Lost:</b> ${res.total_lost} | <b>Won Value:</b> ${fmt(res.won_value)}</p>`;
        if (res.by_owner && res.by_owner.length) {
          html += `<table class="ov-table"><tr><th>Owner</th><th>Won</th><th>Lost</th><th>Win Rate</th><th>Won Value</th></tr>`;
          for (const o of res.by_owner) html += `<tr><td>${esc(o.owner)}</td><td>${o.won}</td><td>${o.lost}</td><td>${o.win_rate}%</td><td>${fmt(o.won_value)}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadProductAssociations(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const txnCol = cols.find(c => /transaction|order|invoice|basket|receipt/i.test(c)) || cols[0];
        const prodCol = cols.find(c => /product|item|sku|name/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/product-associations`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({transaction_column: txnCol, product_column: prodCol})
        });
        if (res.error) { _showOverlay(`<h3>Market Basket</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Product Associations â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Transactions:</b> ${res.total_transactions} | <b>Products:</b> ${res.unique_products} | <b>Avg Basket:</b> ${res.avg_basket_size}</p>`;
        if (res.pairs && res.pairs.length) {
          html += `<table class="ov-table"><tr><th>Product A</th><th>Product B</th><th>Support</th><th>Lift</th><th>Count</th></tr>`;
          for (const p of res.pairs.slice(0,15)) html += `<tr><td>${esc(p.product_a)}</td><td>${esc(p.product_b)}</td><td>${p.support}</td><td>${p.lift}</td><td>${p.co_occurrence_count}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadSLACompliance(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const ticketCol = cols.find(c => /ticket|case|incident|id/i.test(c)) || cols[0];
        const targetCol = cols.find(c => /sla|target|threshold|limit/i.test(c)) || cols[1];
        const actualCol = cols.find(c => /actual|response|resolution|time/i.test(c)) || cols[2];
        const catCol = cols.find(c => /category|type|priority/i.test(c));
        const body = {ticket_column: ticketCol, sla_target_column: targetCol, actual_column: actualCol};
        if (catCol) body.category_column = catCol;
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/sla-compliance`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (res.error) { _showOverlay(`<h3>SLA Compliance</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>SLA Compliance â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total:</b> ${res.total_tickets} | <b>Met:</b> ${res.met_count} | <b>Breached:</b> ${res.breached_count} | <b>Rate:</b> ${res.compliance_rate}%</p>`;
        if (res.by_category && res.by_category.length) {
          html += `<table class="ov-table"><tr><th>Category</th><th>Total</th><th>Met</th><th>Breached</th><th>Rate</th></tr>`;
          for (const c of res.by_category) html += `<tr><td>${esc(String(c.category))}</td><td>${c.total}</td><td>${c.met}</td><td>${c.breached}</td><td>${c.compliance_rate}%</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadRegionalDistribution(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const regCol = cols.find(c => /region|state|city|country|area|zone|location/i.test(c)) || cols[0];
        const valCol = cols.find(c => /revenue|sales|amount|value/i.test(c)) || cols[1];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/regional-distribution`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({region_column: regCol, value_column: valCol})
        });
        if (res.error) { _showOverlay(`<h3>Regional Distribution</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Regional Distribution â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Total:</b> ${fmt(res.total_value)} | <b>Top Region:</b> ${esc(res.top_region || '-')} | <b>HHI:</b> ${res.hhi_index}</p>`;
        if (res.regions && res.regions.length) {
          html += `<table class="ov-table"><tr><th>Region</th><th>Value</th><th>Share %</th><th>Count</th><th>Rank</th></tr>`;
          for (const r of res.regions) html += `<tr><td>${esc(String(r.region))}</td><td>${fmt(r.total_value)}</td><td>${r.share_pct}%</td><td>${r.count}</td><td>${r.rank}</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    async function loadGeoGrowth(tableName) {
      try {
        const cols = await _getColumns(tableName);
        const regCol = cols.find(c => /region|state|city|country|area|zone|location/i.test(c)) || cols[0];
        const valCol = cols.find(c => /revenue|sales|amount|value/i.test(c)) || cols[1];
        const dateCol = cols.find(c => /date|period|month|year/i.test(c)) || cols[2];
        const res = await apiFetch(`/tables/${encodeURIComponent(tableName)}/geographic-growth`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({region_column: regCol, value_column: valCol, date_column: dateCol})
        });
        if (res.error) { _showOverlay(`<h3>Geo Growth</h3><p>${esc(res.error)}</p>`); return; }
        let html = `<h3>Geographic Growth â€” ${esc(tableName)}</h3>`;
        html += `<p><b>Fastest:</b> ${esc(res.fastest_growing || '-')} | <b>Slowest:</b> ${esc(res.slowest_growing || '-')} | <b>Avg Growth:</b> ${res.avg_growth}%</p>`;
        if (res.regions && res.regions.length) {
          html += `<table class="ov-table"><tr><th>Region</th><th>First Period</th><th>Last Period</th><th>Growth %</th></tr>`;
          for (const r of res.regions) html += `<tr><td>${esc(String(r.region))}</td><td>${fmt(r.first_period_value)}</td><td>${fmt(r.last_period_value)}</td><td>${r.growth_rate}%</td></tr>`;
          html += `</table>`;
        }
        if (res.summary) html += `<p style="margin-top:0.5rem;color:var(--text-secondary)">${esc(res.summary)}</p>`;
        _showOverlay(html);
      } catch(e) { _showOverlay(`<h3>Error</h3><p>${esc(e.message)}</p>`); }
    }

    // -----------------------------------------------------------------------
    // Onboarding Tutorial / Walkthrough
    // -----------------------------------------------------------------------
    const TUTORIAL_STEPS = [
      {
        target: '[data-panel="feed"]',
        title: 'Welcome to Business Brain!',
        text: 'This is your Feed â€” where AI-discovered insights about your data appear automatically. Think of it as your personalized business intelligence dashboard.',
      },
      {
        target: '[data-panel="analyze"]',
        title: 'Ask Questions',
        text: 'The Analyze tab lets you ask natural language questions about your data. Just type "What were our top selling products?" and get instant answers with charts.',
      },
      {
        target: '[data-panel="reports"]',
        title: 'Deploy Reports',
        text: 'Insights you find valuable can be deployed as persistent reports that auto-refresh. Track your key metrics over time.',
      },
      {
        target: '[data-panel="data"]',
        title: 'Upload Your Data',
        text: 'Start by uploading CSV/Excel files here. You can also connect Google Sheets and APIs for live data sync.',
      },
      {
        target: '[data-panel="setup"]',
        title: 'Configure Your Business',
        text: 'Tell the AI about your company, processes, and key metrics. This makes analysis more relevant and accurate. Use Quick Setup for industry templates!',
      },
      {
        target: '#drop-zone',
        title: 'Ready to Start?',
        text: 'Upload your first data file to get started! The AI will automatically discover insights, detect anomalies, and suggest analyses. ðŸš€',
      },
    ];

    let tutorialStep = 0;
    let tutorialActive = false;

    function startTutorial() {
      // Don't show if already seen (unless explicitly clicked)
      tutorialStep = 0;
      tutorialActive = true;
      showTutorialStep();
    }

    function showTutorialStep() {
      if (tutorialStep >= TUTORIAL_STEPS.length) { endTutorial(); return; }

      const step = TUTORIAL_STEPS[tutorialStep];
      const overlay = document.getElementById('tutorial-overlay');
      const spotlight = document.getElementById('tutorial-spotlight');
      const tooltip = document.getElementById('tutorial-tooltip');
      const titleEl = document.getElementById('tutorial-title');
      const textEl = document.getElementById('tutorial-text');
      const progressEl = document.getElementById('tutorial-progress');
      const nextBtn = document.getElementById('tutorial-next-btn');

      overlay.style.display = 'block';
      spotlight.style.display = 'block';
      tooltip.style.display = 'block';

      // Find target element
      const target = document.querySelector(step.target);
      if (target) {
        const rect = target.getBoundingClientRect();
        spotlight.style.left = (rect.left - 4) + 'px';
        spotlight.style.top = (rect.top - 4) + 'px';
        spotlight.style.width = (rect.width + 8) + 'px';
        spotlight.style.height = (rect.height + 8) + 'px';

        // Position tooltip below or to the right of target
        const tooltipTop = rect.bottom + 12;
        const tooltipLeft = Math.min(rect.left, window.innerWidth - 340);
        tooltip.style.top = Math.min(tooltipTop, window.innerHeight - 200) + 'px';
        tooltip.style.left = Math.max(10, tooltipLeft) + 'px';
      }

      titleEl.textContent = step.title;
      textEl.textContent = step.text;
      progressEl.textContent = `${tutorialStep + 1} of ${TUTORIAL_STEPS.length}`;
      nextBtn.textContent = tutorialStep === TUTORIAL_STEPS.length - 1 ? 'Done' : 'Next â†’';
    }

    function nextTutorialStep() {
      tutorialStep++;
      if (tutorialStep >= TUTORIAL_STEPS.length) {
        endTutorial();
      } else {
        showTutorialStep();
      }
    }

    function endTutorial() {
      tutorialActive = false;
      document.getElementById('tutorial-overlay').style.display = 'none';
      document.getElementById('tutorial-spotlight').style.display = 'none';
      document.getElementById('tutorial-tooltip').style.display = 'none';
      localStorage.setItem('bb_tutorial_seen', 'true');
    }

    // Auto-start tutorial for first-time users
    if (!localStorage.getItem('bb_tutorial_seen')) {
      // Delay to let page render first
      setTimeout(() => {
        if (!tutorialActive) startTutorial();
      }, 2000);
    }

  </script>
</body>
</html>
